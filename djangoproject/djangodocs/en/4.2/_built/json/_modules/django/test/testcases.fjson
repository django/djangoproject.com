{"parents": [{"link": "../../../", "title": "Module code"}, {"link": "../../", "title": "django"}], "title": "django.test.testcases", "body": "<h1>Source code for django.test.testcases</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">difflib</span>\n<span class=\"kn\">import</span> <span class=\"nn\">json</span>\n<span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">import</span> <span class=\"nn\">posixpath</span>\n<span class=\"kn\">import</span> <span class=\"nn\">sys</span>\n<span class=\"kn\">import</span> <span class=\"nn\">threading</span>\n<span class=\"kn\">import</span> <span class=\"nn\">unittest</span>\n<span class=\"kn\">import</span> <span class=\"nn\">warnings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">Counter</span>\n<span class=\"kn\">from</span> <span class=\"nn\">contextlib</span> <span class=\"kn\">import</span> <span class=\"n\">contextmanager</span>\n<span class=\"kn\">from</span> <span class=\"nn\">copy</span> <span class=\"kn\">import</span> <span class=\"n\">copy</span><span class=\"p\">,</span> <span class=\"n\">deepcopy</span>\n<span class=\"kn\">from</span> <span class=\"nn\">difflib</span> <span class=\"kn\">import</span> <span class=\"n\">get_close_matches</span>\n<span class=\"kn\">from</span> <span class=\"nn\">functools</span> <span class=\"kn\">import</span> <span class=\"n\">wraps</span>\n<span class=\"kn\">from</span> <span class=\"nn\">unittest.suite</span> <span class=\"kn\">import</span> <span class=\"n\">_DebugResult</span>\n<span class=\"kn\">from</span> <span class=\"nn\">unittest.util</span> <span class=\"kn\">import</span> <span class=\"n\">safe_repr</span>\n<span class=\"kn\">from</span> <span class=\"nn\">urllib.parse</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">parse_qsl</span><span class=\"p\">,</span>\n    <span class=\"n\">unquote</span><span class=\"p\">,</span>\n    <span class=\"n\">urlencode</span><span class=\"p\">,</span>\n    <span class=\"n\">urljoin</span><span class=\"p\">,</span>\n    <span class=\"n\">urlparse</span><span class=\"p\">,</span>\n    <span class=\"n\">urlsplit</span><span class=\"p\">,</span>\n    <span class=\"n\">urlunparse</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">urllib.request</span> <span class=\"kn\">import</span> <span class=\"n\">url2pathname</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">asgiref.sync</span> <span class=\"kn\">import</span> <span class=\"n\">async_to_sync</span><span class=\"p\">,</span> <span class=\"n\">iscoroutinefunction</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.apps</span> <span class=\"kn\">import</span> <span class=\"n\">apps</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.conf</span> <span class=\"kn\">import</span> <span class=\"n\">settings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core</span> <span class=\"kn\">import</span> <span class=\"n\">mail</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.exceptions</span> <span class=\"kn\">import</span> <span class=\"n\">ImproperlyConfigured</span><span class=\"p\">,</span> <span class=\"n\">ValidationError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.files</span> <span class=\"kn\">import</span> <span class=\"n\">locks</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.handlers.wsgi</span> <span class=\"kn\">import</span> <span class=\"n\">WSGIHandler</span><span class=\"p\">,</span> <span class=\"n\">get_path_info</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.management</span> <span class=\"kn\">import</span> <span class=\"n\">call_command</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.management.color</span> <span class=\"kn\">import</span> <span class=\"n\">no_style</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.management.sql</span> <span class=\"kn\">import</span> <span class=\"n\">emit_post_migrate_signal</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.servers.basehttp</span> <span class=\"kn\">import</span> <span class=\"n\">ThreadedWSGIServer</span><span class=\"p\">,</span> <span class=\"n\">WSGIRequestHandler</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.signals</span> <span class=\"kn\">import</span> <span class=\"n\">setting_changed</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db</span> <span class=\"kn\">import</span> <span class=\"n\">DEFAULT_DB_ALIAS</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">connections</span><span class=\"p\">,</span> <span class=\"n\">transaction</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.forms.fields</span> <span class=\"kn\">import</span> <span class=\"n\">CharField</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.http</span> <span class=\"kn\">import</span> <span class=\"n\">QueryDict</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.http.request</span> <span class=\"kn\">import</span> <span class=\"n\">split_domain_port</span><span class=\"p\">,</span> <span class=\"n\">validate_host</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.test.client</span> <span class=\"kn\">import</span> <span class=\"n\">AsyncClient</span><span class=\"p\">,</span> <span class=\"n\">Client</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.test.html</span> <span class=\"kn\">import</span> <span class=\"n\">HTMLParseError</span><span class=\"p\">,</span> <span class=\"n\">parse_html</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.test.signals</span> <span class=\"kn\">import</span> <span class=\"n\">template_rendered</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.test.utils</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">CaptureQueriesContext</span><span class=\"p\">,</span>\n    <span class=\"n\">ContextList</span><span class=\"p\">,</span>\n    <span class=\"n\">compare_xml</span><span class=\"p\">,</span>\n    <span class=\"n\">modify_settings</span><span class=\"p\">,</span>\n    <span class=\"n\">override_settings</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.deprecation</span> <span class=\"kn\">import</span> <span class=\"n\">RemovedInDjango51Warning</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.functional</span> <span class=\"kn\">import</span> <span class=\"n\">classproperty</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.views.static</span> <span class=\"kn\">import</span> <span class=\"n\">serve</span>\n\n<span class=\"n\">logger</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">getLogger</span><span class=\"p\">(</span><span class=\"s2\">&quot;django.test&quot;</span><span class=\"p\">)</span>\n\n<span class=\"n\">__all__</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n    <span class=\"s2\">&quot;TestCase&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;TransactionTestCase&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;SimpleTestCase&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;skipIfDBFeature&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;skipUnlessDBFeature&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">to_list</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Put value into a list if it&#39;s not already one.&quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">):</span>\n        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">value</span><span class=\"p\">]</span>\n    <span class=\"k\">return</span> <span class=\"n\">value</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">assert_and_parse_html</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">html</span><span class=\"p\">,</span> <span class=\"n\">user_msg</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">):</span>\n    <span class=\"k\">try</span><span class=\"p\">:</span>\n        <span class=\"n\">dom</span> <span class=\"o\">=</span> <span class=\"n\">parse_html</span><span class=\"p\">(</span><span class=\"n\">html</span><span class=\"p\">)</span>\n    <span class=\"k\">except</span> <span class=\"n\">HTMLParseError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n        <span class=\"n\">standardMsg</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"se\">\\n</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"n\">e</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_formatMessage</span><span class=\"p\">(</span><span class=\"n\">user_msg</span><span class=\"p\">,</span> <span class=\"n\">standardMsg</span><span class=\"p\">))</span>\n    <span class=\"k\">return</span> <span class=\"n\">dom</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">_AssertNumQueriesContext</span><span class=\"p\">(</span><span class=\"n\">CaptureQueriesContext</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">test_case</span><span class=\"p\">,</span> <span class=\"n\">num</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">test_case</span> <span class=\"o\">=</span> <span class=\"n\">test_case</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">num</span> <span class=\"o\">=</span> <span class=\"n\">num</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__exit__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">exc_type</span><span class=\"p\">,</span> <span class=\"n\">exc_value</span><span class=\"p\">,</span> <span class=\"n\">traceback</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__exit__</span><span class=\"p\">(</span><span class=\"n\">exc_type</span><span class=\"p\">,</span> <span class=\"n\">exc_value</span><span class=\"p\">,</span> <span class=\"n\">traceback</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">exc_type</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span>\n        <span class=\"n\">executed</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">test_case</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n            <span class=\"n\">executed</span><span class=\"p\">,</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">num</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;</span><span class=\"si\">%d</span><span class=\"s2\"> queries executed, </span><span class=\"si\">%d</span><span class=\"s2\"> expected</span><span class=\"se\">\\n</span><span class=\"s2\">Captured queries were:</span><span class=\"se\">\\n</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n            <span class=\"o\">%</span> <span class=\"p\">(</span>\n                <span class=\"n\">executed</span><span class=\"p\">,</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">num</span><span class=\"p\">,</span>\n                <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;</span><span class=\"si\">%d</span><span class=\"s2\">. </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">[</span><span class=\"s2\">&quot;sql&quot;</span><span class=\"p\">])</span>\n                    <span class=\"k\">for</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">query</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">captured_queries</span><span class=\"p\">,</span> <span class=\"n\">start</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n                <span class=\"p\">),</span>\n            <span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">_AssertTemplateUsedContext</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">test_case</span><span class=\"p\">,</span> <span class=\"n\">template_name</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">test_case</span> <span class=\"o\">=</span> <span class=\"n\">test_case</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">template_name</span> <span class=\"o\">=</span> <span class=\"n\">template_name</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">msg_prefix</span> <span class=\"o\">=</span> <span class=\"n\">msg_prefix</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">count</span> <span class=\"o\">=</span> <span class=\"n\">count</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">rendered_templates</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">rendered_template_names</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"n\">ContextList</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">on_template_render</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">sender</span><span class=\"p\">,</span> <span class=\"n\">signal</span><span class=\"p\">,</span> <span class=\"n\">template</span><span class=\"p\">,</span> <span class=\"n\">context</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">rendered_templates</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">template</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">rendered_template_names</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">template</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">context</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">test</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">test_case</span><span class=\"o\">.</span><span class=\"n\">_assert_template_used</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">template_name</span><span class=\"p\">,</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">rendered_template_names</span><span class=\"p\">,</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">msg_prefix</span><span class=\"p\">,</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__enter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">template_rendered</span><span class=\"o\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">on_template_render</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__exit__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">exc_type</span><span class=\"p\">,</span> <span class=\"n\">exc_value</span><span class=\"p\">,</span> <span class=\"n\">traceback</span><span class=\"p\">):</span>\n        <span class=\"n\">template_rendered</span><span class=\"o\">.</span><span class=\"n\">disconnect</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">on_template_render</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">exc_type</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">test</span><span class=\"p\">()</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">_AssertTemplateNotUsedContext</span><span class=\"p\">(</span><span class=\"n\">_AssertTemplateUsedContext</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">test</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">test_case</span><span class=\"o\">.</span><span class=\"n\">assertFalse</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">template_name</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">rendered_template_names</span><span class=\"p\">,</span>\n            <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">msg_prefix</span><span class=\"si\">}</span><span class=\"s2\">Template &#39;</span><span class=\"si\">{</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">template_name</span><span class=\"si\">}</span><span class=\"s2\">&#39; was used &quot;</span>\n            <span class=\"sa\">f</span><span class=\"s2\">&quot;unexpectedly in rendering the response&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DatabaseOperationForbidden</span><span class=\"p\">(</span><span class=\"ne\">AssertionError</span><span class=\"p\">):</span>\n    <span class=\"k\">pass</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">_DatabaseFailure</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">wrapped</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">wrapped</span> <span class=\"o\">=</span> <span class=\"n\">wrapped</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"n\">message</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">raise</span> <span class=\"n\">DatabaseOperationForbidden</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">message</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">SimpleTestCase</span><span class=\"p\">(</span><span class=\"n\">unittest</span><span class=\"o\">.</span><span class=\"n\">TestCase</span><span class=\"p\">):</span>\n    <span class=\"c1\"># The class we&#39;ll use for the test client self.client.</span>\n    <span class=\"c1\"># Can be overridden in derived classes.</span>\n    <span class=\"n\">client_class</span> <span class=\"o\">=</span> <span class=\"n\">Client</span>\n    <span class=\"n\">async_client_class</span> <span class=\"o\">=</span> <span class=\"n\">AsyncClient</span>\n    <span class=\"n\">_overridden_settings</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">_modified_settings</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"n\">databases</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>\n    <span class=\"n\">_disallowed_database_msg</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;Database </span><span class=\"si\">%(operation)s</span><span class=\"s2\"> to </span><span class=\"si\">%(alias)r</span><span class=\"s2\"> are not allowed in SimpleTestCase &quot;</span>\n        <span class=\"s2\">&quot;subclasses. Either subclass TestCase or TransactionTestCase to ensure &quot;</span>\n        <span class=\"s2\">&quot;proper test isolation or add </span><span class=\"si\">%(alias)r</span><span class=\"s2\"> to </span><span class=\"si\">%(test)s</span><span class=\"s2\">.databases to silence &quot;</span>\n        <span class=\"s2\">&quot;this failure.&quot;</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">_disallowed_connection_methods</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n        <span class=\"p\">(</span><span class=\"s2\">&quot;connect&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;connections&quot;</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"s2\">&quot;temporary_connection&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;connections&quot;</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"s2\">&quot;cursor&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;queries&quot;</span><span class=\"p\">),</span>\n        <span class=\"p\">(</span><span class=\"s2\">&quot;chunked_cursor&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;queries&quot;</span><span class=\"p\">),</span>\n    <span class=\"p\">]</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">setUpClass</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">setUpClass</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_overridden_settings</span><span class=\"p\">:</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_cls_overridden_context</span> <span class=\"o\">=</span> <span class=\"n\">override_settings</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_overridden_settings</span><span class=\"p\">)</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_cls_overridden_context</span><span class=\"o\">.</span><span class=\"n\">enable</span><span class=\"p\">()</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">addClassCleanup</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_cls_overridden_context</span><span class=\"o\">.</span><span class=\"n\">disable</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_modified_settings</span><span class=\"p\">:</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_cls_modified_context</span> <span class=\"o\">=</span> <span class=\"n\">modify_settings</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_modified_settings</span><span class=\"p\">)</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_cls_modified_context</span><span class=\"o\">.</span><span class=\"n\">enable</span><span class=\"p\">()</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">addClassCleanup</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_cls_modified_context</span><span class=\"o\">.</span><span class=\"n\">disable</span><span class=\"p\">)</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_add_databases_failures</span><span class=\"p\">()</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">addClassCleanup</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_remove_databases_failures</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_validate_databases</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">databases</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;__all__&quot;</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"nb\">frozenset</span><span class=\"p\">(</span><span class=\"n\">connections</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">databases</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">alias</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">connections</span><span class=\"p\">:</span>\n                <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">.</span><span class=\"si\">%s</span><span class=\"s2\">.databases refers to </span><span class=\"si\">%r</span><span class=\"s2\"> which is not defined in &quot;</span>\n                    <span class=\"s2\">&quot;settings.DATABASES.&quot;</span>\n                    <span class=\"o\">%</span> <span class=\"p\">(</span>\n                        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__module__</span><span class=\"p\">,</span>\n                        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__qualname__</span><span class=\"p\">,</span>\n                        <span class=\"n\">alias</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">close_matches</span> <span class=\"o\">=</span> <span class=\"n\">get_close_matches</span><span class=\"p\">(</span><span class=\"n\">alias</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">connections</span><span class=\"p\">))</span>\n                <span class=\"k\">if</span> <span class=\"n\">close_matches</span><span class=\"p\">:</span>\n                    <span class=\"n\">message</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot; Did you mean </span><span class=\"si\">%r</span><span class=\"s2\">?&quot;</span> <span class=\"o\">%</span> <span class=\"n\">close_matches</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n                <span class=\"k\">raise</span> <span class=\"n\">ImproperlyConfigured</span><span class=\"p\">(</span><span class=\"n\">message</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">frozenset</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">databases</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_add_databases_failures</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">databases</span> <span class=\"o\">=</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_validate_databases</span><span class=\"p\">()</span>\n        <span class=\"k\">for</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"n\">connections</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">databases</span><span class=\"p\">:</span>\n                <span class=\"k\">continue</span>\n            <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">alias</span><span class=\"p\">]</span>\n            <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">operation</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_disallowed_connection_methods</span><span class=\"p\">:</span>\n                <span class=\"n\">message</span> <span class=\"o\">=</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_disallowed_database_msg</span> <span class=\"o\">%</span> <span class=\"p\">{</span>\n                    <span class=\"s2\">&quot;test&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">.</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__module__</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__qualname__</span><span class=\"p\">),</span>\n                    <span class=\"s2\">&quot;alias&quot;</span><span class=\"p\">:</span> <span class=\"n\">alias</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;operation&quot;</span><span class=\"p\">:</span> <span class=\"n\">operation</span><span class=\"p\">,</span>\n                <span class=\"p\">}</span>\n                <span class=\"n\">method</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">_DatabaseFailure</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"p\">,</span> <span class=\"n\">message</span><span class=\"p\">))</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_remove_databases_failures</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">for</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"n\">connections</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">databases</span><span class=\"p\">:</span>\n                <span class=\"k\">continue</span>\n            <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">alias</span><span class=\"p\">]</span>\n            <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">_</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_disallowed_connection_methods</span><span class=\"p\">:</span>\n                <span class=\"n\">method</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">method</span><span class=\"o\">.</span><span class=\"n\">wrapped</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">result</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Wrapper around default __call__ method to perform common Django test</span>\n<span class=\"sd\">        set up. This means that user-defined Test Cases aren&#39;t required to</span>\n<span class=\"sd\">        include a call to super().setUp().</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_setup_and_call</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">debug</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Perform the same as __call__(), without catching the exception.&quot;&quot;&quot;</span>\n        <span class=\"n\">debug_result</span> <span class=\"o\">=</span> <span class=\"n\">_DebugResult</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_setup_and_call</span><span class=\"p\">(</span><span class=\"n\">debug_result</span><span class=\"p\">,</span> <span class=\"n\">debug</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_setup_and_call</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">result</span><span class=\"p\">,</span> <span class=\"n\">debug</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Perform the following in order: pre-setup, run test, post-teardown,</span>\n<span class=\"sd\">        skipping pre/post hooks if test is set to be skipped.</span>\n\n<span class=\"sd\">        If debug=True, reraise any errors in setup and use super().debug()</span>\n<span class=\"sd\">        instead of __call__() to run the test.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">testMethod</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_testMethodName</span><span class=\"p\">)</span>\n        <span class=\"n\">skipped</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span> <span class=\"s2\">&quot;__unittest_skip__&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span>\n            <span class=\"n\">testMethod</span><span class=\"p\">,</span> <span class=\"s2\">&quot;__unittest_skip__&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"c1\"># Convert async test methods.</span>\n        <span class=\"k\">if</span> <span class=\"n\">iscoroutinefunction</span><span class=\"p\">(</span><span class=\"n\">testMethod</span><span class=\"p\">):</span>\n            <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_testMethodName</span><span class=\"p\">,</span> <span class=\"n\">async_to_sync</span><span class=\"p\">(</span><span class=\"n\">testMethod</span><span class=\"p\">))</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">skipped</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_pre_setup</span><span class=\"p\">()</span>\n            <span class=\"k\">except</span> <span class=\"ne\">Exception</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"n\">debug</span><span class=\"p\">:</span>\n                    <span class=\"k\">raise</span>\n                <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">addError</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">exc_info</span><span class=\"p\">())</span>\n                <span class=\"k\">return</span>\n        <span class=\"k\">if</span> <span class=\"n\">debug</span><span class=\"p\">:</span>\n            <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">debug</span><span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">skipped</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_post_teardown</span><span class=\"p\">()</span>\n            <span class=\"k\">except</span> <span class=\"ne\">Exception</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"n\">debug</span><span class=\"p\">:</span>\n                    <span class=\"k\">raise</span>\n                <span class=\"n\">result</span><span class=\"o\">.</span><span class=\"n\">addError</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">exc_info</span><span class=\"p\">())</span>\n                <span class=\"k\">return</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_pre_setup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Perform pre-test setup:</span>\n<span class=\"sd\">        * Create a test client.</span>\n<span class=\"sd\">        * Clear the mail test outbox.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">client_class</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">async_client</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">async_client_class</span><span class=\"p\">()</span>\n        <span class=\"n\">mail</span><span class=\"o\">.</span><span class=\"n\">outbox</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_post_teardown</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Perform post-test things.&quot;&quot;&quot;</span>\n        <span class=\"k\">pass</span>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.settings\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.settings\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">settings</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        A context manager that temporarily sets a setting and reverts to the</span>\n<span class=\"sd\">        original value when exiting the context.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">override_settings</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.modify_settings\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.modify_settings\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">modify_settings</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        A context manager that temporarily applies changes a list setting and</span>\n<span class=\"sd\">        reverts back to the original value when exiting the context.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">modify_settings</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertRedirects\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertRedirects\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertRedirects</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">response</span><span class=\"p\">,</span>\n        <span class=\"n\">expected_url</span><span class=\"p\">,</span>\n        <span class=\"n\">status_code</span><span class=\"o\">=</span><span class=\"mi\">302</span><span class=\"p\">,</span>\n        <span class=\"n\">target_status_code</span><span class=\"o\">=</span><span class=\"mi\">200</span><span class=\"p\">,</span>\n        <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n        <span class=\"n\">fetch_redirect_response</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that a response redirected to a specific URL and that the</span>\n<span class=\"sd\">        redirect URL can be loaded.</span>\n\n<span class=\"sd\">        Won&#39;t work for external links since it uses the test client to do a</span>\n<span class=\"sd\">        request (use fetch_redirect_response=False to check such links without</span>\n<span class=\"sd\">        fetching them).</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">msg_prefix</span><span class=\"p\">:</span>\n            <span class=\"n\">msg_prefix</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot;: &quot;</span>\n\n        <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"s2\">&quot;redirect_chain&quot;</span><span class=\"p\">):</span>\n            <span class=\"c1\"># The request was a followed redirect</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertTrue</span><span class=\"p\">(</span>\n                <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">redirect_chain</span><span class=\"p\">,</span>\n                <span class=\"n\">msg_prefix</span>\n                <span class=\"o\">+</span> <span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Response didn&#39;t redirect as expected: Response code was </span><span class=\"si\">%d</span><span class=\"s2\"> &quot;</span>\n                    <span class=\"s2\">&quot;(expected </span><span class=\"si\">%d</span><span class=\"s2\">)&quot;</span>\n                <span class=\"p\">)</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">status_code</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n                <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">redirect_chain</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">1</span><span class=\"p\">],</span>\n                <span class=\"n\">status_code</span><span class=\"p\">,</span>\n                <span class=\"n\">msg_prefix</span>\n                <span class=\"o\">+</span> <span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Initial response didn&#39;t redirect as expected: Response code was &quot;</span>\n                    <span class=\"s2\">&quot;</span><span class=\"si\">%d</span><span class=\"s2\"> (expected </span><span class=\"si\">%d</span><span class=\"s2\">)&quot;</span>\n                <span class=\"p\">)</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">redirect_chain</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">][</span><span class=\"mi\">1</span><span class=\"p\">],</span> <span class=\"n\">status_code</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">status_code</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">redirect_chain</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n                <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span>\n                <span class=\"n\">target_status_code</span><span class=\"p\">,</span>\n                <span class=\"n\">msg_prefix</span>\n                <span class=\"o\">+</span> <span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Response didn&#39;t redirect as expected: Final Response code was </span><span class=\"si\">%d</span><span class=\"s2\"> &quot;</span>\n                    <span class=\"s2\">&quot;(expected </span><span class=\"si\">%d</span><span class=\"s2\">)&quot;</span>\n                <span class=\"p\">)</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">target_status_code</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Not a followed redirect</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n                <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span>\n                <span class=\"n\">status_code</span><span class=\"p\">,</span>\n                <span class=\"n\">msg_prefix</span>\n                <span class=\"o\">+</span> <span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Response didn&#39;t redirect as expected: Response code was </span><span class=\"si\">%d</span><span class=\"s2\"> &quot;</span>\n                    <span class=\"s2\">&quot;(expected </span><span class=\"si\">%d</span><span class=\"s2\">)&quot;</span>\n                <span class=\"p\">)</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">status_code</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">url</span>\n            <span class=\"n\">scheme</span><span class=\"p\">,</span> <span class=\"n\">netloc</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">fragment</span> <span class=\"o\">=</span> <span class=\"n\">urlsplit</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">)</span>\n\n            <span class=\"c1\"># Prepend the request path to handle relative path redirects.</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">startswith</span><span class=\"p\">(</span><span class=\"s2\">&quot;/&quot;</span><span class=\"p\">):</span>\n                <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"n\">urljoin</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"p\">[</span><span class=\"s2\">&quot;PATH_INFO&quot;</span><span class=\"p\">],</span> <span class=\"n\">url</span><span class=\"p\">)</span>\n                <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">urljoin</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">request</span><span class=\"p\">[</span><span class=\"s2\">&quot;PATH_INFO&quot;</span><span class=\"p\">],</span> <span class=\"n\">path</span><span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">fetch_redirect_response</span><span class=\"p\">:</span>\n                <span class=\"c1\"># netloc might be empty, or in cases where Django tests the</span>\n                <span class=\"c1\"># HTTP scheme, the convention is for netloc to be &#39;testserver&#39;.</span>\n                <span class=\"c1\"># Trust both as &quot;internal&quot; URLs here.</span>\n                <span class=\"n\">domain</span><span class=\"p\">,</span> <span class=\"n\">port</span> <span class=\"o\">=</span> <span class=\"n\">split_domain_port</span><span class=\"p\">(</span><span class=\"n\">netloc</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">domain</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">validate_host</span><span class=\"p\">(</span><span class=\"n\">domain</span><span class=\"p\">,</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">ALLOWED_HOSTS</span><span class=\"p\">):</span>\n                    <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;The test client is unable to fetch remote URLs (got </span><span class=\"si\">%s</span><span class=\"s2\">). &quot;</span>\n                        <span class=\"s2\">&quot;If the host is served by Django, add &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; to ALLOWED_HOSTS. &quot;</span>\n                        <span class=\"s2\">&quot;Otherwise, use &quot;</span>\n                        <span class=\"s2\">&quot;assertRedirects(..., fetch_redirect_response=False).&quot;</span>\n                        <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">domain</span><span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n                <span class=\"c1\"># Get the redirection page, using the same client that was used</span>\n                <span class=\"c1\"># to obtain the original response.</span>\n                <span class=\"n\">extra</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">extra</span> <span class=\"ow\">or</span> <span class=\"p\">{}</span>\n                <span class=\"n\">headers</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">headers</span> <span class=\"ow\">or</span> <span class=\"p\">{}</span>\n                <span class=\"n\">redirect_response</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">client</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n                    <span class=\"n\">path</span><span class=\"p\">,</span>\n                    <span class=\"n\">QueryDict</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">),</span>\n                    <span class=\"n\">secure</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">scheme</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;https&quot;</span><span class=\"p\">),</span>\n                    <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"n\">headers</span><span class=\"p\">,</span>\n                    <span class=\"o\">**</span><span class=\"n\">extra</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n                    <span class=\"n\">redirect_response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span>\n                    <span class=\"n\">target_status_code</span><span class=\"p\">,</span>\n                    <span class=\"n\">msg_prefix</span>\n                    <span class=\"o\">+</span> <span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;Couldn&#39;t retrieve redirection page &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;: response code was </span><span class=\"si\">%d</span><span class=\"s2\"> &quot;</span>\n                        <span class=\"s2\">&quot;(expected </span><span class=\"si\">%d</span><span class=\"s2\">)&quot;</span>\n                    <span class=\"p\">)</span>\n                    <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">redirect_response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">target_status_code</span><span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertURLEqual</span><span class=\"p\">(</span>\n            <span class=\"n\">url</span><span class=\"p\">,</span>\n            <span class=\"n\">expected_url</span><span class=\"p\">,</span>\n            <span class=\"n\">msg_prefix</span>\n            <span class=\"o\">+</span> <span class=\"s2\">&quot;Response redirected to &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;, expected &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">expected_url</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertURLEqual\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertURLEqual\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertURLEqual</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">url1</span><span class=\"p\">,</span> <span class=\"n\">url2</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that two URLs are the same, ignoring the order of query string</span>\n<span class=\"sd\">        parameters except for parameters with the same name.</span>\n\n<span class=\"sd\">        For example, /path/?x=1&amp;y=2 is equal to /path/?y=2&amp;x=1, but</span>\n<span class=\"sd\">        /path/?a=1&amp;a=2 isn&#39;t equal to /path/?a=2&amp;a=1.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">normalize</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">):</span>\n            <span class=\"sd\">&quot;&quot;&quot;Sort the URL&#39;s query string parameters.&quot;&quot;&quot;</span>\n            <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">)</span>  <span class=\"c1\"># Coerce reverse_lazy() URLs.</span>\n            <span class=\"n\">scheme</span><span class=\"p\">,</span> <span class=\"n\">netloc</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">fragment</span> <span class=\"o\">=</span> <span class=\"n\">urlparse</span><span class=\"p\">(</span><span class=\"n\">url</span><span class=\"p\">)</span>\n            <span class=\"n\">query_parts</span> <span class=\"o\">=</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"n\">parse_qsl</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">))</span>\n            <span class=\"k\">return</span> <span class=\"n\">urlunparse</span><span class=\"p\">(</span>\n                <span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">,</span> <span class=\"n\">netloc</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">urlencode</span><span class=\"p\">(</span><span class=\"n\">query_parts</span><span class=\"p\">),</span> <span class=\"n\">fragment</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n            <span class=\"n\">normalize</span><span class=\"p\">(</span><span class=\"n\">url1</span><span class=\"p\">),</span>\n            <span class=\"n\">normalize</span><span class=\"p\">(</span><span class=\"n\">url2</span><span class=\"p\">),</span>\n            <span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;Expected &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; to equal &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;.&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">url1</span><span class=\"p\">,</span> <span class=\"n\">url2</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_assert_contains</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"n\">html</span><span class=\"p\">):</span>\n        <span class=\"c1\"># If the response supports deferred rendering and hasn&#39;t been rendered</span>\n        <span class=\"c1\"># yet, then ensure that it does get rendered before proceeding further.</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"s2\">&quot;render&quot;</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"n\">callable</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">render</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">is_rendered</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">render</span><span class=\"p\">()</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">msg_prefix</span><span class=\"p\">:</span>\n            <span class=\"n\">msg_prefix</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot;: &quot;</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n            <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span>\n            <span class=\"n\">status_code</span><span class=\"p\">,</span>\n            <span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;Couldn&#39;t retrieve content: Response code was </span><span class=\"si\">%d</span><span class=\"s2\">&quot;</span>\n            <span class=\"s2\">&quot; (expected </span><span class=\"si\">%d</span><span class=\"s2\">)&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">status_code</span><span class=\"p\">),</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">streaming</span><span class=\"p\">:</span>\n            <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"sa\">b</span><span class=\"s2\">&quot;&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">streaming_content</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">content</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"nb\">bytes</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"n\">html</span><span class=\"p\">:</span>\n            <span class=\"n\">text</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">)</span>\n            <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">content</span><span class=\"o\">.</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">charset</span><span class=\"p\">)</span>\n            <span class=\"n\">text_repr</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;&quot;</span> <span class=\"o\">%</span> <span class=\"n\">text</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">text_repr</span> <span class=\"o\">=</span> <span class=\"nb\">repr</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">html</span><span class=\"p\">:</span>\n            <span class=\"n\">content</span> <span class=\"o\">=</span> <span class=\"n\">assert_and_parse_html</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">content</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Response&#39;s content is not valid HTML:&quot;</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">text</span> <span class=\"o\">=</span> <span class=\"n\">assert_and_parse_html</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Second argument is not valid HTML:&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"n\">real_count</span> <span class=\"o\">=</span> <span class=\"n\">content</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span><span class=\"n\">text_repr</span><span class=\"p\">,</span> <span class=\"n\">real_count</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertContains\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertContains\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertContains</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">status_code</span><span class=\"o\">=</span><span class=\"mi\">200</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"n\">html</span><span class=\"o\">=</span><span class=\"kc\">False</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that a response indicates that some content was retrieved</span>\n<span class=\"sd\">        successfully, (i.e., the HTTP status code was as expected) and that</span>\n<span class=\"sd\">        ``text`` occurs ``count`` times in the content of the response.</span>\n<span class=\"sd\">        If ``count`` is None, the count doesn&#39;t matter - the assertion is true</span>\n<span class=\"sd\">        if the text occurs at least once in the response.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">text_repr</span><span class=\"p\">,</span> <span class=\"n\">real_count</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_assert_contains</span><span class=\"p\">(</span>\n            <span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"n\">html</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">count</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n                <span class=\"n\">real_count</span><span class=\"p\">,</span>\n                <span class=\"n\">count</span><span class=\"p\">,</span>\n                <span class=\"n\">msg_prefix</span>\n                <span class=\"o\">+</span> <span class=\"s2\">&quot;Found </span><span class=\"si\">%d</span><span class=\"s2\"> instances of </span><span class=\"si\">%s</span><span class=\"s2\"> in response (expected </span><span class=\"si\">%d</span><span class=\"s2\">)&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">real_count</span><span class=\"p\">,</span> <span class=\"n\">text_repr</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertTrue</span><span class=\"p\">(</span>\n                <span class=\"n\">real_count</span> <span class=\"o\">!=</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;Couldn&#39;t find </span><span class=\"si\">%s</span><span class=\"s2\"> in response&quot;</span> <span class=\"o\">%</span> <span class=\"n\">text_repr</span>\n            <span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertNotContains\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertNotContains\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertNotContains</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">status_code</span><span class=\"o\">=</span><span class=\"mi\">200</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"n\">html</span><span class=\"o\">=</span><span class=\"kc\">False</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that a response indicates that some content was retrieved</span>\n<span class=\"sd\">        successfully, (i.e., the HTTP status code was as expected) and that</span>\n<span class=\"sd\">        ``text`` doesn&#39;t occur in the content of the response.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">text_repr</span><span class=\"p\">,</span> <span class=\"n\">real_count</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_assert_contains</span><span class=\"p\">(</span>\n            <span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">status_code</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"n\">html</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n            <span class=\"n\">real_count</span><span class=\"p\">,</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;Response should not contain </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">text_repr</span>\n        <span class=\"p\">)</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_check_test_client_response</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">attribute</span><span class=\"p\">,</span> <span class=\"n\">method_name</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Raise a ValueError if the given response doesn&#39;t have the required</span>\n<span class=\"sd\">        attribute.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">attribute</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">method_name</span><span class=\"si\">}</span><span class=\"s2\">() is only usable on responses fetched using &quot;</span>\n                <span class=\"s2\">&quot;the Django test Client.&quot;</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_assert_form_error</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"n\">form_repr</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">is_bound</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">msg_prefix</span><span class=\"si\">}</span><span class=\"s2\">The </span><span class=\"si\">{</span><span class=\"n\">form_repr</span><span class=\"si\">}</span><span class=\"s2\"> is not bound, it will never have any &quot;</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;errors.&quot;</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">field</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">msg_prefix</span><span class=\"si\">}</span><span class=\"s2\">The </span><span class=\"si\">{</span><span class=\"n\">form_repr</span><span class=\"si\">}</span><span class=\"s2\"> does not contain the field </span><span class=\"si\">{</span><span class=\"n\">field</span><span class=\"si\">!r}</span><span class=\"s2\">.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">field_errors</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">non_field_errors</span><span class=\"p\">()</span>\n            <span class=\"n\">failure_message</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;The non-field errors of </span><span class=\"si\">{</span><span class=\"n\">form_repr</span><span class=\"si\">}</span><span class=\"s2\"> don&#39;t match.&quot;</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">field_errors</span> <span class=\"o\">=</span> <span class=\"n\">form</span><span class=\"o\">.</span><span class=\"n\">errors</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n            <span class=\"n\">failure_message</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;The errors of field </span><span class=\"si\">{</span><span class=\"n\">field</span><span class=\"si\">!r}</span><span class=\"s2\"> on </span><span class=\"si\">{</span><span class=\"n\">form_repr</span><span class=\"si\">}</span><span class=\"s2\"> don&#39;t match.&quot;</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span><span class=\"n\">field_errors</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"n\">failure_message</span><span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertFormError\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertFormError\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertFormError</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that a field named &quot;field&quot; on the given form object has specific</span>\n<span class=\"sd\">        errors.</span>\n\n<span class=\"sd\">        errors can be either a single error message or a list of errors</span>\n<span class=\"sd\">        messages. Using errors=[] test that the field has no errors.</span>\n\n<span class=\"sd\">        You can pass field=None to check the form&#39;s non-field errors.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">msg_prefix</span><span class=\"p\">:</span>\n            <span class=\"n\">msg_prefix</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot;: &quot;</span>\n        <span class=\"n\">errors</span> <span class=\"o\">=</span> <span class=\"n\">to_list</span><span class=\"p\">(</span><span class=\"n\">errors</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_assert_form_error</span><span class=\"p\">(</span><span class=\"n\">form</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;form </span><span class=\"si\">{</span><span class=\"n\">form</span><span class=\"si\">!r}</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span></div>\n\n    <span class=\"c1\"># RemovedInDjango51Warning.</span>\n    <span class=\"k\">def</span> <span class=\"nf\">assertFormsetError</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kw</span><span class=\"p\">):</span>\n        <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;assertFormsetError() is deprecated in favor of assertFormSetError().&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">category</span><span class=\"o\">=</span><span class=\"n\">RemovedInDjango51Warning</span><span class=\"p\">,</span>\n            <span class=\"n\">stacklevel</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertFormSetError</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kw</span><span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertFormSetError\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertFormSetError\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertFormSetError</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">formset</span><span class=\"p\">,</span> <span class=\"n\">form_index</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Similar to assertFormError() but for formsets.</span>\n\n<span class=\"sd\">        Use form_index=None to check the formset&#39;s non-form errors (in that</span>\n<span class=\"sd\">        case, you must also use field=None).</span>\n<span class=\"sd\">        Otherwise use an integer to check the formset&#39;s n-th form for errors.</span>\n\n<span class=\"sd\">        Other parameters are the same as assertFormError().</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">form_index</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">field</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;You must use field=None with form_index=None.&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">msg_prefix</span><span class=\"p\">:</span>\n            <span class=\"n\">msg_prefix</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot;: &quot;</span>\n        <span class=\"n\">errors</span> <span class=\"o\">=</span> <span class=\"n\">to_list</span><span class=\"p\">(</span><span class=\"n\">errors</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">formset</span><span class=\"o\">.</span><span class=\"n\">is_bound</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">msg_prefix</span><span class=\"si\">}</span><span class=\"s2\">The formset </span><span class=\"si\">{</span><span class=\"n\">formset</span><span class=\"si\">!r}</span><span class=\"s2\"> is not bound, it will never have &quot;</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;any errors.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">form_index</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">form_index</span> <span class=\"o\">&gt;=</span> <span class=\"n\">formset</span><span class=\"o\">.</span><span class=\"n\">total_form_count</span><span class=\"p\">():</span>\n            <span class=\"n\">form_count</span> <span class=\"o\">=</span> <span class=\"n\">formset</span><span class=\"o\">.</span><span class=\"n\">total_form_count</span><span class=\"p\">()</span>\n            <span class=\"n\">form_or_forms</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;forms&quot;</span> <span class=\"k\">if</span> <span class=\"n\">form_count</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;form&quot;</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">msg_prefix</span><span class=\"si\">}</span><span class=\"s2\">The formset </span><span class=\"si\">{</span><span class=\"n\">formset</span><span class=\"si\">!r}</span><span class=\"s2\"> only has </span><span class=\"si\">{</span><span class=\"n\">form_count</span><span class=\"si\">}</span><span class=\"s2\"> &quot;</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;</span><span class=\"si\">{</span><span class=\"n\">form_or_forms</span><span class=\"si\">}</span><span class=\"s2\">.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">form_index</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">form_repr</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;form </span><span class=\"si\">{</span><span class=\"n\">form_index</span><span class=\"si\">}</span><span class=\"s2\"> of formset </span><span class=\"si\">{</span><span class=\"n\">formset</span><span class=\"si\">!r}</span><span class=\"s2\">&quot;</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_assert_form_error</span><span class=\"p\">(</span>\n                <span class=\"n\">formset</span><span class=\"o\">.</span><span class=\"n\">forms</span><span class=\"p\">[</span><span class=\"n\">form_index</span><span class=\"p\">],</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"n\">form_repr</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">failure_message</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">&quot;The non-form errors of formset </span><span class=\"si\">{</span><span class=\"n\">formset</span><span class=\"si\">!r}</span><span class=\"s2\"> don&#39;t match.&quot;</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n                <span class=\"n\">formset</span><span class=\"o\">.</span><span class=\"n\">non_form_errors</span><span class=\"p\">(),</span> <span class=\"n\">errors</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"n\">failure_message</span>\n            <span class=\"p\">)</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_get_template_used</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"n\">template_name</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"n\">method_name</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">response</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">template_name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;response and/or template_name argument must be provided&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">msg_prefix</span><span class=\"p\">:</span>\n            <span class=\"n\">msg_prefix</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot;: &quot;</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">template_name</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">response</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_test_client_response</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"s2\">&quot;templates&quot;</span><span class=\"p\">,</span> <span class=\"n\">method_name</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">,</span> <span class=\"s2\">&quot;templates&quot;</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">response</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">template_name</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"n\">response</span><span class=\"p\">:</span>\n                <span class=\"n\">template_name</span> <span class=\"o\">=</span> <span class=\"n\">response</span>\n                <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"c1\"># use this template with context manager</span>\n            <span class=\"k\">return</span> <span class=\"n\">template_name</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span>\n\n        <span class=\"n\">template_names</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">t</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"k\">for</span> <span class=\"n\">t</span> <span class=\"ow\">in</span> <span class=\"n\">response</span><span class=\"o\">.</span><span class=\"n\">templates</span> <span class=\"k\">if</span> <span class=\"n\">t</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">]</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">template_names</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_assert_template_used</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">template_name</span><span class=\"p\">,</span> <span class=\"n\">template_names</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">template_names</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;No templates used to render the response&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertTrue</span><span class=\"p\">(</span>\n            <span class=\"n\">template_name</span> <span class=\"ow\">in</span> <span class=\"n\">template_names</span><span class=\"p\">,</span>\n            <span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;Template &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; was not a template used to render&quot;</span>\n            <span class=\"s2\">&quot; the response. Actual template(s) used: </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span>\n            <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">template_name</span><span class=\"p\">,</span> <span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">template_names</span><span class=\"p\">)),</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">count</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n                <span class=\"n\">template_names</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">(</span><span class=\"n\">template_name</span><span class=\"p\">),</span>\n                <span class=\"n\">count</span><span class=\"p\">,</span>\n                <span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;Template &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; was expected to be rendered </span><span class=\"si\">%d</span><span class=\"s2\"> &quot;</span>\n                <span class=\"s2\">&quot;time(s) but was actually rendered </span><span class=\"si\">%d</span><span class=\"s2\"> time(s).&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">template_name</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"p\">,</span> <span class=\"n\">template_names</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">(</span><span class=\"n\">template_name</span><span class=\"p\">)),</span>\n            <span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertTemplateUsed\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertTemplateUsed\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertTemplateUsed</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">template_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"o\">=</span><span class=\"kc\">None</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that the template with the provided name was used in rendering</span>\n<span class=\"sd\">        the response. Also usable as context manager.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">context_mgr_template</span><span class=\"p\">,</span> <span class=\"n\">template_names</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_template_used</span><span class=\"p\">(</span>\n            <span class=\"n\">response</span><span class=\"p\">,</span>\n            <span class=\"n\">template_name</span><span class=\"p\">,</span>\n            <span class=\"n\">msg_prefix</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;assertTemplateUsed&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">context_mgr_template</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Use assertTemplateUsed as context manager.</span>\n            <span class=\"k\">return</span> <span class=\"n\">_AssertTemplateUsedContext</span><span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context_mgr_template</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"n\">count</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_assert_template_used</span><span class=\"p\">(</span><span class=\"n\">template_name</span><span class=\"p\">,</span> <span class=\"n\">template_names</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertTemplateNotUsed\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertTemplateNotUsed\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertTemplateNotUsed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">response</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">template_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that the template with the provided name was NOT used in</span>\n<span class=\"sd\">        rendering the response. Also usable as context manager.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">context_mgr_template</span><span class=\"p\">,</span> <span class=\"n\">template_names</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_template_used</span><span class=\"p\">(</span>\n            <span class=\"n\">response</span><span class=\"p\">,</span>\n            <span class=\"n\">template_name</span><span class=\"p\">,</span>\n            <span class=\"n\">msg_prefix</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;assertTemplateNotUsed&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">context_mgr_template</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Use assertTemplateNotUsed as context manager.</span>\n            <span class=\"k\">return</span> <span class=\"n\">_AssertTemplateNotUsedContext</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">context_mgr_template</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertFalse</span><span class=\"p\">(</span>\n            <span class=\"n\">template_name</span> <span class=\"ow\">in</span> <span class=\"n\">template_names</span><span class=\"p\">,</span>\n            <span class=\"n\">msg_prefix</span>\n            <span class=\"o\">+</span> <span class=\"s2\">&quot;Template &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; was used unexpectedly in rendering the response&quot;</span>\n            <span class=\"o\">%</span> <span class=\"n\">template_name</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span></div>\n\n    <span class=\"nd\">@contextmanager</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_assert_raises_or_warns_cm</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">func</span><span class=\"p\">,</span> <span class=\"n\">cm_attr</span><span class=\"p\">,</span> <span class=\"n\">expected_exception</span><span class=\"p\">,</span> <span class=\"n\">expected_message</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">with</span> <span class=\"n\">func</span><span class=\"p\">(</span><span class=\"n\">expected_exception</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">cm</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"n\">cm</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertIn</span><span class=\"p\">(</span><span class=\"n\">expected_message</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">cm</span><span class=\"p\">,</span> <span class=\"n\">cm_attr</span><span class=\"p\">)))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_assertFooMessage</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">func</span><span class=\"p\">,</span> <span class=\"n\">cm_attr</span><span class=\"p\">,</span> <span class=\"n\">expected_exception</span><span class=\"p\">,</span> <span class=\"n\">expected_message</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span>\n    <span class=\"p\">):</span>\n        <span class=\"n\">callable_obj</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">if</span> <span class=\"n\">args</span><span class=\"p\">:</span>\n            <span class=\"n\">callable_obj</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"n\">args</span>\n        <span class=\"n\">cm</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_assert_raises_or_warns_cm</span><span class=\"p\">(</span>\n            <span class=\"n\">func</span><span class=\"p\">,</span> <span class=\"n\">cm_attr</span><span class=\"p\">,</span> <span class=\"n\">expected_exception</span><span class=\"p\">,</span> <span class=\"n\">expected_message</span>\n        <span class=\"p\">)</span>\n        <span class=\"c1\"># Assertion used in context manager fashion.</span>\n        <span class=\"k\">if</span> <span class=\"n\">callable_obj</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">cm</span>\n        <span class=\"c1\"># Assertion was passed a callable.</span>\n        <span class=\"k\">with</span> <span class=\"n\">cm</span><span class=\"p\">:</span>\n            <span class=\"n\">callable_obj</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertRaisesMessage\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertRaisesMessage\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertRaisesMessage</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">expected_exception</span><span class=\"p\">,</span> <span class=\"n\">expected_message</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that expected_message is found in the message of a raised</span>\n<span class=\"sd\">        exception.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            expected_exception: Exception class expected to be raised.</span>\n<span class=\"sd\">            expected_message: expected error message string value.</span>\n<span class=\"sd\">            args: Function to be called and extra positional args.</span>\n<span class=\"sd\">            kwargs: Extra kwargs.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_assertFooMessage</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertRaises</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;exception&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">expected_exception</span><span class=\"p\">,</span>\n            <span class=\"n\">expected_message</span><span class=\"p\">,</span>\n            <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span>\n            <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertWarnsMessage\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertWarnsMessage\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertWarnsMessage</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">expected_warning</span><span class=\"p\">,</span> <span class=\"n\">expected_message</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Same as assertRaisesMessage but for assertWarns() instead of</span>\n<span class=\"sd\">        assertRaises().</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_assertFooMessage</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertWarns</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;warning&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">expected_warning</span><span class=\"p\">,</span>\n            <span class=\"n\">expected_message</span><span class=\"p\">,</span>\n            <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span>\n            <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertFieldOutput\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertFieldOutput\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertFieldOutput</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">fieldclass</span><span class=\"p\">,</span>\n        <span class=\"n\">valid</span><span class=\"p\">,</span>\n        <span class=\"n\">invalid</span><span class=\"p\">,</span>\n        <span class=\"n\">field_args</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">field_kwargs</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">empty_value</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that a form field behaves correctly with various inputs.</span>\n\n<span class=\"sd\">        Args:</span>\n<span class=\"sd\">            fieldclass: the class of the field to be tested.</span>\n<span class=\"sd\">            valid: a dictionary mapping valid inputs to their expected</span>\n<span class=\"sd\">                    cleaned values.</span>\n<span class=\"sd\">            invalid: a dictionary mapping invalid inputs to one or more</span>\n<span class=\"sd\">                    raised error messages.</span>\n<span class=\"sd\">            field_args: the args passed to instantiate the field</span>\n<span class=\"sd\">            field_kwargs: the kwargs passed to instantiate the field</span>\n<span class=\"sd\">            empty_value: the expected clean output for inputs in empty_values</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">field_args</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">field_args</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">if</span> <span class=\"n\">field_kwargs</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">field_kwargs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"n\">required</span> <span class=\"o\">=</span> <span class=\"n\">fieldclass</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">field_args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">field_kwargs</span><span class=\"p\">)</span>\n        <span class=\"n\">optional</span> <span class=\"o\">=</span> <span class=\"n\">fieldclass</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">field_args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"p\">{</span><span class=\"o\">**</span><span class=\"n\">field_kwargs</span><span class=\"p\">,</span> <span class=\"s2\">&quot;required&quot;</span><span class=\"p\">:</span> <span class=\"kc\">False</span><span class=\"p\">})</span>\n        <span class=\"c1\"># test valid inputs</span>\n        <span class=\"k\">for</span> <span class=\"nb\">input</span><span class=\"p\">,</span> <span class=\"n\">output</span> <span class=\"ow\">in</span> <span class=\"n\">valid</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span><span class=\"n\">required</span><span class=\"o\">.</span><span class=\"n\">clean</span><span class=\"p\">(</span><span class=\"nb\">input</span><span class=\"p\">),</span> <span class=\"n\">output</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span><span class=\"n\">optional</span><span class=\"o\">.</span><span class=\"n\">clean</span><span class=\"p\">(</span><span class=\"nb\">input</span><span class=\"p\">),</span> <span class=\"n\">output</span><span class=\"p\">)</span>\n        <span class=\"c1\"># test invalid inputs</span>\n        <span class=\"k\">for</span> <span class=\"nb\">input</span><span class=\"p\">,</span> <span class=\"n\">errors</span> <span class=\"ow\">in</span> <span class=\"n\">invalid</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertRaises</span><span class=\"p\">(</span><span class=\"n\">ValidationError</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">context_manager</span><span class=\"p\">:</span>\n                <span class=\"n\">required</span><span class=\"o\">.</span><span class=\"n\">clean</span><span class=\"p\">(</span><span class=\"nb\">input</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span><span class=\"n\">context_manager</span><span class=\"o\">.</span><span class=\"n\">exception</span><span class=\"o\">.</span><span class=\"n\">messages</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">)</span>\n\n            <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertRaises</span><span class=\"p\">(</span><span class=\"n\">ValidationError</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">context_manager</span><span class=\"p\">:</span>\n                <span class=\"n\">optional</span><span class=\"o\">.</span><span class=\"n\">clean</span><span class=\"p\">(</span><span class=\"nb\">input</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span><span class=\"n\">context_manager</span><span class=\"o\">.</span><span class=\"n\">exception</span><span class=\"o\">.</span><span class=\"n\">messages</span><span class=\"p\">,</span> <span class=\"n\">errors</span><span class=\"p\">)</span>\n        <span class=\"c1\"># test required inputs</span>\n        <span class=\"n\">error_required</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">required</span><span class=\"o\">.</span><span class=\"n\">error_messages</span><span class=\"p\">[</span><span class=\"s2\">&quot;required&quot;</span><span class=\"p\">]]</span>\n        <span class=\"k\">for</span> <span class=\"n\">e</span> <span class=\"ow\">in</span> <span class=\"n\">required</span><span class=\"o\">.</span><span class=\"n\">empty_values</span><span class=\"p\">:</span>\n            <span class=\"k\">with</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertRaises</span><span class=\"p\">(</span><span class=\"n\">ValidationError</span><span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">context_manager</span><span class=\"p\">:</span>\n                <span class=\"n\">required</span><span class=\"o\">.</span><span class=\"n\">clean</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span><span class=\"n\">context_manager</span><span class=\"o\">.</span><span class=\"n\">exception</span><span class=\"o\">.</span><span class=\"n\">messages</span><span class=\"p\">,</span> <span class=\"n\">error_required</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span><span class=\"n\">optional</span><span class=\"o\">.</span><span class=\"n\">clean</span><span class=\"p\">(</span><span class=\"n\">e</span><span class=\"p\">),</span> <span class=\"n\">empty_value</span><span class=\"p\">)</span>\n        <span class=\"c1\"># test that max_length and min_length are always accepted</span>\n        <span class=\"k\">if</span> <span class=\"nb\">issubclass</span><span class=\"p\">(</span><span class=\"n\">fieldclass</span><span class=\"p\">,</span> <span class=\"n\">CharField</span><span class=\"p\">):</span>\n            <span class=\"n\">field_kwargs</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">({</span><span class=\"s2\">&quot;min_length&quot;</span><span class=\"p\">:</span> <span class=\"mi\">2</span><span class=\"p\">,</span> <span class=\"s2\">&quot;max_length&quot;</span><span class=\"p\">:</span> <span class=\"mi\">20</span><span class=\"p\">})</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertIsInstance</span><span class=\"p\">(</span><span class=\"n\">fieldclass</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">field_args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">field_kwargs</span><span class=\"p\">),</span> <span class=\"n\">fieldclass</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertHTMLEqual\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertHTMLEqual\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertHTMLEqual</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">html1</span><span class=\"p\">,</span> <span class=\"n\">html2</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that two HTML snippets are semantically the same.</span>\n<span class=\"sd\">        Whitespace in most cases is ignored, and attribute ordering is not</span>\n<span class=\"sd\">        significant. The arguments must be valid HTML.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">dom1</span> <span class=\"o\">=</span> <span class=\"n\">assert_and_parse_html</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">html1</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"s2\">&quot;First argument is not valid HTML:&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">dom2</span> <span class=\"o\">=</span> <span class=\"n\">assert_and_parse_html</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">html2</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Second argument is not valid HTML:&quot;</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">dom1</span> <span class=\"o\">!=</span> <span class=\"n\">dom2</span><span class=\"p\">:</span>\n            <span class=\"n\">standardMsg</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> != </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">safe_repr</span><span class=\"p\">(</span><span class=\"n\">dom1</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">),</span> <span class=\"n\">safe_repr</span><span class=\"p\">(</span><span class=\"n\">dom2</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">))</span>\n            <span class=\"n\">diff</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                <span class=\"n\">difflib</span><span class=\"o\">.</span><span class=\"n\">ndiff</span><span class=\"p\">(</span>\n                    <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">dom1</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">(),</span>\n                    <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">dom2</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">(),</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">standardMsg</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_truncateMessage</span><span class=\"p\">(</span><span class=\"n\">standardMsg</span><span class=\"p\">,</span> <span class=\"n\">diff</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_formatMessage</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"n\">standardMsg</span><span class=\"p\">))</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertHTMLNotEqual\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertHTMLNotEqual\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertHTMLNotEqual</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">html1</span><span class=\"p\">,</span> <span class=\"n\">html2</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Assert that two HTML snippets are not semantically equivalent.&quot;&quot;&quot;</span>\n        <span class=\"n\">dom1</span> <span class=\"o\">=</span> <span class=\"n\">assert_and_parse_html</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">html1</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"s2\">&quot;First argument is not valid HTML:&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">dom2</span> <span class=\"o\">=</span> <span class=\"n\">assert_and_parse_html</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">html2</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Second argument is not valid HTML:&quot;</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">dom1</span> <span class=\"o\">==</span> <span class=\"n\">dom2</span><span class=\"p\">:</span>\n            <span class=\"n\">standardMsg</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> == </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">safe_repr</span><span class=\"p\">(</span><span class=\"n\">dom1</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">),</span> <span class=\"n\">safe_repr</span><span class=\"p\">(</span><span class=\"n\">dom2</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">))</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_formatMessage</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"n\">standardMsg</span><span class=\"p\">))</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertInHTML\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertInHTML\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertInHTML</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">needle</span><span class=\"p\">,</span> <span class=\"n\">haystack</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span><span class=\"o\">=</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">):</span>\n        <span class=\"n\">needle</span> <span class=\"o\">=</span> <span class=\"n\">assert_and_parse_html</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">needle</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"s2\">&quot;First argument is not valid HTML:&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">haystack</span> <span class=\"o\">=</span> <span class=\"n\">assert_and_parse_html</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">haystack</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"s2\">&quot;Second argument is not valid HTML:&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">real_count</span> <span class=\"o\">=</span> <span class=\"n\">haystack</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">(</span><span class=\"n\">needle</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">count</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span>\n                <span class=\"n\">real_count</span><span class=\"p\">,</span>\n                <span class=\"n\">count</span><span class=\"p\">,</span>\n                <span class=\"n\">msg_prefix</span>\n                <span class=\"o\">+</span> <span class=\"s2\">&quot;Found </span><span class=\"si\">%d</span><span class=\"s2\"> instances of &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; in response (expected </span><span class=\"si\">%d</span><span class=\"s2\">)&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">real_count</span><span class=\"p\">,</span> <span class=\"n\">needle</span><span class=\"p\">,</span> <span class=\"n\">count</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertTrue</span><span class=\"p\">(</span>\n                <span class=\"n\">real_count</span> <span class=\"o\">!=</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">msg_prefix</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;Couldn&#39;t find &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; in response&quot;</span> <span class=\"o\">%</span> <span class=\"n\">needle</span>\n            <span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertJSONEqual\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertJSONEqual\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertJSONEqual</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">raw</span><span class=\"p\">,</span> <span class=\"n\">expected_data</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that the JSON fragments raw and expected_data are equal.</span>\n<span class=\"sd\">        Usual JSON non-significant whitespace rules apply as the heavyweight</span>\n<span class=\"sd\">        is delegated to the json library.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">raw</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">JSONDecodeError</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"s2\">&quot;First argument is not valid JSON: </span><span class=\"si\">%r</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">raw</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">expected_data</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">):</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">expected_data</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">expected_data</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"ne\">ValueError</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"s2\">&quot;Second argument is not valid JSON: </span><span class=\"si\">%r</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">expected_data</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">expected_data</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"n\">msg</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertJSONNotEqual\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertJSONNotEqual\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertJSONNotEqual</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">raw</span><span class=\"p\">,</span> <span class=\"n\">expected_data</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that the JSON fragments raw and expected_data are not equal.</span>\n<span class=\"sd\">        Usual JSON non-significant whitespace rules apply as the heavyweight</span>\n<span class=\"sd\">        is delegated to the json library.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">raw</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">JSONDecodeError</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"s2\">&quot;First argument is not valid JSON: </span><span class=\"si\">%r</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">raw</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">expected_data</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">):</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">expected_data</span> <span class=\"o\">=</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">loads</span><span class=\"p\">(</span><span class=\"n\">expected_data</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">json</span><span class=\"o\">.</span><span class=\"n\">JSONDecodeError</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"s2\">&quot;Second argument is not valid JSON: </span><span class=\"si\">%r</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">expected_data</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertNotEqual</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">expected_data</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"n\">msg</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertXMLEqual\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertXMLEqual\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertXMLEqual</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">xml1</span><span class=\"p\">,</span> <span class=\"n\">xml2</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that two XML snippets are semantically the same.</span>\n<span class=\"sd\">        Whitespace in most cases is ignored and attribute ordering is not</span>\n<span class=\"sd\">        significant. The arguments must be valid XML.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">compare_xml</span><span class=\"p\">(</span><span class=\"n\">xml1</span><span class=\"p\">,</span> <span class=\"n\">xml2</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"ne\">Exception</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n            <span class=\"n\">standardMsg</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;First or second argument is not valid XML</span><span class=\"se\">\\n</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">e</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_formatMessage</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"n\">standardMsg</span><span class=\"p\">))</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">result</span><span class=\"p\">:</span>\n                <span class=\"n\">standardMsg</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> != </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"n\">safe_repr</span><span class=\"p\">(</span><span class=\"n\">xml1</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">),</span>\n                    <span class=\"n\">safe_repr</span><span class=\"p\">(</span><span class=\"n\">xml2</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">diff</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                    <span class=\"n\">difflib</span><span class=\"o\">.</span><span class=\"n\">ndiff</span><span class=\"p\">(</span><span class=\"n\">xml1</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">(),</span> <span class=\"n\">xml2</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">())</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">standardMsg</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_truncateMessage</span><span class=\"p\">(</span><span class=\"n\">standardMsg</span><span class=\"p\">,</span> <span class=\"n\">diff</span><span class=\"p\">)</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_formatMessage</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"n\">standardMsg</span><span class=\"p\">))</span></div>\n\n<div class=\"viewcode-block\" id=\"SimpleTestCase.assertXMLNotEqual\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.SimpleTestCase.assertXMLNotEqual\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertXMLNotEqual</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">xml1</span><span class=\"p\">,</span> <span class=\"n\">xml2</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Assert that two XML snippets are not semantically equivalent.</span>\n<span class=\"sd\">        Whitespace in most cases is ignored and attribute ordering is not</span>\n<span class=\"sd\">        significant. The arguments must be valid XML.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">result</span> <span class=\"o\">=</span> <span class=\"n\">compare_xml</span><span class=\"p\">(</span><span class=\"n\">xml1</span><span class=\"p\">,</span> <span class=\"n\">xml2</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"ne\">Exception</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n            <span class=\"n\">standardMsg</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;First or second argument is not valid XML</span><span class=\"se\">\\n</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">e</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_formatMessage</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"n\">standardMsg</span><span class=\"p\">))</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">result</span><span class=\"p\">:</span>\n                <span class=\"n\">standardMsg</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> == </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"n\">safe_repr</span><span class=\"p\">(</span><span class=\"n\">xml1</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">),</span>\n                    <span class=\"n\">safe_repr</span><span class=\"p\">(</span><span class=\"n\">xml2</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fail</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_formatMessage</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">,</span> <span class=\"n\">standardMsg</span><span class=\"p\">))</span></div></div>\n\n\n<div class=\"viewcode-block\" id=\"TransactionTestCase\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.TransactionTestCase\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TransactionTestCase</span><span class=\"p\">(</span><span class=\"n\">SimpleTestCase</span><span class=\"p\">):</span>\n    <span class=\"c1\"># Subclasses can ask for resetting of auto increment sequence before each</span>\n    <span class=\"c1\"># test case</span>\n    <span class=\"n\">reset_sequences</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n    <span class=\"c1\"># Subclasses can enable only a subset of apps for faster tests</span>\n    <span class=\"n\">available_apps</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"c1\"># Subclasses can define fixtures which will be automatically installed.</span>\n    <span class=\"n\">fixtures</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"n\">databases</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">DEFAULT_DB_ALIAS</span><span class=\"p\">}</span>\n    <span class=\"n\">_disallowed_database_msg</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"s2\">&quot;Database </span><span class=\"si\">%(operation)s</span><span class=\"s2\"> to </span><span class=\"si\">%(alias)r</span><span class=\"s2\"> are not allowed in this test. &quot;</span>\n        <span class=\"s2\">&quot;Add </span><span class=\"si\">%(alias)r</span><span class=\"s2\"> to </span><span class=\"si\">%(test)s</span><span class=\"s2\">.databases to ensure proper test isolation &quot;</span>\n        <span class=\"s2\">&quot;and silence this failure.&quot;</span>\n    <span class=\"p\">)</span>\n\n    <span class=\"c1\"># If transactions aren&#39;t available, Django will serialize the database</span>\n    <span class=\"c1\"># contents into a fixture during setup and flush and reload them</span>\n    <span class=\"c1\"># during teardown (as flush does not restore data from migrations).</span>\n    <span class=\"c1\"># This can be slow; this flag allows enabling on a per-case basis.</span>\n    <span class=\"n\">serialized_rollback</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_pre_setup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Perform pre-test setup:</span>\n<span class=\"sd\">        * If the class has an &#39;available_apps&#39; attribute, restrict the app</span>\n<span class=\"sd\">          registry to these applications, then fire the post_migrate signal --</span>\n<span class=\"sd\">          it must run with the correct set of applications for the test case.</span>\n<span class=\"sd\">        * If the class has a &#39;fixtures&#39; attribute, install those fixtures.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">_pre_setup</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">apps</span><span class=\"o\">.</span><span class=\"n\">set_available_apps</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span><span class=\"p\">)</span>\n            <span class=\"n\">setting_changed</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">(</span>\n                <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">_wrapped</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n                <span class=\"n\">setting</span><span class=\"o\">=</span><span class=\"s2\">&quot;INSTALLED_APPS&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span><span class=\"p\">,</span>\n                <span class=\"n\">enter</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">db_name</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_databases_names</span><span class=\"p\">(</span><span class=\"n\">include_mirrors</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n                <span class=\"n\">emit_post_migrate_signal</span><span class=\"p\">(</span><span class=\"n\">verbosity</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">interactive</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">db</span><span class=\"o\">=</span><span class=\"n\">db_name</span><span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fixture_setup</span><span class=\"p\">()</span>\n        <span class=\"k\">except</span> <span class=\"ne\">Exception</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">apps</span><span class=\"o\">.</span><span class=\"n\">unset_available_apps</span><span class=\"p\">()</span>\n                <span class=\"n\">setting_changed</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">(</span>\n                    <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">_wrapped</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n                    <span class=\"n\">setting</span><span class=\"o\">=</span><span class=\"s2\">&quot;INSTALLED_APPS&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">INSTALLED_APPS</span><span class=\"p\">,</span>\n                    <span class=\"n\">enter</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">raise</span>\n        <span class=\"c1\"># Clear the queries_log so that it&#39;s less likely to overflow (a single</span>\n        <span class=\"c1\"># test probably won&#39;t execute 9K queries). If queries_log overflows,</span>\n        <span class=\"c1\"># then assertNumQueries() doesn&#39;t work.</span>\n        <span class=\"k\">for</span> <span class=\"n\">db_name</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_databases_names</span><span class=\"p\">(</span><span class=\"n\">include_mirrors</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n            <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">queries_log</span><span class=\"o\">.</span><span class=\"n\">clear</span><span class=\"p\">()</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_databases_names</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">include_mirrors</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Only consider allowed database aliases, including mirrors or not.</span>\n        <span class=\"k\">return</span> <span class=\"p\">[</span>\n            <span class=\"n\">alias</span>\n            <span class=\"k\">for</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"n\">connections</span>\n            <span class=\"k\">if</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">databases</span>\n            <span class=\"ow\">and</span> <span class=\"p\">(</span>\n                <span class=\"n\">include_mirrors</span>\n                <span class=\"ow\">or</span> <span class=\"ow\">not</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">alias</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">settings_dict</span><span class=\"p\">[</span><span class=\"s2\">&quot;TEST&quot;</span><span class=\"p\">][</span><span class=\"s2\">&quot;MIRROR&quot;</span><span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_reset_sequences</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">db_name</span><span class=\"p\">):</span>\n        <span class=\"n\">conn</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_sequence_reset</span><span class=\"p\">:</span>\n            <span class=\"n\">sql_list</span> <span class=\"o\">=</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">sequence_reset_by_name_sql</span><span class=\"p\">(</span>\n                <span class=\"n\">no_style</span><span class=\"p\">(),</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">introspection</span><span class=\"o\">.</span><span class=\"n\">sequence_list</span><span class=\"p\">()</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">sql_list</span><span class=\"p\">:</span>\n                <span class=\"k\">with</span> <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">db_name</span><span class=\"p\">):</span>\n                    <span class=\"k\">with</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"p\">()</span> <span class=\"k\">as</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n                        <span class=\"k\">for</span> <span class=\"n\">sql</span> <span class=\"ow\">in</span> <span class=\"n\">sql_list</span><span class=\"p\">:</span>\n                            <span class=\"n\">cursor</span><span class=\"o\">.</span><span class=\"n\">execute</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_fixture_setup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">for</span> <span class=\"n\">db_name</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_databases_names</span><span class=\"p\">(</span><span class=\"n\">include_mirrors</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n            <span class=\"c1\"># Reset sequences</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reset_sequences</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_reset_sequences</span><span class=\"p\">(</span><span class=\"n\">db_name</span><span class=\"p\">)</span>\n\n            <span class=\"c1\"># Provide replica initial data from migrated apps, if needed.</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">serialized_rollback</span> <span class=\"ow\">and</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span>\n                <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">],</span> <span class=\"s2\">&quot;_test_serialized_contents&quot;</span>\n            <span class=\"p\">):</span>\n                <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                    <span class=\"n\">apps</span><span class=\"o\">.</span><span class=\"n\">unset_available_apps</span><span class=\"p\">()</span>\n                <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">creation</span><span class=\"o\">.</span><span class=\"n\">deserialize_db_from_string</span><span class=\"p\">(</span>\n                    <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">_test_serialized_contents</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                    <span class=\"n\">apps</span><span class=\"o\">.</span><span class=\"n\">set_available_apps</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span><span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fixtures</span><span class=\"p\">:</span>\n                <span class=\"c1\"># We have to use this slightly awkward syntax due to the fact</span>\n                <span class=\"c1\"># that we&#39;re using *args and **kwargs together.</span>\n                <span class=\"n\">call_command</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;loaddata&quot;</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">fixtures</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"p\">{</span><span class=\"s2\">&quot;verbosity&quot;</span><span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"s2\">&quot;database&quot;</span><span class=\"p\">:</span> <span class=\"n\">db_name</span><span class=\"p\">}</span>\n                <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_should_reload_connections</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_post_teardown</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Perform post-test things:</span>\n<span class=\"sd\">        * Flush the contents of the database to leave a clean slate. If the</span>\n<span class=\"sd\">          class has an &#39;available_apps&#39; attribute, don&#39;t fire post_migrate.</span>\n<span class=\"sd\">        * Force-close the connection so the next test gets a clean cursor.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fixture_teardown</span><span class=\"p\">()</span>\n            <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">_post_teardown</span><span class=\"p\">()</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_should_reload_connections</span><span class=\"p\">():</span>\n                <span class=\"c1\"># Some DB cursors include SQL statements as part of cursor</span>\n                <span class=\"c1\"># creation. If you have a test that does a rollback, the effect</span>\n                <span class=\"c1\"># of these statements is lost, which can affect the operation of</span>\n                <span class=\"c1\"># tests (e.g., losing a timezone setting causing objects to be</span>\n                <span class=\"c1\"># created with the wrong time). To make sure this doesn&#39;t</span>\n                <span class=\"c1\"># happen, get a clean connection at the start of every test.</span>\n                <span class=\"k\">for</span> <span class=\"n\">conn</span> <span class=\"ow\">in</span> <span class=\"n\">connections</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">(</span><span class=\"n\">initialized_only</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n                    <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n        <span class=\"k\">finally</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">apps</span><span class=\"o\">.</span><span class=\"n\">unset_available_apps</span><span class=\"p\">()</span>\n                <span class=\"n\">setting_changed</span><span class=\"o\">.</span><span class=\"n\">send</span><span class=\"p\">(</span>\n                    <span class=\"n\">sender</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">_wrapped</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span>\n                    <span class=\"n\">setting</span><span class=\"o\">=</span><span class=\"s2\">&quot;INSTALLED_APPS&quot;</span><span class=\"p\">,</span>\n                    <span class=\"n\">value</span><span class=\"o\">=</span><span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">INSTALLED_APPS</span><span class=\"p\">,</span>\n                    <span class=\"n\">enter</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_fixture_teardown</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Allow TRUNCATE ... CASCADE and don&#39;t emit the post_migrate signal</span>\n        <span class=\"c1\"># when flushing only a subset of the apps</span>\n        <span class=\"k\">for</span> <span class=\"n\">db_name</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_databases_names</span><span class=\"p\">(</span><span class=\"n\">include_mirrors</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n            <span class=\"c1\"># Flush the database</span>\n            <span class=\"n\">inhibit_post_migrate</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n                <span class=\"ow\">or</span> <span class=\"p\">(</span>  <span class=\"c1\"># Inhibit the post_migrate signal when using serialized</span>\n                    <span class=\"c1\"># rollback to avoid trying to recreate the serialized data.</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">serialized_rollback</span>\n                    <span class=\"ow\">and</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">],</span> <span class=\"s2\">&quot;_test_serialized_contents&quot;</span><span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n            <span class=\"n\">call_command</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;flush&quot;</span><span class=\"p\">,</span>\n                <span class=\"n\">verbosity</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span>\n                <span class=\"n\">interactive</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n                <span class=\"n\">database</span><span class=\"o\">=</span><span class=\"n\">db_name</span><span class=\"p\">,</span>\n                <span class=\"n\">reset_sequences</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n                <span class=\"n\">allow_cascade</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">available_apps</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">,</span>\n                <span class=\"n\">inhibit_post_migrate</span><span class=\"o\">=</span><span class=\"n\">inhibit_post_migrate</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"c1\"># RemovedInDjango51Warning.</span>\n    <span class=\"k\">def</span> <span class=\"nf\">assertQuerysetEqual</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kw</span><span class=\"p\">):</span>\n        <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;assertQuerysetEqual() is deprecated in favor of assertQuerySetEqual().&quot;</span><span class=\"p\">,</span>\n            <span class=\"n\">category</span><span class=\"o\">=</span><span class=\"n\">RemovedInDjango51Warning</span><span class=\"p\">,</span>\n            <span class=\"n\">stacklevel</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertQuerySetEqual</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kw</span><span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"TransactionTestCase.assertQuerySetEqual\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.TransactionTestCase.assertQuerySetEqual\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertQuerySetEqual</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">qs</span><span class=\"p\">,</span> <span class=\"n\">values</span><span class=\"p\">,</span> <span class=\"n\">transform</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">ordered</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"n\">values</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">)</span>\n        <span class=\"n\">items</span> <span class=\"o\">=</span> <span class=\"n\">qs</span>\n        <span class=\"k\">if</span> <span class=\"n\">transform</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">items</span> <span class=\"o\">=</span> <span class=\"nb\">map</span><span class=\"p\">(</span><span class=\"n\">transform</span><span class=\"p\">,</span> <span class=\"n\">items</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">ordered</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertDictEqual</span><span class=\"p\">(</span><span class=\"n\">Counter</span><span class=\"p\">(</span><span class=\"n\">items</span><span class=\"p\">),</span> <span class=\"n\">Counter</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">),</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"n\">msg</span><span class=\"p\">)</span>\n        <span class=\"c1\"># For example qs.iterator() could be passed as qs, but it does not</span>\n        <span class=\"c1\"># have &#39;ordered&#39; attribute.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span> <span class=\"ow\">and</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">qs</span><span class=\"p\">,</span> <span class=\"s2\">&quot;ordered&quot;</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">ordered</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Trying to compare non-ordered queryset against more than one &quot;</span>\n                <span class=\"s2\">&quot;ordered value.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">assertEqual</span><span class=\"p\">(</span><span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">items</span><span class=\"p\">),</span> <span class=\"n\">values</span><span class=\"p\">,</span> <span class=\"n\">msg</span><span class=\"o\">=</span><span class=\"n\">msg</span><span class=\"p\">)</span></div>\n\n<div class=\"viewcode-block\" id=\"TransactionTestCase.assertNumQueries\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.TransactionTestCase.assertNumQueries\">[docs]</a>    <span class=\"k\">def</span> <span class=\"nf\">assertNumQueries</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">num</span><span class=\"p\">,</span> <span class=\"n\">func</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">DEFAULT_DB_ALIAS</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"n\">conn</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">using</span><span class=\"p\">]</span>\n\n        <span class=\"n\">context</span> <span class=\"o\">=</span> <span class=\"n\">_AssertNumQueriesContext</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">num</span><span class=\"p\">,</span> <span class=\"n\">conn</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">func</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">context</span>\n\n        <span class=\"k\">with</span> <span class=\"n\">context</span><span class=\"p\">:</span>\n            <span class=\"n\">func</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span></div></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">connections_support_transactions</span><span class=\"p\">(</span><span class=\"n\">aliases</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Return whether or not all (or specified) connections support</span>\n<span class=\"sd\">    transactions.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">conns</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n        <span class=\"n\">connections</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">aliases</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n        <span class=\"k\">else</span> <span class=\"p\">(</span><span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">alias</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"n\">aliases</span><span class=\"p\">)</span>\n    <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"nb\">all</span><span class=\"p\">(</span><span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_transactions</span> <span class=\"k\">for</span> <span class=\"n\">conn</span> <span class=\"ow\">in</span> <span class=\"n\">conns</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">TestData</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Descriptor to provide TestCase instance isolation for attributes assigned</span>\n<span class=\"sd\">    during the setUpTestData() phase.</span>\n\n<span class=\"sd\">    Allow safe alteration of objects assigned in setUpTestData() by test</span>\n<span class=\"sd\">    methods by exposing deep copies instead of the original objects.</span>\n\n<span class=\"sd\">    Objects are deep copied using a memo kept on the test case instance in</span>\n<span class=\"sd\">    order to maintain their original relationships.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">memo_attr</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;_testdata_memo&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">=</span> <span class=\"n\">name</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">data</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_memo</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">testcase</span><span class=\"p\">):</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">memo</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">testcase</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">memo_attr</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"ne\">AttributeError</span><span class=\"p\">:</span>\n            <span class=\"n\">memo</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n            <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">testcase</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">memo_attr</span><span class=\"p\">,</span> <span class=\"n\">memo</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">memo</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__get__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">owner</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">instance</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">data</span>\n        <span class=\"n\">memo</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_memo</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">)</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">deepcopy</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"p\">,</span> <span class=\"n\">memo</span><span class=\"p\">)</span>\n        <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">data</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__repr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;&lt;TestData: name=</span><span class=\"si\">%r</span><span class=\"s2\">, data=</span><span class=\"si\">%r</span><span class=\"s2\">&gt;&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">data</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"TestCase\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.TestCase\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">TestCase</span><span class=\"p\">(</span><span class=\"n\">TransactionTestCase</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Similar to TransactionTestCase, but use `transaction.atomic()` to achieve</span>\n<span class=\"sd\">    test isolation.</span>\n\n<span class=\"sd\">    In most situations, TestCase should be preferred to TransactionTestCase as</span>\n<span class=\"sd\">    it allows faster execution. However, there are some situations where using</span>\n<span class=\"sd\">    TransactionTestCase might be necessary (e.g. testing some transactional</span>\n<span class=\"sd\">    behavior).</span>\n\n<span class=\"sd\">    On database backends with no transaction support, TestCase behaves as</span>\n<span class=\"sd\">    TransactionTestCase.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_enter_atomics</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Open atomic blocks for multiple databases.&quot;&quot;&quot;</span>\n        <span class=\"n\">atomics</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">for</span> <span class=\"n\">db_name</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_databases_names</span><span class=\"p\">():</span>\n            <span class=\"n\">atomic</span> <span class=\"o\">=</span> <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">db_name</span><span class=\"p\">)</span>\n            <span class=\"n\">atomic</span><span class=\"o\">.</span><span class=\"n\">_from_testcase</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"n\">atomic</span><span class=\"o\">.</span><span class=\"fm\">__enter__</span><span class=\"p\">()</span>\n            <span class=\"n\">atomics</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">atomic</span>\n        <span class=\"k\">return</span> <span class=\"n\">atomics</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_rollback_atomics</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">atomics</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Rollback atomic blocks opened by the previous method.&quot;&quot;&quot;</span>\n        <span class=\"k\">for</span> <span class=\"n\">db_name</span> <span class=\"ow\">in</span> <span class=\"nb\">reversed</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_databases_names</span><span class=\"p\">()):</span>\n            <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"n\">set_rollback</span><span class=\"p\">(</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">db_name</span><span class=\"p\">)</span>\n            <span class=\"n\">atomics</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"fm\">__exit__</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_databases_support_transactions</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">connections_support_transactions</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">databases</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">setUpClass</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">setUpClass</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_databases_support_transactions</span><span class=\"p\">():</span>\n            <span class=\"k\">return</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">cls_atomics</span> <span class=\"o\">=</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_enter_atomics</span><span class=\"p\">()</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">fixtures</span><span class=\"p\">:</span>\n            <span class=\"k\">for</span> <span class=\"n\">db_name</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_databases_names</span><span class=\"p\">(</span><span class=\"n\">include_mirrors</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n                <span class=\"k\">try</span><span class=\"p\">:</span>\n                    <span class=\"n\">call_command</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;loaddata&quot;</span><span class=\"p\">,</span>\n                        <span class=\"o\">*</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">fixtures</span><span class=\"p\">,</span>\n                        <span class=\"o\">**</span><span class=\"p\">{</span><span class=\"s2\">&quot;verbosity&quot;</span><span class=\"p\">:</span> <span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"s2\">&quot;database&quot;</span><span class=\"p\">:</span> <span class=\"n\">db_name</span><span class=\"p\">},</span>\n                    <span class=\"p\">)</span>\n                <span class=\"k\">except</span> <span class=\"ne\">Exception</span><span class=\"p\">:</span>\n                    <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_rollback_atomics</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">cls_atomics</span><span class=\"p\">)</span>\n                    <span class=\"k\">raise</span>\n        <span class=\"n\">pre_attrs</span> <span class=\"o\">=</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"o\">.</span><span class=\"n\">copy</span><span class=\"p\">()</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">setUpTestData</span><span class=\"p\">()</span>\n        <span class=\"k\">except</span> <span class=\"ne\">Exception</span><span class=\"p\">:</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_rollback_atomics</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">cls_atomics</span><span class=\"p\">)</span>\n            <span class=\"k\">raise</span>\n        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">value</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"n\">pre_attrs</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n                <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">TestData</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">))</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">tearDownClass</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_databases_support_transactions</span><span class=\"p\">():</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_rollback_atomics</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">cls_atomics</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">conn</span> <span class=\"ow\">in</span> <span class=\"n\">connections</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">(</span><span class=\"n\">initialized_only</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n                <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">tearDownClass</span><span class=\"p\">()</span>\n\n<div class=\"viewcode-block\" id=\"TestCase.setUpTestData\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.TestCase.setUpTestData\">[docs]</a>    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">setUpTestData</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Load initial data for the TestCase.&quot;&quot;&quot;</span>\n        <span class=\"k\">pass</span></div>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_should_reload_connections</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_databases_support_transactions</span><span class=\"p\">():</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">_should_reload_connections</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_fixture_setup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_databases_support_transactions</span><span class=\"p\">():</span>\n            <span class=\"c1\"># If the backend does not support transactions, we should reload</span>\n            <span class=\"c1\"># class data before each test</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">setUpTestData</span><span class=\"p\">()</span>\n            <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">_fixture_setup</span><span class=\"p\">()</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reset_sequences</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;reset_sequences cannot be used on TestCase instances&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">atomics</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_enter_atomics</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_fixture_teardown</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_databases_support_transactions</span><span class=\"p\">():</span>\n            <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">_fixture_teardown</span><span class=\"p\">()</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">for</span> <span class=\"n\">db_name</span> <span class=\"ow\">in</span> <span class=\"nb\">reversed</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_databases_names</span><span class=\"p\">()):</span>\n                <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_should_check_constraints</span><span class=\"p\">(</span><span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">]):</span>\n                    <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">db_name</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">check_constraints</span><span class=\"p\">()</span>\n        <span class=\"k\">finally</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_rollback_atomics</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">atomics</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_should_check_constraints</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">can_defer_constraint_checks</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">needs_rollback</span>\n            <span class=\"ow\">and</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">is_usable</span><span class=\"p\">()</span>\n        <span class=\"p\">)</span>\n\n<div class=\"viewcode-block\" id=\"TestCase.captureOnCommitCallbacks\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.TestCase.captureOnCommitCallbacks\">[docs]</a>    <span class=\"nd\">@classmethod</span>\n    <span class=\"nd\">@contextmanager</span>\n    <span class=\"k\">def</span> <span class=\"nf\">captureOnCommitCallbacks</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">DEFAULT_DB_ALIAS</span><span class=\"p\">,</span> <span class=\"n\">execute</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Context manager to capture transaction.on_commit() callbacks.&quot;&quot;&quot;</span>\n        <span class=\"n\">callbacks</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"n\">start_count</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">using</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">run_on_commit</span><span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">yield</span> <span class=\"n\">callbacks</span>\n        <span class=\"k\">finally</span><span class=\"p\">:</span>\n            <span class=\"k\">while</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n                <span class=\"n\">callback_count</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">using</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">run_on_commit</span><span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">_</span><span class=\"p\">,</span> <span class=\"n\">callback</span><span class=\"p\">,</span> <span class=\"n\">robust</span> <span class=\"ow\">in</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">using</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">run_on_commit</span><span class=\"p\">[</span>\n                    <span class=\"n\">start_count</span><span class=\"p\">:</span>\n                <span class=\"p\">]:</span>\n                    <span class=\"n\">callbacks</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">callback</span><span class=\"p\">)</span>\n                    <span class=\"k\">if</span> <span class=\"n\">execute</span><span class=\"p\">:</span>\n                        <span class=\"k\">if</span> <span class=\"n\">robust</span><span class=\"p\">:</span>\n                            <span class=\"k\">try</span><span class=\"p\">:</span>\n                                <span class=\"n\">callback</span><span class=\"p\">()</span>\n                            <span class=\"k\">except</span> <span class=\"ne\">Exception</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n                                <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">(</span>\n                                    <span class=\"sa\">f</span><span class=\"s2\">&quot;Error calling </span><span class=\"si\">{</span><span class=\"n\">callback</span><span class=\"o\">.</span><span class=\"vm\">__qualname__</span><span class=\"si\">}</span><span class=\"s2\"> in &quot;</span>\n                                    <span class=\"sa\">f</span><span class=\"s2\">&quot;on_commit() (%s).&quot;</span><span class=\"p\">,</span>\n                                    <span class=\"n\">e</span><span class=\"p\">,</span>\n                                    <span class=\"n\">exc_info</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                                <span class=\"p\">)</span>\n                        <span class=\"k\">else</span><span class=\"p\">:</span>\n                            <span class=\"n\">callback</span><span class=\"p\">()</span>\n\n                <span class=\"k\">if</span> <span class=\"n\">callback_count</span> <span class=\"o\">==</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">using</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">run_on_commit</span><span class=\"p\">):</span>\n                    <span class=\"k\">break</span>\n                <span class=\"n\">start_count</span> <span class=\"o\">=</span> <span class=\"n\">callback_count</span></div></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">CheckCondition</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;Descriptor class for deferred condition checking.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">conditions</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">conditions</span> <span class=\"o\">=</span> <span class=\"n\">conditions</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_condition</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">condition</span><span class=\"p\">,</span> <span class=\"n\">reason</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">conditions</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"n\">condition</span><span class=\"p\">,</span> <span class=\"n\">reason</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__get__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Trigger access for all bases.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">any</span><span class=\"p\">(</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">base</span><span class=\"p\">,</span> <span class=\"s2\">&quot;__unittest_skip__&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">base</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__bases__</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">True</span>\n        <span class=\"k\">for</span> <span class=\"n\">condition</span><span class=\"p\">,</span> <span class=\"n\">reason</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">conditions</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">condition</span><span class=\"p\">():</span>\n                <span class=\"c1\"># Override this descriptor&#39;s value and set the skip reason.</span>\n                <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">__unittest_skip__</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n                <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">__unittest_skip_why__</span> <span class=\"o\">=</span> <span class=\"n\">reason</span>\n                <span class=\"k\">return</span> <span class=\"kc\">True</span>\n        <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_deferredSkip</span><span class=\"p\">(</span><span class=\"n\">condition</span><span class=\"p\">,</span> <span class=\"n\">reason</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">decorator</span><span class=\"p\">(</span><span class=\"n\">test_func</span><span class=\"p\">):</span>\n        <span class=\"k\">nonlocal</span> <span class=\"n\">condition</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span>\n            <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">test_func</span><span class=\"p\">,</span> <span class=\"nb\">type</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"nb\">issubclass</span><span class=\"p\">(</span><span class=\"n\">test_func</span><span class=\"p\">,</span> <span class=\"n\">unittest</span><span class=\"o\">.</span><span class=\"n\">TestCase</span><span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n\n            <span class=\"nd\">@wraps</span><span class=\"p\">(</span><span class=\"n\">test_func</span><span class=\"p\">)</span>\n            <span class=\"k\">def</span> <span class=\"nf\">skip_wrapper</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span>\n                    <span class=\"n\">args</span>\n                    <span class=\"ow\">and</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span> <span class=\"n\">unittest</span><span class=\"o\">.</span><span class=\"n\">TestCase</span><span class=\"p\">)</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">alias</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span> <span class=\"s2\">&quot;databases&quot;</span><span class=\"p\">,</span> <span class=\"p\">{})</span>\n                <span class=\"p\">):</span>\n                    <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> cannot be used on </span><span class=\"si\">%s</span><span class=\"s2\"> as </span><span class=\"si\">%s</span><span class=\"s2\"> doesn&#39;t allow queries &quot;</span>\n                        <span class=\"s2\">&quot;against the </span><span class=\"si\">%r</span><span class=\"s2\"> database.&quot;</span>\n                        <span class=\"o\">%</span> <span class=\"p\">(</span>\n                            <span class=\"n\">name</span><span class=\"p\">,</span>\n                            <span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span>\n                            <span class=\"n\">args</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__qualname__</span><span class=\"p\">,</span>\n                            <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">,</span>\n                        <span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">condition</span><span class=\"p\">():</span>\n                    <span class=\"k\">raise</span> <span class=\"n\">unittest</span><span class=\"o\">.</span><span class=\"n\">SkipTest</span><span class=\"p\">(</span><span class=\"n\">reason</span><span class=\"p\">)</span>\n                <span class=\"k\">return</span> <span class=\"n\">test_func</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n            <span class=\"n\">test_item</span> <span class=\"o\">=</span> <span class=\"n\">skip_wrapper</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Assume a class is decorated</span>\n            <span class=\"n\">test_item</span> <span class=\"o\">=</span> <span class=\"n\">test_func</span>\n            <span class=\"n\">databases</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">test_item</span><span class=\"p\">,</span> <span class=\"s2\">&quot;databases&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">databases</span> <span class=\"ow\">or</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">alias</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">databases</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Defer raising to allow importing test class&#39;s module.</span>\n                <span class=\"k\">def</span> <span class=\"nf\">condition</span><span class=\"p\">():</span>\n                    <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> cannot be used on </span><span class=\"si\">%s</span><span class=\"s2\"> as it doesn&#39;t allow queries &quot;</span>\n                        <span class=\"s2\">&quot;against the &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; database.&quot;</span>\n                        <span class=\"o\">%</span> <span class=\"p\">(</span>\n                            <span class=\"n\">name</span><span class=\"p\">,</span>\n                            <span class=\"n\">test_item</span><span class=\"p\">,</span>\n                            <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">,</span>\n                        <span class=\"p\">)</span>\n                    <span class=\"p\">)</span>\n\n            <span class=\"c1\"># Retrieve the possibly existing value from the class&#39;s dict to</span>\n            <span class=\"c1\"># avoid triggering the descriptor.</span>\n            <span class=\"n\">skip</span> <span class=\"o\">=</span> <span class=\"n\">test_func</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;__unittest_skip__&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">skip</span><span class=\"p\">,</span> <span class=\"n\">CheckCondition</span><span class=\"p\">):</span>\n                <span class=\"n\">test_item</span><span class=\"o\">.</span><span class=\"n\">__unittest_skip__</span> <span class=\"o\">=</span> <span class=\"n\">skip</span><span class=\"o\">.</span><span class=\"n\">add_condition</span><span class=\"p\">(</span><span class=\"n\">condition</span><span class=\"p\">,</span> <span class=\"n\">reason</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"n\">skip</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n                <span class=\"n\">test_item</span><span class=\"o\">.</span><span class=\"n\">__unittest_skip__</span> <span class=\"o\">=</span> <span class=\"n\">CheckCondition</span><span class=\"p\">((</span><span class=\"n\">condition</span><span class=\"p\">,</span> <span class=\"n\">reason</span><span class=\"p\">))</span>\n        <span class=\"k\">return</span> <span class=\"n\">test_item</span>\n\n    <span class=\"k\">return</span> <span class=\"n\">decorator</span>\n\n\n<div class=\"viewcode-block\" id=\"skipIfDBFeature\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.skipIfDBFeature\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">skipIfDBFeature</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">features</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Skip a test if a database has at least one of the named features.&quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">_deferredSkip</span><span class=\"p\">(</span>\n        <span class=\"k\">lambda</span><span class=\"p\">:</span> <span class=\"nb\">any</span><span class=\"p\">(</span>\n            <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"p\">,</span> <span class=\"n\">feature</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">feature</span> <span class=\"ow\">in</span> <span class=\"n\">features</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;Database has feature(s) </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">features</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;skipIfDBFeature&quot;</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span></div>\n\n\n<div class=\"viewcode-block\" id=\"skipUnlessDBFeature\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.skipUnlessDBFeature\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">skipUnlessDBFeature</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">features</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Skip a test unless a database has all the named features.&quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">_deferredSkip</span><span class=\"p\">(</span>\n        <span class=\"k\">lambda</span><span class=\"p\">:</span> <span class=\"ow\">not</span> <span class=\"nb\">all</span><span class=\"p\">(</span>\n            <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"p\">,</span> <span class=\"n\">feature</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">feature</span> <span class=\"ow\">in</span> <span class=\"n\">features</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;Database doesn&#39;t support feature(s): </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">features</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;skipUnlessDBFeature&quot;</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">skipUnlessAnyDBFeature</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">features</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Skip a test unless a database has any of the named features.&quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">_deferredSkip</span><span class=\"p\">(</span>\n        <span class=\"k\">lambda</span><span class=\"p\">:</span> <span class=\"ow\">not</span> <span class=\"nb\">any</span><span class=\"p\">(</span>\n            <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"p\">,</span> <span class=\"n\">feature</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">feature</span> <span class=\"ow\">in</span> <span class=\"n\">features</span>\n        <span class=\"p\">),</span>\n        <span class=\"s2\">&quot;Database doesn&#39;t support any of the feature(s): </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">features</span><span class=\"p\">),</span>\n        <span class=\"s2\">&quot;skipUnlessAnyDBFeature&quot;</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">QuietWSGIRequestHandler</span><span class=\"p\">(</span><span class=\"n\">WSGIRequestHandler</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    A WSGIRequestHandler that doesn&#39;t log to standard output any of the</span>\n<span class=\"sd\">    requests received, so as to not clutter the test result output.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">log_message</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">):</span>\n        <span class=\"k\">pass</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">FSFilesHandler</span><span class=\"p\">(</span><span class=\"n\">WSGIHandler</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    WSGI middleware that intercepts calls to a directory, as defined by one of</span>\n<span class=\"sd\">    the *_ROOT settings, and serves those files, publishing them under *_URL.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">application</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">application</span> <span class=\"o\">=</span> <span class=\"n\">application</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">base_url</span> <span class=\"o\">=</span> <span class=\"n\">urlparse</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_base_url</span><span class=\"p\">())</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_should_handle</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">path</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Check if the path should be handled. Ignore the path if:</span>\n<span class=\"sd\">        * the host is provided as part of the base_url</span>\n<span class=\"sd\">        * the request&#39;s path isn&#39;t under the media path (or equal)</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">startswith</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">base_url</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">])</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">base_url</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">file_path</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">url</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return the relative path to the file on disk for the given URL.&quot;&quot;&quot;</span>\n        <span class=\"n\">relative_url</span> <span class=\"o\">=</span> <span class=\"n\">url</span><span class=\"o\">.</span><span class=\"n\">removeprefix</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">base_url</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">])</span>\n        <span class=\"k\">return</span> <span class=\"n\">url2pathname</span><span class=\"p\">(</span><span class=\"n\">relative_url</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_response</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.http</span> <span class=\"kn\">import</span> <span class=\"n\">Http404</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_should_handle</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"p\">):</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">serve</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">Http404</span><span class=\"p\">:</span>\n                <span class=\"k\">pass</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_response</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">serve</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">request</span><span class=\"p\">):</span>\n        <span class=\"n\">os_rel_path</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">file_path</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"o\">.</span><span class=\"n\">path</span><span class=\"p\">)</span>\n        <span class=\"n\">os_rel_path</span> <span class=\"o\">=</span> <span class=\"n\">posixpath</span><span class=\"o\">.</span><span class=\"n\">normpath</span><span class=\"p\">(</span><span class=\"n\">unquote</span><span class=\"p\">(</span><span class=\"n\">os_rel_path</span><span class=\"p\">))</span>\n        <span class=\"c1\"># Emulate behavior of django.contrib.staticfiles.views.serve() when it</span>\n        <span class=\"c1\"># invokes staticfiles&#39; finders functionality.</span>\n        <span class=\"c1\"># TODO: Modify if/when that internal API is refactored</span>\n        <span class=\"n\">final_rel_path</span> <span class=\"o\">=</span> <span class=\"n\">os_rel_path</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\\\</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;/&quot;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">lstrip</span><span class=\"p\">(</span><span class=\"s2\">&quot;/&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">serve</span><span class=\"p\">(</span><span class=\"n\">request</span><span class=\"p\">,</span> <span class=\"n\">final_rel_path</span><span class=\"p\">,</span> <span class=\"n\">document_root</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_base_dir</span><span class=\"p\">())</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">environ</span><span class=\"p\">,</span> <span class=\"n\">start_response</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_should_handle</span><span class=\"p\">(</span><span class=\"n\">get_path_info</span><span class=\"p\">(</span><span class=\"n\">environ</span><span class=\"p\">)):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">application</span><span class=\"p\">(</span><span class=\"n\">environ</span><span class=\"p\">,</span> <span class=\"n\">start_response</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__call__</span><span class=\"p\">(</span><span class=\"n\">environ</span><span class=\"p\">,</span> <span class=\"n\">start_response</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">_StaticFilesHandler</span><span class=\"p\">(</span><span class=\"n\">FSFilesHandler</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Handler for serving static files. A private class that is meant to be used</span>\n<span class=\"sd\">    solely as a convenience by LiveServerThread.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_base_dir</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">STATIC_ROOT</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_base_url</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">STATIC_URL</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">_MediaFilesHandler</span><span class=\"p\">(</span><span class=\"n\">FSFilesHandler</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Handler for serving the media files. A private class that is meant to be</span>\n<span class=\"sd\">    used solely as a convenience by LiveServerThread.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_base_dir</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_ROOT</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_base_url</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">MEDIA_URL</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">LiveServerThread</span><span class=\"p\">(</span><span class=\"n\">threading</span><span class=\"o\">.</span><span class=\"n\">Thread</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Thread for running a live HTTP server while the tests are running.&quot;&quot;&quot;</span>\n\n    <span class=\"n\">server_class</span> <span class=\"o\">=</span> <span class=\"n\">ThreadedWSGIServer</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"n\">static_handler</span><span class=\"p\">,</span> <span class=\"n\">connections_override</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">port</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host</span> <span class=\"o\">=</span> <span class=\"n\">host</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">port</span> <span class=\"o\">=</span> <span class=\"n\">port</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">is_ready</span> <span class=\"o\">=</span> <span class=\"n\">threading</span><span class=\"o\">.</span><span class=\"n\">Event</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">static_handler</span> <span class=\"o\">=</span> <span class=\"n\">static_handler</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connections_override</span> <span class=\"o\">=</span> <span class=\"n\">connections_override</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">run</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Set up the live server and databases, and then loop over handling</span>\n<span class=\"sd\">        HTTP requests.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connections_override</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Override this thread&#39;s database connections with the ones</span>\n            <span class=\"c1\"># provided by the main thread.</span>\n            <span class=\"k\">for</span> <span class=\"n\">alias</span><span class=\"p\">,</span> <span class=\"n\">conn</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connections_override</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n                <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">alias</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">conn</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Create the handler for serving static and media files</span>\n            <span class=\"n\">handler</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">static_handler</span><span class=\"p\">(</span><span class=\"n\">_MediaFilesHandler</span><span class=\"p\">(</span><span class=\"n\">WSGIHandler</span><span class=\"p\">()))</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">httpd</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_create_server</span><span class=\"p\">(</span>\n                <span class=\"n\">connections_override</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connections_override</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n            <span class=\"c1\"># If binding to port zero, assign the port allocated by the OS.</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">port</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">port</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">httpd</span><span class=\"o\">.</span><span class=\"n\">server_address</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">httpd</span><span class=\"o\">.</span><span class=\"n\">set_app</span><span class=\"p\">(</span><span class=\"n\">handler</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">is_ready</span><span class=\"o\">.</span><span class=\"n\">set</span><span class=\"p\">()</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">httpd</span><span class=\"o\">.</span><span class=\"n\">serve_forever</span><span class=\"p\">()</span>\n        <span class=\"k\">except</span> <span class=\"ne\">Exception</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">error</span> <span class=\"o\">=</span> <span class=\"n\">e</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">is_ready</span><span class=\"o\">.</span><span class=\"n\">set</span><span class=\"p\">()</span>\n        <span class=\"k\">finally</span><span class=\"p\">:</span>\n            <span class=\"n\">connections</span><span class=\"o\">.</span><span class=\"n\">close_all</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_create_server</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">connections_override</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">server_class</span><span class=\"p\">(</span>\n            <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">port</span><span class=\"p\">),</span>\n            <span class=\"n\">QuietWSGIRequestHandler</span><span class=\"p\">,</span>\n            <span class=\"n\">allow_reuse_address</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n            <span class=\"n\">connections_override</span><span class=\"o\">=</span><span class=\"n\">connections_override</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">terminate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"s2\">&quot;httpd&quot;</span><span class=\"p\">):</span>\n            <span class=\"c1\"># Stop the WSGI server</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">httpd</span><span class=\"o\">.</span><span class=\"n\">shutdown</span><span class=\"p\">()</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">httpd</span><span class=\"o\">.</span><span class=\"n\">server_close</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">()</span>\n\n\n<div class=\"viewcode-block\" id=\"LiveServerTestCase\"><a class=\"viewcode-back\" href=\"../../../../topics/testing/tools/#django.test.LiveServerTestCase\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">LiveServerTestCase</span><span class=\"p\">(</span><span class=\"n\">TransactionTestCase</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Do basically the same as TransactionTestCase but also launch a live HTTP</span>\n<span class=\"sd\">    server in a separate thread so that the tests may use another testing</span>\n<span class=\"sd\">    framework, such as Selenium for example, instead of the built-in dummy</span>\n<span class=\"sd\">    client.</span>\n<span class=\"sd\">    It inherits from TransactionTestCase instead of TestCase because the</span>\n<span class=\"sd\">    threads don&#39;t share the same transactions (unless if using in-memory sqlite)</span>\n<span class=\"sd\">    and each thread needs to commit all their transactions so that the other</span>\n<span class=\"sd\">    thread can see the changes.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">host</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;localhost&quot;</span>\n    <span class=\"n\">port</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n    <span class=\"n\">server_thread_class</span> <span class=\"o\">=</span> <span class=\"n\">LiveServerThread</span>\n    <span class=\"n\">static_handler</span> <span class=\"o\">=</span> <span class=\"n\">_StaticFilesHandler</span>\n\n    <span class=\"nd\">@classproperty</span>\n    <span class=\"k\">def</span> <span class=\"nf\">live_server_url</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;http://</span><span class=\"si\">%s</span><span class=\"s2\">:</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">host</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread</span><span class=\"o\">.</span><span class=\"n\">port</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@classproperty</span>\n    <span class=\"k\">def</span> <span class=\"nf\">allowed_host</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">host</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_make_connections_override</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"n\">connections_override</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">for</span> <span class=\"n\">conn</span> <span class=\"ow\">in</span> <span class=\"n\">connections</span><span class=\"o\">.</span><span class=\"n\">all</span><span class=\"p\">():</span>\n            <span class=\"c1\"># If using in-memory sqlite databases, pass the connections to</span>\n            <span class=\"c1\"># the server thread.</span>\n            <span class=\"k\">if</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">vendor</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;sqlite&quot;</span> <span class=\"ow\">and</span> <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">is_in_memory_db</span><span class=\"p\">():</span>\n                <span class=\"n\">connections_override</span><span class=\"p\">[</span><span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">alias</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">conn</span>\n        <span class=\"k\">return</span> <span class=\"n\">connections_override</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">setUpClass</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">setUpClass</span><span class=\"p\">()</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_live_server_modified_settings</span> <span class=\"o\">=</span> <span class=\"n\">modify_settings</span><span class=\"p\">(</span>\n            <span class=\"n\">ALLOWED_HOSTS</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s2\">&quot;append&quot;</span><span class=\"p\">:</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">allowed_host</span><span class=\"p\">},</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_live_server_modified_settings</span><span class=\"o\">.</span><span class=\"n\">enable</span><span class=\"p\">()</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">addClassCleanup</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_live_server_modified_settings</span><span class=\"o\">.</span><span class=\"n\">disable</span><span class=\"p\">)</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_start_server_thread</span><span class=\"p\">()</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_start_server_thread</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"n\">connections_override</span> <span class=\"o\">=</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_make_connections_override</span><span class=\"p\">()</span>\n        <span class=\"k\">for</span> <span class=\"n\">conn</span> <span class=\"ow\">in</span> <span class=\"n\">connections_override</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">():</span>\n            <span class=\"c1\"># Explicitly enable thread-shareability for this connection.</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">inc_thread_sharing</span><span class=\"p\">()</span>\n\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread</span> <span class=\"o\">=</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_create_server_thread</span><span class=\"p\">(</span><span class=\"n\">connections_override</span><span class=\"p\">)</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread</span><span class=\"o\">.</span><span class=\"n\">daemon</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread</span><span class=\"o\">.</span><span class=\"n\">start</span><span class=\"p\">()</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">addClassCleanup</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_terminate_thread</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Wait for the live server to be ready</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread</span><span class=\"o\">.</span><span class=\"n\">is_ready</span><span class=\"o\">.</span><span class=\"n\">wait</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread</span><span class=\"o\">.</span><span class=\"n\">error</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread</span><span class=\"o\">.</span><span class=\"n\">error</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_create_server_thread</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">connections_override</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread_class</span><span class=\"p\">(</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">host</span><span class=\"p\">,</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">static_handler</span><span class=\"p\">,</span>\n            <span class=\"n\">connections_override</span><span class=\"o\">=</span><span class=\"n\">connections_override</span><span class=\"p\">,</span>\n            <span class=\"n\">port</span><span class=\"o\">=</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">port</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_terminate_thread</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Terminate the live server&#39;s thread.</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread</span><span class=\"o\">.</span><span class=\"n\">terminate</span><span class=\"p\">()</span>\n        <span class=\"c1\"># Restore shared connections&#39; non-shareability.</span>\n        <span class=\"k\">for</span> <span class=\"n\">conn</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">server_thread</span><span class=\"o\">.</span><span class=\"n\">connections_override</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">():</span>\n            <span class=\"n\">conn</span><span class=\"o\">.</span><span class=\"n\">dec_thread_sharing</span><span class=\"p\">()</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">SerializeMixin</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Enforce serialization of TestCases that share a common resource.</span>\n\n<span class=\"sd\">    Define a common &#39;lockfile&#39; for each set of TestCases to serialize. This</span>\n<span class=\"sd\">    file must exist on the filesystem.</span>\n\n<span class=\"sd\">    Place it early in the MRO in order to isolate setUpClass()/tearDownClass().</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"n\">lockfile</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__init_subclass__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"o\">/</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">__init_subclass__</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">lockfile</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;</span><span class=\"si\">{}</span><span class=\"s2\">.lockfile isn&#39;t set. Set it to a unique value &quot;</span>\n                <span class=\"s2\">&quot;in the base class.&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">setUpClass</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_lockfile</span> <span class=\"o\">=</span> <span class=\"nb\">open</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">lockfile</span><span class=\"p\">)</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">addClassCleanup</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_lockfile</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">)</span>\n        <span class=\"n\">locks</span><span class=\"o\">.</span><span class=\"n\">lock</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_lockfile</span><span class=\"p\">,</span> <span class=\"n\">locks</span><span class=\"o\">.</span><span class=\"n\">LOCK_EX</span><span class=\"p\">)</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">setUpClass</span><span class=\"p\">()</span>\n</pre></div>", "current_page_name": "_modules/django/test/testcases", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}
