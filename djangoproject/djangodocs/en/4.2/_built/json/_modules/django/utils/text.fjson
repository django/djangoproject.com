{"parents": [{"link": "../../../", "title": "Module code"}, {"link": "../../", "title": "django"}], "title": "django.utils.text", "body": "<h1>Source code for django.utils.text</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"kn\">import</span> <span class=\"nn\">gzip</span>\n<span class=\"kn\">import</span> <span class=\"nn\">re</span>\n<span class=\"kn\">import</span> <span class=\"nn\">secrets</span>\n<span class=\"kn\">import</span> <span class=\"nn\">unicodedata</span>\n<span class=\"kn\">from</span> <span class=\"nn\">gzip</span> <span class=\"kn\">import</span> <span class=\"n\">GzipFile</span>\n<span class=\"kn\">from</span> <span class=\"nn\">gzip</span> <span class=\"kn\">import</span> <span class=\"n\">compress</span> <span class=\"k\">as</span> <span class=\"n\">gzip_compress</span>\n<span class=\"kn\">from</span> <span class=\"nn\">io</span> <span class=\"kn\">import</span> <span class=\"n\">BytesIO</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.exceptions</span> <span class=\"kn\">import</span> <span class=\"n\">SuspiciousFileOperation</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.functional</span> <span class=\"kn\">import</span> <span class=\"n\">SimpleLazyObject</span><span class=\"p\">,</span> <span class=\"n\">keep_lazy_text</span><span class=\"p\">,</span> <span class=\"n\">lazy</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.regex_helper</span> <span class=\"kn\">import</span> <span class=\"n\">_lazy_re_compile</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.translation</span> <span class=\"kn\">import</span> <span class=\"n\">gettext</span> <span class=\"k\">as</span> <span class=\"n\">_</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.translation</span> <span class=\"kn\">import</span> <span class=\"n\">gettext_lazy</span><span class=\"p\">,</span> <span class=\"n\">pgettext</span>\n\n\n<span class=\"nd\">@keep_lazy_text</span>\n<span class=\"k\">def</span> <span class=\"nf\">capfirst</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Capitalize the first letter of a string.&quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">x</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">x</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">):</span>\n        <span class=\"n\">x</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">x</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">upper</span><span class=\"p\">()</span> <span class=\"o\">+</span> <span class=\"n\">x</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:]</span>\n\n\n<span class=\"c1\"># Set up regular expressions</span>\n<span class=\"n\">re_words</span> <span class=\"o\">=</span> <span class=\"n\">_lazy_re_compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;&lt;[^&gt;]+?&gt;|([^&lt;&gt;\\s]+)&quot;</span><span class=\"p\">,</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">S</span><span class=\"p\">)</span>\n<span class=\"n\">re_chars</span> <span class=\"o\">=</span> <span class=\"n\">_lazy_re_compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;&lt;[^&gt;]+?&gt;|(.)&quot;</span><span class=\"p\">,</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">S</span><span class=\"p\">)</span>\n<span class=\"n\">re_tag</span> <span class=\"o\">=</span> <span class=\"n\">_lazy_re_compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;&lt;(/)?(\\S+?)(?:(\\s*/)|\\s.*?)?&gt;&quot;</span><span class=\"p\">,</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">S</span><span class=\"p\">)</span>\n<span class=\"n\">re_newlines</span> <span class=\"o\">=</span> <span class=\"n\">_lazy_re_compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;\\r\\n|\\r&quot;</span><span class=\"p\">)</span>  <span class=\"c1\"># Used in normalize_newlines</span>\n<span class=\"n\">re_camel_case</span> <span class=\"o\">=</span> <span class=\"n\">_lazy_re_compile</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;(((?&lt;=[a-z])[A-Z])|([A-Z](?![A-Z]|$)))&quot;</span><span class=\"p\">)</span>\n\n\n<span class=\"nd\">@keep_lazy_text</span>\n<span class=\"k\">def</span> <span class=\"nf\">wrap</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">width</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    A word-wrap function that preserves existing line breaks. Expects that</span>\n<span class=\"sd\">    existing line breaks are posix newlines.</span>\n\n<span class=\"sd\">    Preserve all white space except added line breaks consume the space on</span>\n<span class=\"sd\">    which they break the line.</span>\n\n<span class=\"sd\">    Don&#39;t wrap long words, thus the output text may have lines longer than</span>\n<span class=\"sd\">    ``width``.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_generator</span><span class=\"p\">():</span>\n        <span class=\"k\">for</span> <span class=\"n\">line</span> <span class=\"ow\">in</span> <span class=\"n\">text</span><span class=\"o\">.</span><span class=\"n\">splitlines</span><span class=\"p\">(</span><span class=\"kc\">True</span><span class=\"p\">):</span>  <span class=\"c1\"># True keeps trailing linebreaks</span>\n            <span class=\"n\">max_width</span> <span class=\"o\">=</span> <span class=\"nb\">min</span><span class=\"p\">((</span><span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">endswith</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">width</span> <span class=\"o\">+</span> <span class=\"mi\">1</span> <span class=\"ow\">or</span> <span class=\"n\">width</span><span class=\"p\">),</span> <span class=\"n\">width</span><span class=\"p\">)</span>\n            <span class=\"k\">while</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">line</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"n\">max_width</span><span class=\"p\">:</span>\n                <span class=\"n\">space</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"p\">[:</span> <span class=\"n\">max_width</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">rfind</span><span class=\"p\">(</span><span class=\"s2\">&quot; &quot;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"mi\">1</span>\n                <span class=\"k\">if</span> <span class=\"n\">space</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                    <span class=\"n\">space</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">find</span><span class=\"p\">(</span><span class=\"s2\">&quot; &quot;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"mi\">1</span>\n                    <span class=\"k\">if</span> <span class=\"n\">space</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                        <span class=\"k\">yield</span> <span class=\"n\">line</span>\n                        <span class=\"n\">line</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;&quot;</span>\n                        <span class=\"k\">break</span>\n                <span class=\"k\">yield</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">line</span><span class=\"p\">[:</span> <span class=\"n\">space</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">]</span>\n                <span class=\"n\">line</span> <span class=\"o\">=</span> <span class=\"n\">line</span><span class=\"p\">[</span><span class=\"n\">space</span><span class=\"p\">:]</span>\n                <span class=\"n\">max_width</span> <span class=\"o\">=</span> <span class=\"nb\">min</span><span class=\"p\">((</span><span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">endswith</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">width</span> <span class=\"o\">+</span> <span class=\"mi\">1</span> <span class=\"ow\">or</span> <span class=\"n\">width</span><span class=\"p\">),</span> <span class=\"n\">width</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">line</span><span class=\"p\">:</span>\n                <span class=\"k\">yield</span> <span class=\"n\">line</span>\n\n    <span class=\"k\">return</span> <span class=\"s2\">&quot;&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">_generator</span><span class=\"p\">())</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">Truncator</span><span class=\"p\">(</span><span class=\"n\">SimpleLazyObject</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    An object used to truncate text, either by characters or words.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"k\">lambda</span><span class=\"p\">:</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_truncation_text</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">truncate</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">truncate</span> <span class=\"o\">=</span> <span class=\"n\">pgettext</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;String to return when truncating text&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;</span><span class=\"si\">%(truncated_text)s</span><span class=\"s2\">\u2026&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"s2\">&quot;</span><span class=\"si\">%(truncated_text)s</span><span class=\"s2\">&quot;</span> <span class=\"ow\">in</span> <span class=\"n\">truncate</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">truncate</span> <span class=\"o\">%</span> <span class=\"p\">{</span><span class=\"s2\">&quot;truncated_text&quot;</span><span class=\"p\">:</span> <span class=\"n\">text</span><span class=\"p\">}</span>\n        <span class=\"c1\"># The truncation text didn&#39;t contain the %(truncated_text)s string</span>\n        <span class=\"c1\"># replacement argument so just append it to the text.</span>\n        <span class=\"k\">if</span> <span class=\"n\">text</span><span class=\"o\">.</span><span class=\"n\">endswith</span><span class=\"p\">(</span><span class=\"n\">truncate</span><span class=\"p\">):</span>\n            <span class=\"c1\"># But don&#39;t append the truncation text if the current text already</span>\n            <span class=\"c1\"># ends in this.</span>\n            <span class=\"k\">return</span> <span class=\"n\">text</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">chars</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">num</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">html</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return the text truncated to be no longer than the specified number</span>\n<span class=\"sd\">        of characters.</span>\n\n<span class=\"sd\">        `truncate` specifies what should be used to notify that the string has</span>\n<span class=\"sd\">        been truncated, defaulting to a translatable string of an ellipsis.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_setup</span><span class=\"p\">()</span>\n        <span class=\"n\">length</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">num</span><span class=\"p\">)</span>\n        <span class=\"n\">text</span> <span class=\"o\">=</span> <span class=\"n\">unicodedata</span><span class=\"o\">.</span><span class=\"n\">normalize</span><span class=\"p\">(</span><span class=\"s2\">&quot;NFC&quot;</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_wrapped</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Calculate the length to truncate to (max length - end_text length)</span>\n        <span class=\"n\">truncate_len</span> <span class=\"o\">=</span> <span class=\"n\">length</span>\n        <span class=\"k\">for</span> <span class=\"n\">char</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">add_truncation_text</span><span class=\"p\">(</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">unicodedata</span><span class=\"o\">.</span><span class=\"n\">combining</span><span class=\"p\">(</span><span class=\"n\">char</span><span class=\"p\">):</span>\n                <span class=\"n\">truncate_len</span> <span class=\"o\">-=</span> <span class=\"mi\">1</span>\n                <span class=\"k\">if</span> <span class=\"n\">truncate_len</span> <span class=\"o\">==</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n                    <span class=\"k\">break</span>\n        <span class=\"k\">if</span> <span class=\"n\">html</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_truncate_html</span><span class=\"p\">(</span><span class=\"n\">length</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">truncate_len</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_text_chars</span><span class=\"p\">(</span><span class=\"n\">length</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">truncate_len</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_text_chars</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">length</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">truncate_len</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Truncate a string after a certain number of chars.&quot;&quot;&quot;</span>\n        <span class=\"n\">s_len</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"n\">end_index</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">for</span> <span class=\"n\">i</span><span class=\"p\">,</span> <span class=\"n\">char</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">):</span>\n            <span class=\"k\">if</span> <span class=\"n\">unicodedata</span><span class=\"o\">.</span><span class=\"n\">combining</span><span class=\"p\">(</span><span class=\"n\">char</span><span class=\"p\">):</span>\n                <span class=\"c1\"># Don&#39;t consider combining characters</span>\n                <span class=\"c1\"># as adding to the string length</span>\n                <span class=\"k\">continue</span>\n            <span class=\"n\">s_len</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n            <span class=\"k\">if</span> <span class=\"n\">end_index</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">s_len</span> <span class=\"o\">&gt;</span> <span class=\"n\">truncate_len</span><span class=\"p\">:</span>\n                <span class=\"n\">end_index</span> <span class=\"o\">=</span> <span class=\"n\">i</span>\n            <span class=\"k\">if</span> <span class=\"n\">s_len</span> <span class=\"o\">&gt;</span> <span class=\"n\">length</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Return the truncated string</span>\n                <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">add_truncation_text</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">[:</span> <span class=\"n\">end_index</span> <span class=\"ow\">or</span> <span class=\"mi\">0</span><span class=\"p\">],</span> <span class=\"n\">truncate</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Return the original string since no truncation was necessary</span>\n        <span class=\"k\">return</span> <span class=\"n\">text</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">words</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">num</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">html</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Truncate a string after a certain number of words. `truncate` specifies</span>\n<span class=\"sd\">        what should be used to notify that the string has been truncated,</span>\n<span class=\"sd\">        defaulting to ellipsis.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_setup</span><span class=\"p\">()</span>\n        <span class=\"n\">length</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">num</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">html</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_truncate_html</span><span class=\"p\">(</span><span class=\"n\">length</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_wrapped</span><span class=\"p\">,</span> <span class=\"n\">length</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_text_words</span><span class=\"p\">(</span><span class=\"n\">length</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_text_words</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">length</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Truncate a string after a certain number of words.</span>\n\n<span class=\"sd\">        Strip newlines in the string.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">words</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_wrapped</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">words</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"n\">length</span><span class=\"p\">:</span>\n            <span class=\"n\">words</span> <span class=\"o\">=</span> <span class=\"n\">words</span><span class=\"p\">[:</span><span class=\"n\">length</span><span class=\"p\">]</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">add_truncation_text</span><span class=\"p\">(</span><span class=\"s2\">&quot; &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">words</span><span class=\"p\">),</span> <span class=\"n\">truncate</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot; &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">words</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_truncate_html</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">length</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">,</span> <span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">truncate_len</span><span class=\"p\">,</span> <span class=\"n\">words</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Truncate HTML to a certain number of chars (not counting tags and</span>\n<span class=\"sd\">        comments), or, if words is True, then to a certain number of words.</span>\n<span class=\"sd\">        Close opened tags if they were correctly closed in the given HTML.</span>\n\n<span class=\"sd\">        Preserve newlines in the HTML.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">words</span> <span class=\"ow\">and</span> <span class=\"n\">length</span> <span class=\"o\">&lt;=</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"s2\">&quot;&quot;</span>\n\n        <span class=\"n\">html4_singlets</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"s2\">&quot;br&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;col&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;link&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;base&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;img&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;param&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;area&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;hr&quot;</span><span class=\"p\">,</span>\n            <span class=\"s2\">&quot;input&quot;</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n        <span class=\"c1\"># Count non-HTML chars/words and keep note of open tags</span>\n        <span class=\"n\">pos</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"n\">end_text_pos</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"n\">current_len</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"n\">open_tags</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n\n        <span class=\"n\">regex</span> <span class=\"o\">=</span> <span class=\"n\">re_words</span> <span class=\"k\">if</span> <span class=\"n\">words</span> <span class=\"k\">else</span> <span class=\"n\">re_chars</span>\n\n        <span class=\"k\">while</span> <span class=\"n\">current_len</span> <span class=\"o\">&lt;=</span> <span class=\"n\">length</span><span class=\"p\">:</span>\n            <span class=\"n\">m</span> <span class=\"o\">=</span> <span class=\"n\">regex</span><span class=\"o\">.</span><span class=\"n\">search</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">,</span> <span class=\"n\">pos</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">m</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Checked through whole string</span>\n                <span class=\"k\">break</span>\n            <span class=\"n\">pos</span> <span class=\"o\">=</span> <span class=\"n\">m</span><span class=\"o\">.</span><span class=\"n\">end</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">m</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]:</span>\n                <span class=\"c1\"># It&#39;s an actual non-HTML word or char</span>\n                <span class=\"n\">current_len</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n                <span class=\"k\">if</span> <span class=\"n\">current_len</span> <span class=\"o\">==</span> <span class=\"n\">truncate_len</span><span class=\"p\">:</span>\n                    <span class=\"n\">end_text_pos</span> <span class=\"o\">=</span> <span class=\"n\">pos</span>\n                <span class=\"k\">continue</span>\n            <span class=\"c1\"># Check for tag</span>\n            <span class=\"n\">tag</span> <span class=\"o\">=</span> <span class=\"n\">re_tag</span><span class=\"o\">.</span><span class=\"n\">match</span><span class=\"p\">(</span><span class=\"n\">m</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">tag</span> <span class=\"ow\">or</span> <span class=\"n\">current_len</span> <span class=\"o\">&gt;=</span> <span class=\"n\">truncate_len</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Don&#39;t worry about non tags or tags after our truncate point</span>\n                <span class=\"k\">continue</span>\n            <span class=\"n\">closing_tag</span><span class=\"p\">,</span> <span class=\"n\">tagname</span><span class=\"p\">,</span> <span class=\"n\">self_closing</span> <span class=\"o\">=</span> <span class=\"n\">tag</span><span class=\"o\">.</span><span class=\"n\">groups</span><span class=\"p\">()</span>\n            <span class=\"c1\"># Element names are always case-insensitive</span>\n            <span class=\"n\">tagname</span> <span class=\"o\">=</span> <span class=\"n\">tagname</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">()</span>\n            <span class=\"k\">if</span> <span class=\"n\">self_closing</span> <span class=\"ow\">or</span> <span class=\"n\">tagname</span> <span class=\"ow\">in</span> <span class=\"n\">html4_singlets</span><span class=\"p\">:</span>\n                <span class=\"k\">pass</span>\n            <span class=\"k\">elif</span> <span class=\"n\">closing_tag</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Check for match in open tags list</span>\n                <span class=\"k\">try</span><span class=\"p\">:</span>\n                    <span class=\"n\">i</span> <span class=\"o\">=</span> <span class=\"n\">open_tags</span><span class=\"o\">.</span><span class=\"n\">index</span><span class=\"p\">(</span><span class=\"n\">tagname</span><span class=\"p\">)</span>\n                <span class=\"k\">except</span> <span class=\"ne\">ValueError</span><span class=\"p\">:</span>\n                    <span class=\"k\">pass</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"c1\"># SGML: An end tag closes, back to the matching start tag,</span>\n                    <span class=\"c1\"># all unclosed intervening start tags with omitted end tags</span>\n                    <span class=\"n\">open_tags</span> <span class=\"o\">=</span> <span class=\"n\">open_tags</span><span class=\"p\">[</span><span class=\"n\">i</span> <span class=\"o\">+</span> <span class=\"mi\">1</span> <span class=\"p\">:]</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Add it to the start of the open tags list</span>\n                <span class=\"n\">open_tags</span><span class=\"o\">.</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"n\">tagname</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">current_len</span> <span class=\"o\">&lt;=</span> <span class=\"n\">length</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">text</span>\n        <span class=\"n\">out</span> <span class=\"o\">=</span> <span class=\"n\">text</span><span class=\"p\">[:</span><span class=\"n\">end_text_pos</span><span class=\"p\">]</span>\n        <span class=\"n\">truncate_text</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">add_truncation_text</span><span class=\"p\">(</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"n\">truncate</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">truncate_text</span><span class=\"p\">:</span>\n            <span class=\"n\">out</span> <span class=\"o\">+=</span> <span class=\"n\">truncate_text</span>\n        <span class=\"c1\"># Close any tags still open</span>\n        <span class=\"k\">for</span> <span class=\"n\">tag</span> <span class=\"ow\">in</span> <span class=\"n\">open_tags</span><span class=\"p\">:</span>\n            <span class=\"n\">out</span> <span class=\"o\">+=</span> <span class=\"s2\">&quot;&lt;/</span><span class=\"si\">%s</span><span class=\"s2\">&gt;&quot;</span> <span class=\"o\">%</span> <span class=\"n\">tag</span>\n        <span class=\"c1\"># Return string</span>\n        <span class=\"k\">return</span> <span class=\"n\">out</span>\n\n\n<span class=\"nd\">@keep_lazy_text</span>\n<span class=\"k\">def</span> <span class=\"nf\">get_valid_filename</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Return the given string converted to a string that can be used for a clean</span>\n<span class=\"sd\">    filename. Remove leading and trailing spaces; convert other spaces to</span>\n<span class=\"sd\">    underscores; and remove anything that is not an alphanumeric, dash,</span>\n<span class=\"sd\">    underscore, or dot.</span>\n<span class=\"sd\">    &gt;&gt;&gt; get_valid_filename(&quot;john&#39;s portrait in 2004.jpg&quot;)</span>\n<span class=\"sd\">    &#39;johns_portrait_in_2004.jpg&#39;</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">s</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">strip</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s2\">&quot; &quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_&quot;</span><span class=\"p\">)</span>\n    <span class=\"n\">s</span> <span class=\"o\">=</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">sub</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;(?u)[^-\\w.]&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"n\">s</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">s</span> <span class=\"ow\">in</span> <span class=\"p\">{</span><span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;.&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;..&quot;</span><span class=\"p\">}:</span>\n        <span class=\"k\">raise</span> <span class=\"n\">SuspiciousFileOperation</span><span class=\"p\">(</span><span class=\"s2\">&quot;Could not derive file name from &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;&quot;</span> <span class=\"o\">%</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">s</span>\n\n\n<span class=\"nd\">@keep_lazy_text</span>\n<span class=\"k\">def</span> <span class=\"nf\">get_text_list</span><span class=\"p\">(</span><span class=\"n\">list_</span><span class=\"p\">,</span> <span class=\"n\">last_word</span><span class=\"o\">=</span><span class=\"n\">gettext_lazy</span><span class=\"p\">(</span><span class=\"s2\">&quot;or&quot;</span><span class=\"p\">)):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    &gt;&gt;&gt; get_text_list([&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;])</span>\n<span class=\"sd\">    &#39;a, b, c or d&#39;</span>\n<span class=\"sd\">    &gt;&gt;&gt; get_text_list([&#39;a&#39;, &#39;b&#39;, &#39;c&#39;], &#39;and&#39;)</span>\n<span class=\"sd\">    &#39;a, b and c&#39;</span>\n<span class=\"sd\">    &gt;&gt;&gt; get_text_list([&#39;a&#39;, &#39;b&#39;], &#39;and&#39;)</span>\n<span class=\"sd\">    &#39;a and b&#39;</span>\n<span class=\"sd\">    &gt;&gt;&gt; get_text_list([&#39;a&#39;])</span>\n<span class=\"sd\">    &#39;a&#39;</span>\n<span class=\"sd\">    &gt;&gt;&gt; get_text_list([])</span>\n<span class=\"sd\">    &#39;&#39;</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">list_</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">list_</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">list_</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">])</span>\n    <span class=\"k\">return</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> </span><span class=\"si\">%s</span><span class=\"s2\"> </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span>\n        <span class=\"c1\"># Translators: This string is used as a separator between list elements</span>\n        <span class=\"n\">_</span><span class=\"p\">(</span><span class=\"s2\">&quot;, &quot;</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"n\">list_</span><span class=\"p\">[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]),</span>\n        <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">last_word</span><span class=\"p\">),</span>\n        <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">list_</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]),</span>\n    <span class=\"p\">)</span>\n\n\n<span class=\"nd\">@keep_lazy_text</span>\n<span class=\"k\">def</span> <span class=\"nf\">normalize_newlines</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Normalize CRLF and CR newlines to just LF.&quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">re_newlines</span><span class=\"o\">.</span><span class=\"n\">sub</span><span class=\"p\">(</span><span class=\"s2\">&quot;</span><span class=\"se\">\\n</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">))</span>\n\n\n<span class=\"nd\">@keep_lazy_text</span>\n<span class=\"k\">def</span> <span class=\"nf\">phone2numeric</span><span class=\"p\">(</span><span class=\"n\">phone</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Convert a phone number with letters into its numeric equivalent.&quot;&quot;&quot;</span>\n    <span class=\"n\">char2number</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n        <span class=\"s2\">&quot;a&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;2&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;b&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;2&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;c&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;2&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;d&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;3&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;e&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;3&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;f&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;3&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;g&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;4&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;h&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;4&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;i&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;4&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;j&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;5&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;k&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;5&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;l&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;5&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;m&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;6&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;n&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;6&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;o&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;6&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;p&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;7&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;q&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;7&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;r&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;7&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;s&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;7&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;t&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;8&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;u&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;8&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;v&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;8&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;w&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;9&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;x&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;9&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;y&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;9&quot;</span><span class=\"p\">,</span>\n        <span class=\"s2\">&quot;z&quot;</span><span class=\"p\">:</span> <span class=\"s2\">&quot;9&quot;</span><span class=\"p\">,</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"s2\">&quot;&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">char2number</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">,</span> <span class=\"n\">c</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"n\">phone</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">())</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_get_random_filename</span><span class=\"p\">(</span><span class=\"n\">max_random_bytes</span><span class=\"p\">):</span>\n    <span class=\"k\">return</span> <span class=\"sa\">b</span><span class=\"s2\">&quot;a&quot;</span> <span class=\"o\">*</span> <span class=\"n\">secrets</span><span class=\"o\">.</span><span class=\"n\">randbelow</span><span class=\"p\">(</span><span class=\"n\">max_random_bytes</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">compress_string</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"n\">max_random_bytes</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"n\">compressed_data</span> <span class=\"o\">=</span> <span class=\"n\">gzip_compress</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">,</span> <span class=\"n\">compresslevel</span><span class=\"o\">=</span><span class=\"mi\">6</span><span class=\"p\">,</span> <span class=\"n\">mtime</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">max_random_bytes</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"n\">compressed_data</span>\n\n    <span class=\"n\">compressed_view</span> <span class=\"o\">=</span> <span class=\"nb\">memoryview</span><span class=\"p\">(</span><span class=\"n\">compressed_data</span><span class=\"p\">)</span>\n    <span class=\"n\">header</span> <span class=\"o\">=</span> <span class=\"nb\">bytearray</span><span class=\"p\">(</span><span class=\"n\">compressed_view</span><span class=\"p\">[:</span><span class=\"mi\">10</span><span class=\"p\">])</span>\n    <span class=\"n\">header</span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">gzip</span><span class=\"o\">.</span><span class=\"n\">FNAME</span>\n\n    <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">_get_random_filename</span><span class=\"p\">(</span><span class=\"n\">max_random_bytes</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"sa\">b</span><span class=\"s2\">&quot;</span><span class=\"se\">\\x00</span><span class=\"s2\">&quot;</span>\n\n    <span class=\"k\">return</span> <span class=\"nb\">bytes</span><span class=\"p\">(</span><span class=\"n\">header</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"n\">filename</span> <span class=\"o\">+</span> <span class=\"n\">compressed_view</span><span class=\"p\">[</span><span class=\"mi\">10</span><span class=\"p\">:]</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">StreamingBuffer</span><span class=\"p\">(</span><span class=\"n\">BytesIO</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">read</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">ret</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">getvalue</span><span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">seek</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">truncate</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">ret</span>\n\n\n<span class=\"c1\"># Like compress_string, but for iterators of strings.</span>\n<span class=\"k\">def</span> <span class=\"nf\">compress_sequence</span><span class=\"p\">(</span><span class=\"n\">sequence</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"n\">max_random_bytes</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"n\">buf</span> <span class=\"o\">=</span> <span class=\"n\">StreamingBuffer</span><span class=\"p\">()</span>\n    <span class=\"n\">filename</span> <span class=\"o\">=</span> <span class=\"n\">_get_random_filename</span><span class=\"p\">(</span><span class=\"n\">max_random_bytes</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">max_random_bytes</span> <span class=\"k\">else</span> <span class=\"kc\">None</span>\n    <span class=\"k\">with</span> <span class=\"n\">GzipFile</span><span class=\"p\">(</span>\n        <span class=\"n\">filename</span><span class=\"o\">=</span><span class=\"n\">filename</span><span class=\"p\">,</span> <span class=\"n\">mode</span><span class=\"o\">=</span><span class=\"s2\">&quot;wb&quot;</span><span class=\"p\">,</span> <span class=\"n\">compresslevel</span><span class=\"o\">=</span><span class=\"mi\">6</span><span class=\"p\">,</span> <span class=\"n\">fileobj</span><span class=\"o\">=</span><span class=\"n\">buf</span><span class=\"p\">,</span> <span class=\"n\">mtime</span><span class=\"o\">=</span><span class=\"mi\">0</span>\n    <span class=\"p\">)</span> <span class=\"k\">as</span> <span class=\"n\">zfile</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Output headers...</span>\n        <span class=\"k\">yield</span> <span class=\"n\">buf</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">()</span>\n        <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"n\">sequence</span><span class=\"p\">:</span>\n            <span class=\"n\">zfile</span><span class=\"o\">.</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">item</span><span class=\"p\">)</span>\n            <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">buf</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">()</span>\n            <span class=\"k\">if</span> <span class=\"n\">data</span><span class=\"p\">:</span>\n                <span class=\"k\">yield</span> <span class=\"n\">data</span>\n    <span class=\"k\">yield</span> <span class=\"n\">buf</span><span class=\"o\">.</span><span class=\"n\">read</span><span class=\"p\">()</span>\n\n\n<span class=\"c1\"># Expression to match some_token and some_token=&quot;with spaces&quot; (and similarly</span>\n<span class=\"c1\"># for single-quoted strings).</span>\n<span class=\"n\">smart_split_re</span> <span class=\"o\">=</span> <span class=\"n\">_lazy_re_compile</span><span class=\"p\">(</span>\n    <span class=\"sa\">r</span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    ((?:</span>\n<span class=\"sd\">        [^\\s&#39;&quot;]*</span>\n<span class=\"sd\">        (?:</span>\n<span class=\"sd\">            (?:&quot;(?:[^&quot;\\\\]|\\\\.)*&quot; | &#39;(?:[^&#39;\\\\]|\\\\.)*&#39;)</span>\n<span class=\"sd\">            [^\\s&#39;&quot;]*</span>\n<span class=\"sd\">        )+</span>\n<span class=\"sd\">    ) | \\S+)</span>\n<span class=\"sd\">&quot;&quot;&quot;</span><span class=\"p\">,</span>\n    <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">VERBOSE</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">smart_split</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">):</span>\n    <span class=\"sa\">r</span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Generator that splits a string by spaces, leaving quoted phrases together.</span>\n<span class=\"sd\">    Supports both single and double quotes, and supports escaping quotes with</span>\n<span class=\"sd\">    backslashes. In the output, strings will keep their initial and trailing</span>\n<span class=\"sd\">    quote marks and escaped quotes will remain escaped (the results can then</span>\n<span class=\"sd\">    be further processed with unescape_string_literal()).</span>\n\n<span class=\"sd\">    &gt;&gt;&gt; list(smart_split(r&#39;This is &quot;a person\\&#39;s&quot; test.&#39;))</span>\n<span class=\"sd\">    [&#39;This&#39;, &#39;is&#39;, &#39;&quot;a person\\\\\\&#39;s&quot;&#39;, &#39;test.&#39;]</span>\n<span class=\"sd\">    &gt;&gt;&gt; list(smart_split(r&quot;Another &#39;person\\&#39;s&#39; test.&quot;))</span>\n<span class=\"sd\">    [&#39;Another&#39;, &quot;&#39;person\\\\&#39;s&#39;&quot;, &#39;test.&#39;]</span>\n<span class=\"sd\">    &gt;&gt;&gt; list(smart_split(r&#39;A &quot;\\&quot;funky\\&quot; style&quot; test.&#39;))</span>\n<span class=\"sd\">    [&#39;A&#39;, &#39;&quot;\\\\&quot;funky\\\\&quot; style&quot;&#39;, &#39;test.&#39;]</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">for</span> <span class=\"n\">bit</span> <span class=\"ow\">in</span> <span class=\"n\">smart_split_re</span><span class=\"o\">.</span><span class=\"n\">finditer</span><span class=\"p\">(</span><span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">text</span><span class=\"p\">)):</span>\n        <span class=\"k\">yield</span> <span class=\"n\">bit</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n\n<span class=\"nd\">@keep_lazy_text</span>\n<span class=\"k\">def</span> <span class=\"nf\">unescape_string_literal</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">):</span>\n    <span class=\"sa\">r</span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Convert quoted string literals to unquoted strings with escaped quotes and</span>\n<span class=\"sd\">    backslashes unquoted::</span>\n\n<span class=\"sd\">        &gt;&gt;&gt; unescape_string_literal(&#39;&quot;abc&quot;&#39;)</span>\n<span class=\"sd\">        &#39;abc&#39;</span>\n<span class=\"sd\">        &gt;&gt;&gt; unescape_string_literal(&quot;&#39;abc&#39;&quot;)</span>\n<span class=\"sd\">        &#39;abc&#39;</span>\n<span class=\"sd\">        &gt;&gt;&gt; unescape_string_literal(&#39;&quot;a \\&quot;bc\\&quot;&quot;&#39;)</span>\n<span class=\"sd\">        &#39;a &quot;bc&quot;&#39;</span>\n<span class=\"sd\">        &gt;&gt;&gt; unescape_string_literal(&quot;&#39;\\&#39;ab\\&#39; c&#39;&quot;)</span>\n<span class=\"sd\">        &quot;&#39;ab&#39; c&quot;</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">s</span> <span class=\"ow\">or</span> <span class=\"n\">s</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\&quot;</span><span class=\"s2\">&#39;&quot;</span> <span class=\"ow\">or</span> <span class=\"n\">s</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"o\">!=</span> <span class=\"n\">s</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]:</span>\n        <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Not a string literal: </span><span class=\"si\">%r</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">s</span><span class=\"p\">)</span>\n    <span class=\"n\">quote</span> <span class=\"o\">=</span> <span class=\"n\">s</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n    <span class=\"k\">return</span> <span class=\"n\">s</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;\\</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"n\">quote</span><span class=\"p\">,</span> <span class=\"n\">quote</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;</span><span class=\"se\">\\\\</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;</span><span class=\"se\">\\\\</span><span class=\"s2\">&quot;</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"slugify\"><a class=\"viewcode-back\" href=\"../../../../ref/utils/#django.utils.text.slugify\">[docs]</a><span class=\"nd\">@keep_lazy_text</span>\n<span class=\"k\">def</span> <span class=\"nf\">slugify</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">allow_unicode</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Convert to ASCII if &#39;allow_unicode&#39; is False. Convert spaces or repeated</span>\n<span class=\"sd\">    dashes to single dashes. Remove characters that aren&#39;t alphanumerics,</span>\n<span class=\"sd\">    underscores, or hyphens. Convert to lowercase. Also strip leading and</span>\n<span class=\"sd\">    trailing whitespace, dashes, and underscores.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">allow_unicode</span><span class=\"p\">:</span>\n        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">unicodedata</span><span class=\"o\">.</span><span class=\"n\">normalize</span><span class=\"p\">(</span><span class=\"s2\">&quot;NFKC&quot;</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">unicodedata</span><span class=\"o\">.</span><span class=\"n\">normalize</span><span class=\"p\">(</span><span class=\"s2\">&quot;NFKD&quot;</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">encode</span><span class=\"p\">(</span><span class=\"s2\">&quot;ascii&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;ignore&quot;</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"s2\">&quot;ascii&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n    <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">sub</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;[^\\w\\s-]&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">())</span>\n    <span class=\"k\">return</span> <span class=\"n\">re</span><span class=\"o\">.</span><span class=\"n\">sub</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot;[-\\s]+&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;-&quot;</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">strip</span><span class=\"p\">(</span><span class=\"s2\">&quot;-_&quot;</span><span class=\"p\">)</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">camel_case_to_spaces</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Split CamelCase and convert to lowercase. Strip surrounding whitespace.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">re_camel_case</span><span class=\"o\">.</span><span class=\"n\">sub</span><span class=\"p\">(</span><span class=\"sa\">r</span><span class=\"s2\">&quot; \\1&quot;</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">strip</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">()</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">_format_lazy</span><span class=\"p\">(</span><span class=\"n\">format_string</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Apply str.format() on &#39;format_string&#39; where format_string, args,</span>\n<span class=\"sd\">    and/or kwargs might be lazy.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">return</span> <span class=\"n\">format_string</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n\n<span class=\"n\">format_lazy</span> <span class=\"o\">=</span> <span class=\"n\">lazy</span><span class=\"p\">(</span><span class=\"n\">_format_lazy</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">)</span>\n</pre></div>", "current_page_name": "_modules/django/utils/text", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}
