{"parents": [{"link": "../../../../", "title": "Module code"}, {"link": "../../../", "title": "django"}], "title": "django.db.models.query_utils", "body": "<h1>Source code for django.db.models.query_utils</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">Various data structures used in query construction.</span>\n\n<span class=\"sd\">Factored out from django.db.models.query to avoid making the main module very</span>\n<span class=\"sd\">large and/or so that they can be used by other modules without getting into</span>\n<span class=\"sd\">circular import difficulties.</span>\n<span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"kn\">import</span> <span class=\"nn\">functools</span>\n<span class=\"kn\">import</span> <span class=\"nn\">inspect</span>\n<span class=\"kn\">import</span> <span class=\"nn\">logging</span>\n<span class=\"kn\">from</span> <span class=\"nn\">collections</span> <span class=\"kn\">import</span> <span class=\"n\">namedtuple</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">django.core.exceptions</span> <span class=\"kn\">import</span> <span class=\"n\">FieldError</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db</span> <span class=\"kn\">import</span> <span class=\"n\">DEFAULT_DB_ALIAS</span><span class=\"p\">,</span> <span class=\"n\">DatabaseError</span><span class=\"p\">,</span> <span class=\"n\">connections</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.constants</span> <span class=\"kn\">import</span> <span class=\"n\">LOOKUP_SEP</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils</span> <span class=\"kn\">import</span> <span class=\"n\">tree</span>\n\n<span class=\"n\">logger</span> <span class=\"o\">=</span> <span class=\"n\">logging</span><span class=\"o\">.</span><span class=\"n\">getLogger</span><span class=\"p\">(</span><span class=\"s2\">&quot;django.db.models&quot;</span><span class=\"p\">)</span>\n\n<span class=\"c1\"># PathInfo is used when converting lookups (fk__somecol). The contents</span>\n<span class=\"c1\"># describe the relation in Model terms (model Options and Fields for both</span>\n<span class=\"c1\"># sides of the relation. The join_field is the field backing the relation.</span>\n<span class=\"n\">PathInfo</span> <span class=\"o\">=</span> <span class=\"n\">namedtuple</span><span class=\"p\">(</span>\n    <span class=\"s2\">&quot;PathInfo&quot;</span><span class=\"p\">,</span>\n    <span class=\"s2\">&quot;from_opts to_opts target_fields join_field m2m direct filtered_relation&quot;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">subclasses</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n    <span class=\"k\">yield</span> <span class=\"bp\">cls</span>\n    <span class=\"k\">for</span> <span class=\"n\">subclass</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">__subclasses__</span><span class=\"p\">():</span>\n        <span class=\"k\">yield from</span> <span class=\"n\">subclasses</span><span class=\"p\">(</span><span class=\"n\">subclass</span><span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"Q\"><a class=\"viewcode-back\" href=\"../../../../../ref/models/querysets/#django.db.models.Q\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Q</span><span class=\"p\">(</span><span class=\"n\">tree</span><span class=\"o\">.</span><span class=\"n\">Node</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Encapsulate filters as objects that can then be combined logically (using</span>\n<span class=\"sd\">    `&amp;` and `|`).</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"c1\"># Connection types</span>\n    <span class=\"n\">AND</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;AND&quot;</span>\n    <span class=\"n\">OR</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;OR&quot;</span>\n    <span class=\"n\">XOR</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;XOR&quot;</span>\n    <span class=\"n\">default</span> <span class=\"o\">=</span> <span class=\"n\">AND</span>\n    <span class=\"n\">conditional</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">_connector</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">_negated</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__init__</span><span class=\"p\">(</span>\n            <span class=\"n\">children</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"n\">kwargs</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">())],</span>\n            <span class=\"n\">connector</span><span class=\"o\">=</span><span class=\"n\">_connector</span><span class=\"p\">,</span>\n            <span class=\"n\">negated</span><span class=\"o\">=</span><span class=\"n\">_negated</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_combine</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">conn</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"s2\">&quot;conditional&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"kc\">False</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">copy</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">other</span> <span class=\"ow\">and</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">Q</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">copy</span><span class=\"p\">()</span>\n\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">connector</span><span class=\"o\">=</span><span class=\"n\">conn</span><span class=\"p\">)</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">conn</span><span class=\"p\">)</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">conn</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__or__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_combine</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">OR</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__and__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_combine</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">AND</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__xor__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_combine</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">XOR</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__invert__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">copy</span><span class=\"p\">()</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">negate</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">resolve_expression</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">allow_joins</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">reuse</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">summarize</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">for_save</span><span class=\"o\">=</span><span class=\"kc\">False</span>\n    <span class=\"p\">):</span>\n        <span class=\"c1\"># We must promote any new joins to left outer joins so that when Q is</span>\n        <span class=\"c1\"># used as an expression, rows aren&#39;t filtered due to joins.</span>\n        <span class=\"n\">clause</span><span class=\"p\">,</span> <span class=\"n\">joins</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">_add_q</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span>\n            <span class=\"n\">reuse</span><span class=\"p\">,</span>\n            <span class=\"n\">allow_joins</span><span class=\"o\">=</span><span class=\"n\">allow_joins</span><span class=\"p\">,</span>\n            <span class=\"n\">split_subq</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n            <span class=\"n\">check_filterable</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n            <span class=\"n\">summarize</span><span class=\"o\">=</span><span class=\"n\">summarize</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">promote_joins</span><span class=\"p\">(</span><span class=\"n\">joins</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">clause</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">flatten</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Recursively yield this Q object and all subexpressions, in depth-first</span>\n<span class=\"sd\">        order.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">yield</span> <span class=\"bp\">self</span>\n        <span class=\"k\">for</span> <span class=\"n\">child</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">children</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">child</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">):</span>\n                <span class=\"c1\"># Use the lookup.</span>\n                <span class=\"n\">child</span> <span class=\"o\">=</span> <span class=\"n\">child</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]</span>\n            <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">child</span><span class=\"p\">,</span> <span class=\"s2\">&quot;flatten&quot;</span><span class=\"p\">):</span>\n                <span class=\"k\">yield from</span> <span class=\"n\">child</span><span class=\"o\">.</span><span class=\"n\">flatten</span><span class=\"p\">()</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"k\">yield</span> <span class=\"n\">child</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">check</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">against</span><span class=\"p\">,</span> <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">DEFAULT_DB_ALIAS</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Do a database query to check if the expressions of the Q instance</span>\n<span class=\"sd\">        matches against the expressions.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># Avoid circular imports.</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"kn\">import</span> <span class=\"n\">BooleanField</span><span class=\"p\">,</span> <span class=\"n\">Value</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models.functions</span> <span class=\"kn\">import</span> <span class=\"n\">Coalesce</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models.sql</span> <span class=\"kn\">import</span> <span class=\"n\">Query</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models.sql.constants</span> <span class=\"kn\">import</span> <span class=\"n\">SINGLE</span>\n\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">Query</span><span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">value</span> <span class=\"ow\">in</span> <span class=\"n\">against</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"s2\">&quot;resolve_expression&quot;</span><span class=\"p\">):</span>\n                <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"n\">Value</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">)</span>\n            <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_annotation</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">select</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_annotation</span><span class=\"p\">(</span><span class=\"n\">Value</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">),</span> <span class=\"s2\">&quot;_check&quot;</span><span class=\"p\">)</span>\n        <span class=\"c1\"># This will raise a FieldError if a field is missing in &quot;against&quot;.</span>\n        <span class=\"k\">if</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">using</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_comparing_boolean_expr</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_q</span><span class=\"p\">(</span><span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"n\">Coalesce</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"n\">BooleanField</span><span class=\"p\">())))</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_q</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n        <span class=\"n\">compiler</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">using</span><span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">execute_sql</span><span class=\"p\">(</span><span class=\"n\">SINGLE</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span>\n        <span class=\"k\">except</span> <span class=\"n\">DatabaseError</span> <span class=\"k\">as</span> <span class=\"n\">e</span><span class=\"p\">:</span>\n            <span class=\"n\">logger</span><span class=\"o\">.</span><span class=\"n\">warning</span><span class=\"p\">(</span><span class=\"s2\">&quot;Got a database error calling check() on </span><span class=\"si\">%r</span><span class=\"s2\">: </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">e</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">deconstruct</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\">.</span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__module__</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">startswith</span><span class=\"p\">(</span><span class=\"s2\">&quot;django.db.models.query_utils&quot;</span><span class=\"p\">):</span>\n            <span class=\"n\">path</span> <span class=\"o\">=</span> <span class=\"n\">path</span><span class=\"o\">.</span><span class=\"n\">replace</span><span class=\"p\">(</span><span class=\"s2\">&quot;django.db.models.query_utils&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;django.db.models&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">args</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">children</span><span class=\"p\">)</span>\n        <span class=\"n\">kwargs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connector</span> <span class=\"o\">!=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">default</span><span class=\"p\">:</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;_connector&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">connector</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">negated</span><span class=\"p\">:</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"s2\">&quot;_negated&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">return</span> <span class=\"n\">path</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">DeferredAttribute</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    A wrapper for a deferred-loading field. When the value is read from this</span>\n<span class=\"sd\">    object the first time, the query is executed.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span> <span class=\"o\">=</span> <span class=\"n\">field</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__get__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"bp\">cls</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Retrieve and caches the value from the datastore on the first lookup.</span>\n<span class=\"sd\">        Return the cached value.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">instance</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span>\n        <span class=\"n\">field_name</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span>\n        <span class=\"k\">if</span> <span class=\"n\">field_name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">data</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Let&#39;s see if the field is part of the parent chain. If so we</span>\n            <span class=\"c1\"># might be able to reuse the already loaded value. Refs #18343.</span>\n            <span class=\"n\">val</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_parent_chain</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">val</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">refresh_from_db</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"p\">[</span><span class=\"n\">field_name</span><span class=\"p\">])</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">field_name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">val</span>\n        <span class=\"k\">return</span> <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"n\">field_name</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_check_parent_chain</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Check if the field value can be fetched from a parent field already</span>\n<span class=\"sd\">        loaded in the instance. This can be done if the to-be fetched</span>\n<span class=\"sd\">        field is a primary key field.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n        <span class=\"n\">link_field</span> <span class=\"o\">=</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">get_ancestor_link</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">field</span> <span class=\"o\">!=</span> <span class=\"n\">link_field</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">link_field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">class_or_instance_method</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Hook used in RegisterLookupMixin to return partial functions depending on</span>\n<span class=\"sd\">    the caller type (instance or class of models.Field).</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">class_method</span><span class=\"p\">,</span> <span class=\"n\">instance_method</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">class_method</span> <span class=\"o\">=</span> <span class=\"n\">class_method</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance_method</span> <span class=\"o\">=</span> <span class=\"n\">instance_method</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__get__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">owner</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">instance</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">functools</span><span class=\"o\">.</span><span class=\"n\">partial</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">class_method</span><span class=\"p\">,</span> <span class=\"n\">owner</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">functools</span><span class=\"o\">.</span><span class=\"n\">partial</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance_method</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">RegisterLookupMixin</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_get_lookup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">lookup_name</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_lookups</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">lookup_name</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n\n    <span class=\"nd\">@functools</span><span class=\"o\">.</span><span class=\"n\">cache</span>\n    <span class=\"k\">def</span> <span class=\"nf\">get_class_lookups</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"n\">class_lookups</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"n\">parent</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;class_lookups&quot;</span><span class=\"p\">,</span> <span class=\"p\">{})</span> <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"n\">inspect</span><span class=\"o\">.</span><span class=\"n\">getmro</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">)</span>\n        <span class=\"p\">]</span>\n        <span class=\"k\">return</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">merge_dicts</span><span class=\"p\">(</span><span class=\"n\">class_lookups</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_instance_lookups</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">class_lookups</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_class_lookups</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">instance_lookups</span> <span class=\"o\">:=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"s2\">&quot;instance_lookups&quot;</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"o\">**</span><span class=\"n\">class_lookups</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">instance_lookups</span><span class=\"p\">}</span>\n        <span class=\"k\">return</span> <span class=\"n\">class_lookups</span>\n\n    <span class=\"n\">get_lookups</span> <span class=\"o\">=</span> <span class=\"n\">class_or_instance_method</span><span class=\"p\">(</span><span class=\"n\">get_class_lookups</span><span class=\"p\">,</span> <span class=\"n\">get_instance_lookups</span><span class=\"p\">)</span>\n    <span class=\"n\">get_class_lookups</span> <span class=\"o\">=</span> <span class=\"nb\">classmethod</span><span class=\"p\">(</span><span class=\"n\">get_class_lookups</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_lookup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">lookup_name</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models.lookups</span> <span class=\"kn\">import</span> <span class=\"n\">Lookup</span>\n\n        <span class=\"n\">found</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_lookup</span><span class=\"p\">(</span><span class=\"n\">lookup_name</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">found</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"s2\">&quot;output_field&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"o\">.</span><span class=\"n\">get_lookup</span><span class=\"p\">(</span><span class=\"n\">lookup_name</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">found</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">issubclass</span><span class=\"p\">(</span><span class=\"n\">found</span><span class=\"p\">,</span> <span class=\"n\">Lookup</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"n\">found</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_transform</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">lookup_name</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models.lookups</span> <span class=\"kn\">import</span> <span class=\"n\">Transform</span>\n\n        <span class=\"n\">found</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_get_lookup</span><span class=\"p\">(</span><span class=\"n\">lookup_name</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">found</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"s2\">&quot;output_field&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">output_field</span><span class=\"o\">.</span><span class=\"n\">get_transform</span><span class=\"p\">(</span><span class=\"n\">lookup_name</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">found</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">issubclass</span><span class=\"p\">(</span><span class=\"n\">found</span><span class=\"p\">,</span> <span class=\"n\">Transform</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"n\">found</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">merge_dicts</span><span class=\"p\">(</span><span class=\"n\">dicts</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Merge dicts in reverse to preference the order of the original list. e.g.,</span>\n<span class=\"sd\">        merge_dicts([a, b]) will preference the keys in &#39;a&#39; over those in &#39;b&#39;.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">merged</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">for</span> <span class=\"n\">d</span> <span class=\"ow\">in</span> <span class=\"nb\">reversed</span><span class=\"p\">(</span><span class=\"n\">dicts</span><span class=\"p\">):</span>\n            <span class=\"n\">merged</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">merged</span>\n\n    <span class=\"nd\">@classmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_clear_cached_class_lookups</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"k\">for</span> <span class=\"n\">subclass</span> <span class=\"ow\">in</span> <span class=\"n\">subclasses</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n            <span class=\"n\">subclass</span><span class=\"o\">.</span><span class=\"n\">get_class_lookups</span><span class=\"o\">.</span><span class=\"n\">cache_clear</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">register_class_lookup</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">lookup</span><span class=\"p\">,</span> <span class=\"n\">lookup_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">lookup_name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span>\n        <span class=\"k\">if</span> <span class=\"s2\">&quot;class_lookups&quot;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"p\">:</span>\n            <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">class_lookups</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">class_lookups</span><span class=\"p\">[</span><span class=\"n\">lookup_name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_clear_cached_class_lookups</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">lookup</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">register_instance_lookup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">lookup</span><span class=\"p\">,</span> <span class=\"n\">lookup_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">lookup_name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span>\n        <span class=\"k\">if</span> <span class=\"s2\">&quot;instance_lookups&quot;</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance_lookups</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance_lookups</span><span class=\"p\">[</span><span class=\"n\">lookup_name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span>\n        <span class=\"k\">return</span> <span class=\"n\">lookup</span>\n\n    <span class=\"n\">register_lookup</span> <span class=\"o\">=</span> <span class=\"n\">class_or_instance_method</span><span class=\"p\">(</span>\n        <span class=\"n\">register_class_lookup</span><span class=\"p\">,</span> <span class=\"n\">register_instance_lookup</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">register_class_lookup</span> <span class=\"o\">=</span> <span class=\"nb\">classmethod</span><span class=\"p\">(</span><span class=\"n\">register_class_lookup</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_unregister_class_lookup</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"n\">lookup</span><span class=\"p\">,</span> <span class=\"n\">lookup_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Remove given lookup from cls lookups. For use in tests only as it&#39;s</span>\n<span class=\"sd\">        not thread-safe.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">lookup_name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span>\n        <span class=\"k\">del</span> <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">class_lookups</span><span class=\"p\">[</span><span class=\"n\">lookup_name</span><span class=\"p\">]</span>\n        <span class=\"bp\">cls</span><span class=\"o\">.</span><span class=\"n\">_clear_cached_class_lookups</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_unregister_instance_lookup</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">lookup</span><span class=\"p\">,</span> <span class=\"n\">lookup_name</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Remove given lookup from instance lookups. For use in tests only as</span>\n<span class=\"sd\">        it&#39;s not thread-safe.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">lookup_name</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">lookup_name</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">lookup_name</span>\n        <span class=\"k\">del</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">instance_lookups</span><span class=\"p\">[</span><span class=\"n\">lookup_name</span><span class=\"p\">]</span>\n\n    <span class=\"n\">_unregister_lookup</span> <span class=\"o\">=</span> <span class=\"n\">class_or_instance_method</span><span class=\"p\">(</span>\n        <span class=\"n\">_unregister_class_lookup</span><span class=\"p\">,</span> <span class=\"n\">_unregister_instance_lookup</span>\n    <span class=\"p\">)</span>\n    <span class=\"n\">_unregister_class_lookup</span> <span class=\"o\">=</span> <span class=\"nb\">classmethod</span><span class=\"p\">(</span><span class=\"n\">_unregister_class_lookup</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">select_related_descend</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">restricted</span><span class=\"p\">,</span> <span class=\"n\">requested</span><span class=\"p\">,</span> <span class=\"n\">select_mask</span><span class=\"p\">,</span> <span class=\"n\">reverse</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Return True if this field should be used to descend deeper for</span>\n<span class=\"sd\">    select_related() purposes. Used by both the query construction code</span>\n<span class=\"sd\">    (compiler.get_related_selections()) and the model instance creation code</span>\n<span class=\"sd\">    (compiler.klass_info).</span>\n\n<span class=\"sd\">    Arguments:</span>\n<span class=\"sd\">     * field - the field to be checked</span>\n<span class=\"sd\">     * restricted - a boolean field, indicating if the field list has been</span>\n<span class=\"sd\">       manually restricted using a requested clause)</span>\n<span class=\"sd\">     * requested - The select_related() dictionary.</span>\n<span class=\"sd\">     * select_mask - the dictionary of selected fields.</span>\n<span class=\"sd\">     * reverse - boolean, True if we are checking a reverse select related</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"kc\">False</span>\n    <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">remote_field</span><span class=\"o\">.</span><span class=\"n\">parent_link</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">reverse</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"kc\">False</span>\n    <span class=\"k\">if</span> <span class=\"n\">restricted</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"n\">reverse</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">related_query_name</span><span class=\"p\">()</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">requested</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">reverse</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">requested</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">restricted</span> <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">null</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span> <span class=\"kc\">False</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span>\n        <span class=\"n\">restricted</span>\n        <span class=\"ow\">and</span> <span class=\"n\">select_mask</span>\n        <span class=\"ow\">and</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">requested</span>\n        <span class=\"ow\">and</span> <span class=\"n\">field</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">select_mask</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">raise</span> <span class=\"n\">FieldError</span><span class=\"p\">(</span>\n            <span class=\"sa\">f</span><span class=\"s2\">&quot;Field </span><span class=\"si\">{</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span><span class=\"si\">}</span><span class=\"s2\">.</span><span class=\"si\">{</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span><span class=\"s2\"> cannot be both &quot;</span>\n            <span class=\"s2\">&quot;deferred and traversed using select_related at the same time.&quot;</span>\n        <span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"kc\">True</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">refs_expression</span><span class=\"p\">(</span><span class=\"n\">lookup_parts</span><span class=\"p\">,</span> <span class=\"n\">annotations</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Check if the lookup_parts contains references to the given annotations set.</span>\n<span class=\"sd\">    Because the LOOKUP_SEP is contained in the default annotation names, check</span>\n<span class=\"sd\">    each prefix of the lookup_parts for a match.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">for</span> <span class=\"n\">n</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">,</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">lookup_parts</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">):</span>\n        <span class=\"n\">level_n_lookup</span> <span class=\"o\">=</span> <span class=\"n\">LOOKUP_SEP</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">lookup_parts</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"n\">n</span><span class=\"p\">])</span>\n        <span class=\"k\">if</span> <span class=\"n\">annotations</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">level_n_lookup</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"n\">level_n_lookup</span><span class=\"p\">,</span> <span class=\"n\">lookup_parts</span><span class=\"p\">[</span><span class=\"n\">n</span><span class=\"p\">:]</span>\n    <span class=\"k\">return</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"p\">()</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">check_rel_lookup_compatibility</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">target_opts</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Check that self.model is compatible with target_opts. Compatibility</span>\n<span class=\"sd\">    is OK if:</span>\n<span class=\"sd\">      1) model and opts match (where proxy inheritance is removed)</span>\n<span class=\"sd\">      2) model is parent of opts&#39; model or the other way around</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">check</span><span class=\"p\">(</span><span class=\"n\">opts</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">concrete_model</span> <span class=\"o\">==</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">concrete_model</span>\n            <span class=\"ow\">or</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">concrete_model</span> <span class=\"ow\">in</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_parent_list</span><span class=\"p\">()</span>\n            <span class=\"ow\">or</span> <span class=\"n\">model</span> <span class=\"ow\">in</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">get_parent_list</span><span class=\"p\">()</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"c1\"># If the field is a primary key, then doing a query against the field&#39;s</span>\n    <span class=\"c1\"># model is ok, too. Consider the case:</span>\n    <span class=\"c1\"># class Restaurant(models.Model):</span>\n    <span class=\"c1\">#     place = OneToOneField(Place, primary_key=True):</span>\n    <span class=\"c1\"># Restaurant.objects.filter(pk__in=Restaurant.objects.all()).</span>\n    <span class=\"c1\"># If we didn&#39;t have the primary key check, then pk__in (== place__in) would</span>\n    <span class=\"c1\"># give Place&#39;s opts as the target opts, but Restaurant isn&#39;t compatible</span>\n    <span class=\"c1\"># with that. This logic applies only to primary keys, as when doing __in=qs,</span>\n    <span class=\"c1\"># we are going to turn this into __in=qs.values(&#39;pk&#39;) later on.</span>\n    <span class=\"k\">return</span> <span class=\"n\">check</span><span class=\"p\">(</span><span class=\"n\">target_opts</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span>\n        <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"s2\">&quot;primary_key&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">check</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"p\">)</span>\n    <span class=\"p\">)</span>\n\n\n<div class=\"viewcode-block\" id=\"FilteredRelation\"><a class=\"viewcode-back\" href=\"../../../../../ref/models/querysets/#django.db.models.FilteredRelation\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">FilteredRelation</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;Specify custom filtering in the ON clause of SQL joins.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">relation_name</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"n\">condition</span><span class=\"o\">=</span><span class=\"n\">Q</span><span class=\"p\">()):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">relation_name</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;relation_name cannot be empty.&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">relation_name</span> <span class=\"o\">=</span> <span class=\"n\">relation_name</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">alias</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">condition</span><span class=\"p\">,</span> <span class=\"n\">Q</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;condition argument must be a Q() instance.&quot;</span><span class=\"p\">)</span>\n        <span class=\"c1\"># .condition and .resolved_condition have to be stored independently</span>\n        <span class=\"c1\"># as the former must remain unchanged for Join.__eq__ to remain stable</span>\n        <span class=\"c1\"># and reusable even once their .filtered_relation are resolved.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">condition</span> <span class=\"o\">=</span> <span class=\"n\">condition</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">resolved_condition</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__eq__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">NotImplemented</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">relation_name</span> <span class=\"o\">==</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">relation_name</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">alias</span> <span class=\"o\">==</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">alias</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">condition</span> <span class=\"o\">==</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">condition</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">clone</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"n\">FilteredRelation</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">relation_name</span><span class=\"p\">,</span> <span class=\"n\">condition</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">condition</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">alias</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">alias</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">resolved_condition</span> <span class=\"o\">:=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">resolved_condition</span><span class=\"p\">)</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">resolved_condition</span> <span class=\"o\">=</span> <span class=\"n\">resolved_condition</span><span class=\"o\">.</span><span class=\"n\">clone</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">relabeled_clone</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">change_map</span><span class=\"p\">):</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">clone</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">resolved_condition</span> <span class=\"o\">:=</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">resolved_condition</span><span class=\"p\">:</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">resolved_condition</span> <span class=\"o\">=</span> <span class=\"n\">resolved_condition</span><span class=\"o\">.</span><span class=\"n\">relabeled_clone</span><span class=\"p\">(</span><span class=\"n\">change_map</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">resolve_expression</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">reuse</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">clone</span><span class=\"p\">()</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">resolved_condition</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">build_filter</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">condition</span><span class=\"p\">,</span>\n            <span class=\"n\">can_reuse</span><span class=\"o\">=</span><span class=\"n\">reuse</span><span class=\"p\">,</span>\n            <span class=\"n\">allow_joins</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n            <span class=\"n\">split_subq</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n            <span class=\"n\">update_join_types</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_sql</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">compiler</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">compile</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">resolved_condition</span><span class=\"p\">)</span></div>\n</pre></div>", "current_page_name": "_modules/django/db/models/query_utils", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}