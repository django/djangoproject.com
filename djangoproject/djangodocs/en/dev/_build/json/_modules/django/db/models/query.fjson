{"parents": [{"link": "../../../../", "title": "Module code"}, {"link": "../../../", "title": "django"}], "title": "django.db.models.query", "body": "<h1>Source code for django.db.models.query</h1><div class=\"highlight\"><pre>\n<span></span><span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">The main QuerySet implementation. This provides the public API for the ORM.</span>\n<span class=\"sd\">&quot;&quot;&quot;</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">copy</span>\n<span class=\"kn\">import</span> <span class=\"nn\">operator</span>\n<span class=\"kn\">import</span> <span class=\"nn\">warnings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">itertools</span> <span class=\"kn\">import</span> <span class=\"n\">chain</span><span class=\"p\">,</span> <span class=\"n\">islice</span>\n\n<span class=\"kn\">from</span> <span class=\"nn\">asgiref.sync</span> <span class=\"kn\">import</span> <span class=\"n\">sync_to_async</span>\n\n<span class=\"kn\">import</span> <span class=\"nn\">django</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.conf</span> <span class=\"kn\">import</span> <span class=\"n\">settings</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.core</span> <span class=\"kn\">import</span> <span class=\"n\">exceptions</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">DJANGO_VERSION_PICKLE_KEY</span><span class=\"p\">,</span>\n    <span class=\"n\">IntegrityError</span><span class=\"p\">,</span>\n    <span class=\"n\">NotSupportedError</span><span class=\"p\">,</span>\n    <span class=\"n\">connections</span><span class=\"p\">,</span>\n    <span class=\"n\">router</span><span class=\"p\">,</span>\n    <span class=\"n\">transaction</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models</span> <span class=\"kn\">import</span> <span class=\"n\">AutoField</span><span class=\"p\">,</span> <span class=\"n\">DateField</span><span class=\"p\">,</span> <span class=\"n\">DateTimeField</span><span class=\"p\">,</span> <span class=\"n\">Field</span><span class=\"p\">,</span> <span class=\"n\">sql</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.constants</span> <span class=\"kn\">import</span> <span class=\"n\">LOOKUP_SEP</span><span class=\"p\">,</span> <span class=\"n\">OnConflict</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.deletion</span> <span class=\"kn\">import</span> <span class=\"n\">Collector</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.expressions</span> <span class=\"kn\">import</span> <span class=\"n\">Case</span><span class=\"p\">,</span> <span class=\"n\">F</span><span class=\"p\">,</span> <span class=\"n\">Value</span><span class=\"p\">,</span> <span class=\"n\">When</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.functions</span> <span class=\"kn\">import</span> <span class=\"n\">Cast</span><span class=\"p\">,</span> <span class=\"n\">Trunc</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.query_utils</span> <span class=\"kn\">import</span> <span class=\"n\">FilteredRelation</span><span class=\"p\">,</span> <span class=\"n\">Q</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.sql.constants</span> <span class=\"kn\">import</span> <span class=\"n\">CURSOR</span><span class=\"p\">,</span> <span class=\"n\">GET_ITERATOR_CHUNK_SIZE</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.db.models.utils</span> <span class=\"kn\">import</span> <span class=\"p\">(</span>\n    <span class=\"n\">AltersData</span><span class=\"p\">,</span>\n    <span class=\"n\">create_namedtuple_class</span><span class=\"p\">,</span>\n    <span class=\"n\">resolve_callables</span><span class=\"p\">,</span>\n<span class=\"p\">)</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils</span> <span class=\"kn\">import</span> <span class=\"n\">timezone</span>\n<span class=\"kn\">from</span> <span class=\"nn\">django.utils.functional</span> <span class=\"kn\">import</span> <span class=\"n\">cached_property</span><span class=\"p\">,</span> <span class=\"n\">partition</span>\n\n<span class=\"c1\"># The maximum number of results to fetch in a get() query.</span>\n<span class=\"n\">MAX_GET_RESULTS</span> <span class=\"o\">=</span> <span class=\"mi\">21</span>\n\n<span class=\"c1\"># The maximum number of items to display in a QuerySet.__repr__</span>\n<span class=\"n\">REPR_OUTPUT_SIZE</span> <span class=\"o\">=</span> <span class=\"mi\">20</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">BaseIterable</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">queryset</span><span class=\"p\">,</span> <span class=\"n\">chunked_fetch</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"n\">GET_ITERATOR_CHUNK_SIZE</span>\n    <span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunked_fetch</span> <span class=\"o\">=</span> <span class=\"n\">chunked_fetch</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunk_size</span> <span class=\"o\">=</span> <span class=\"n\">chunk_size</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">_async_generator</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Generators don&#39;t actually start running until the first time you call</span>\n        <span class=\"c1\"># next() on them, so make the generator object in the async thread and</span>\n        <span class=\"c1\"># then repeatedly dispatch to it in a sync thread.</span>\n        <span class=\"n\">sync_generator</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"fm\">__iter__</span><span class=\"p\">()</span>\n\n        <span class=\"k\">def</span> <span class=\"nf\">next_slice</span><span class=\"p\">(</span><span class=\"n\">gen</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">islice</span><span class=\"p\">(</span><span class=\"n\">gen</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunk_size</span><span class=\"p\">))</span>\n\n        <span class=\"k\">while</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n            <span class=\"n\">chunk</span> <span class=\"o\">=</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"n\">next_slice</span><span class=\"p\">)(</span><span class=\"n\">sync_generator</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"n\">chunk</span><span class=\"p\">:</span>\n                <span class=\"k\">yield</span> <span class=\"n\">item</span>\n            <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">chunk</span><span class=\"p\">)</span> <span class=\"o\">&lt;</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunk_size</span><span class=\"p\">:</span>\n                <span class=\"k\">break</span>\n\n    <span class=\"c1\"># __aiter__() is a *synchronous* method that has to then return an</span>\n    <span class=\"c1\"># *asynchronous* iterator/generator. Thus, nest an async generator inside</span>\n    <span class=\"c1\"># it.</span>\n    <span class=\"c1\"># This is a generic iterable converter for now, and is going to suffer a</span>\n    <span class=\"c1\"># performance penalty on large sets of items due to the cost of crossing</span>\n    <span class=\"c1\"># over the sync barrier for each chunk. Custom __aiter__() methods should</span>\n    <span class=\"c1\"># be added to each Iterable subclass, but that needs some work in the</span>\n    <span class=\"c1\"># Compiler first.</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__aiter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_async_generator</span><span class=\"p\">()</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ModelIterable</span><span class=\"p\">(</span><span class=\"n\">BaseIterable</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Iterable that yields a model instance for each row.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__iter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span>\n        <span class=\"n\">db</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">db</span>\n        <span class=\"n\">compiler</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Execute the query. This will also fill compiler.select, klass_info,</span>\n        <span class=\"c1\"># and annotations.</span>\n        <span class=\"n\">results</span> <span class=\"o\">=</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">execute_sql</span><span class=\"p\">(</span>\n            <span class=\"n\">chunked_fetch</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunked_fetch</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunk_size</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">select</span><span class=\"p\">,</span> <span class=\"n\">klass_info</span><span class=\"p\">,</span> <span class=\"n\">annotation_col_map</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">select</span><span class=\"p\">,</span>\n            <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">klass_info</span><span class=\"p\">,</span>\n            <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">annotation_col_map</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">model_cls</span> <span class=\"o\">=</span> <span class=\"n\">klass_info</span><span class=\"p\">[</span><span class=\"s2\">&quot;model&quot;</span><span class=\"p\">]</span>\n        <span class=\"n\">select_fields</span> <span class=\"o\">=</span> <span class=\"n\">klass_info</span><span class=\"p\">[</span><span class=\"s2\">&quot;select_fields&quot;</span><span class=\"p\">]</span>\n        <span class=\"n\">model_fields_start</span><span class=\"p\">,</span> <span class=\"n\">model_fields_end</span> <span class=\"o\">=</span> <span class=\"n\">select_fields</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span> <span class=\"n\">select_fields</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"mi\">1</span>\n        <span class=\"n\">init_list</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"n\">f</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">target</span><span class=\"o\">.</span><span class=\"n\">attname</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">select</span><span class=\"p\">[</span><span class=\"n\">model_fields_start</span><span class=\"p\">:</span><span class=\"n\">model_fields_end</span><span class=\"p\">]</span>\n        <span class=\"p\">]</span>\n        <span class=\"n\">related_populators</span> <span class=\"o\">=</span> <span class=\"n\">get_related_populators</span><span class=\"p\">(</span><span class=\"n\">klass_info</span><span class=\"p\">,</span> <span class=\"n\">select</span><span class=\"p\">,</span> <span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"n\">known_related_objects</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"p\">(</span>\n                <span class=\"n\">field</span><span class=\"p\">,</span>\n                <span class=\"n\">related_objs</span><span class=\"p\">,</span>\n                <span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">attrgetter</span><span class=\"p\">(</span>\n                    <span class=\"o\">*</span><span class=\"p\">[</span>\n                        <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span>\n                        <span class=\"k\">if</span> <span class=\"n\">from_field</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;self&quot;</span>\n                        <span class=\"k\">else</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">from_field</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">attname</span>\n                        <span class=\"k\">for</span> <span class=\"n\">from_field</span> <span class=\"ow\">in</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">from_fields</span>\n                    <span class=\"p\">]</span>\n                <span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">related_objs</span> <span class=\"ow\">in</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_known_related_objects</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span>\n        <span class=\"p\">]</span>\n        <span class=\"k\">for</span> <span class=\"n\">row</span> <span class=\"ow\">in</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">results_iter</span><span class=\"p\">(</span><span class=\"n\">results</span><span class=\"p\">):</span>\n            <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"n\">model_cls</span><span class=\"o\">.</span><span class=\"n\">from_db</span><span class=\"p\">(</span>\n                <span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"n\">init_list</span><span class=\"p\">,</span> <span class=\"n\">row</span><span class=\"p\">[</span><span class=\"n\">model_fields_start</span><span class=\"p\">:</span><span class=\"n\">model_fields_end</span><span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">rel_populator</span> <span class=\"ow\">in</span> <span class=\"n\">related_populators</span><span class=\"p\">:</span>\n                <span class=\"n\">rel_populator</span><span class=\"o\">.</span><span class=\"n\">populate</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">annotation_col_map</span><span class=\"p\">:</span>\n                <span class=\"k\">for</span> <span class=\"n\">attr_name</span><span class=\"p\">,</span> <span class=\"n\">col_pos</span> <span class=\"ow\">in</span> <span class=\"n\">annotation_col_map</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n                    <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">attr_name</span><span class=\"p\">,</span> <span class=\"n\">row</span><span class=\"p\">[</span><span class=\"n\">col_pos</span><span class=\"p\">])</span>\n\n            <span class=\"c1\"># Add the known related objects to the model.</span>\n            <span class=\"k\">for</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">rel_objs</span><span class=\"p\">,</span> <span class=\"n\">rel_getter</span> <span class=\"ow\">in</span> <span class=\"n\">known_related_objects</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Avoid overwriting objects loaded by, e.g., select_related().</span>\n                <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">is_cached</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">):</span>\n                    <span class=\"k\">continue</span>\n                <span class=\"n\">rel_obj_id</span> <span class=\"o\">=</span> <span class=\"n\">rel_getter</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n                <span class=\"k\">try</span><span class=\"p\">:</span>\n                    <span class=\"n\">rel_obj</span> <span class=\"o\">=</span> <span class=\"n\">rel_objs</span><span class=\"p\">[</span><span class=\"n\">rel_obj_id</span><span class=\"p\">]</span>\n                <span class=\"k\">except</span> <span class=\"ne\">KeyError</span><span class=\"p\">:</span>\n                    <span class=\"k\">pass</span>  <span class=\"c1\"># May happen in qs1 | qs2 scenarios.</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">rel_obj</span><span class=\"p\">)</span>\n\n            <span class=\"k\">yield</span> <span class=\"n\">obj</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">RawModelIterable</span><span class=\"p\">(</span><span class=\"n\">BaseIterable</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Iterable that yields a model instance for each row from a raw queryset.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__iter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Cache some things for performance reasons outside the loop.</span>\n        <span class=\"n\">db</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">db</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">query</span>\n        <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">db</span><span class=\"p\">]</span>\n        <span class=\"n\">compiler</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">compiler</span><span class=\"p\">(</span><span class=\"s2\">&quot;SQLCompiler&quot;</span><span class=\"p\">)(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">connection</span><span class=\"p\">,</span> <span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"n\">query_iterator</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">)</span>\n\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"p\">(</span>\n                <span class=\"n\">model_init_names</span><span class=\"p\">,</span>\n                <span class=\"n\">model_init_pos</span><span class=\"p\">,</span>\n                <span class=\"n\">annotation_fields</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">resolve_model_init_order</span><span class=\"p\">()</span>\n            <span class=\"n\">model_cls</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">model</span>\n            <span class=\"k\">if</span> <span class=\"n\">model_cls</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">attname</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">model_init_names</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">exceptions</span><span class=\"o\">.</span><span class=\"n\">FieldDoesNotExist</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Raw query must include the primary key&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">model_fields</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">c</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">columns</span><span class=\"p\">]</span>\n            <span class=\"n\">converters</span> <span class=\"o\">=</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">get_converters</span><span class=\"p\">(</span>\n                <span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">get_col</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_table</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">f</span> <span class=\"k\">else</span> <span class=\"kc\">None</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">converters</span><span class=\"p\">:</span>\n                <span class=\"n\">query_iterator</span> <span class=\"o\">=</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">apply_converters</span><span class=\"p\">(</span><span class=\"n\">query_iterator</span><span class=\"p\">,</span> <span class=\"n\">converters</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">values</span> <span class=\"ow\">in</span> <span class=\"n\">query_iterator</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Associate fields to values</span>\n                <span class=\"n\">model_init_values</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">values</span><span class=\"p\">[</span><span class=\"n\">pos</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">pos</span> <span class=\"ow\">in</span> <span class=\"n\">model_init_pos</span><span class=\"p\">]</span>\n                <span class=\"n\">instance</span> <span class=\"o\">=</span> <span class=\"n\">model_cls</span><span class=\"o\">.</span><span class=\"n\">from_db</span><span class=\"p\">(</span><span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"n\">model_init_names</span><span class=\"p\">,</span> <span class=\"n\">model_init_values</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">annotation_fields</span><span class=\"p\">:</span>\n                    <span class=\"k\">for</span> <span class=\"n\">column</span><span class=\"p\">,</span> <span class=\"n\">pos</span> <span class=\"ow\">in</span> <span class=\"n\">annotation_fields</span><span class=\"p\">:</span>\n                        <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">column</span><span class=\"p\">,</span> <span class=\"n\">values</span><span class=\"p\">[</span><span class=\"n\">pos</span><span class=\"p\">])</span>\n                <span class=\"k\">yield</span> <span class=\"n\">instance</span>\n        <span class=\"k\">finally</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Done iterating the Query. If it has its own cursor, close it.</span>\n            <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"s2\">&quot;cursor&quot;</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"p\">:</span>\n                <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">cursor</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ValuesIterable</span><span class=\"p\">(</span><span class=\"n\">BaseIterable</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Iterable returned by QuerySet.values() that yields a dict for each row.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__iter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">query</span>\n        <span class=\"n\">compiler</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># extra(select=...) cols are always at the start of the row.</span>\n        <span class=\"n\">names</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"o\">*</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">extra_select</span><span class=\"p\">,</span>\n            <span class=\"o\">*</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">values_select</span><span class=\"p\">,</span>\n            <span class=\"o\">*</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotation_select</span><span class=\"p\">,</span>\n        <span class=\"p\">]</span>\n        <span class=\"n\">indexes</span> <span class=\"o\">=</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">names</span><span class=\"p\">))</span>\n        <span class=\"k\">for</span> <span class=\"n\">row</span> <span class=\"ow\">in</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">results_iter</span><span class=\"p\">(</span>\n            <span class=\"n\">chunked_fetch</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunked_fetch</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunk_size</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">yield</span> <span class=\"p\">{</span><span class=\"n\">names</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]:</span> <span class=\"n\">row</span><span class=\"p\">[</span><span class=\"n\">i</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"n\">indexes</span><span class=\"p\">}</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">ValuesListIterable</span><span class=\"p\">(</span><span class=\"n\">BaseIterable</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Iterable returned by QuerySet.values_list(flat=False) that yields a tuple</span>\n<span class=\"sd\">    for each row.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__iter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">query</span>\n        <span class=\"n\">compiler</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">:</span>\n            <span class=\"c1\"># extra(select=...) cols are always at the start of the row.</span>\n            <span class=\"n\">names</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"o\">*</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">extra_select</span><span class=\"p\">,</span>\n                <span class=\"o\">*</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">values_select</span><span class=\"p\">,</span>\n                <span class=\"o\">*</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotation_select</span><span class=\"p\">,</span>\n            <span class=\"p\">]</span>\n            <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"o\">*</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">,</span>\n                <span class=\"o\">*</span><span class=\"p\">(</span><span class=\"n\">f</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotation_select</span> <span class=\"k\">if</span> <span class=\"n\">f</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">),</span>\n            <span class=\"p\">]</span>\n            <span class=\"k\">if</span> <span class=\"n\">fields</span> <span class=\"o\">!=</span> <span class=\"n\">names</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Reorder according to fields.</span>\n                <span class=\"n\">index_map</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">name</span><span class=\"p\">:</span> <span class=\"n\">idx</span> <span class=\"k\">for</span> <span class=\"n\">idx</span><span class=\"p\">,</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"n\">names</span><span class=\"p\">)}</span>\n                <span class=\"n\">rowfactory</span> <span class=\"o\">=</span> <span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">itemgetter</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">[</span><span class=\"n\">index_map</span><span class=\"p\">[</span><span class=\"n\">f</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">])</span>\n                <span class=\"k\">return</span> <span class=\"nb\">map</span><span class=\"p\">(</span>\n                    <span class=\"n\">rowfactory</span><span class=\"p\">,</span>\n                    <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">results_iter</span><span class=\"p\">(</span>\n                        <span class=\"n\">chunked_fetch</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunked_fetch</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunk_size</span>\n                    <span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">results_iter</span><span class=\"p\">(</span>\n            <span class=\"n\">tuple_expected</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n            <span class=\"n\">chunked_fetch</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunked_fetch</span><span class=\"p\">,</span>\n            <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunk_size</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">NamedValuesListIterable</span><span class=\"p\">(</span><span class=\"n\">ValuesListIterable</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Iterable returned by QuerySet.values_list(named=True) that yields a</span>\n<span class=\"sd\">    namedtuple for each row.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__iter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span>\n        <span class=\"k\">if</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">:</span>\n            <span class=\"n\">names</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_fields</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">query</span>\n            <span class=\"n\">names</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"o\">*</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">extra_select</span><span class=\"p\">,</span>\n                <span class=\"o\">*</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">values_select</span><span class=\"p\">,</span>\n                <span class=\"o\">*</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotation_select</span><span class=\"p\">,</span>\n            <span class=\"p\">]</span>\n        <span class=\"n\">tuple_class</span> <span class=\"o\">=</span> <span class=\"n\">create_namedtuple_class</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">names</span><span class=\"p\">)</span>\n        <span class=\"n\">new</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"o\">.</span><span class=\"fm\">__new__</span>\n        <span class=\"k\">for</span> <span class=\"n\">row</span> <span class=\"ow\">in</span> <span class=\"nb\">super</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"fm\">__iter__</span><span class=\"p\">():</span>\n            <span class=\"k\">yield</span> <span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">tuple_class</span><span class=\"p\">,</span> <span class=\"n\">row</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">FlatValuesListIterable</span><span class=\"p\">(</span><span class=\"n\">BaseIterable</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Iterable returned by QuerySet.values_list(flat=True) that yields single</span>\n<span class=\"sd\">    values.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__iter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span>\n        <span class=\"n\">compiler</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">row</span> <span class=\"ow\">in</span> <span class=\"n\">compiler</span><span class=\"o\">.</span><span class=\"n\">results_iter</span><span class=\"p\">(</span>\n            <span class=\"n\">chunked_fetch</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunked_fetch</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">chunk_size</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">yield</span> <span class=\"n\">row</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n\n<div class=\"viewcode-block\" id=\"QuerySet\"><a class=\"viewcode-back\" href=\"../../../../../ref/models/querysets/#django.db.models.query.QuerySet\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">QuerySet</span><span class=\"p\">(</span><span class=\"n\">AltersData</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Represent a lazy database lookup for a set of objects.&quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">query</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">hints</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span> <span class=\"o\">=</span> <span class=\"n\">model</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db</span> <span class=\"o\">=</span> <span class=\"n\">using</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_hints</span> <span class=\"o\">=</span> <span class=\"n\">hints</span> <span class=\"ow\">or</span> <span class=\"p\">{}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_query</span> <span class=\"o\">=</span> <span class=\"n\">query</span> <span class=\"ow\">or</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">Query</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_sticky_filter</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_done</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_known_related_objects</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>  <span class=\"c1\"># {rel_field: {pk: rel_obj}}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span> <span class=\"o\">=</span> <span class=\"n\">ModelIterable</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_defer_next_filter</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_deferred_filter</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_deferred_filter</span><span class=\"p\">:</span>\n            <span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_deferred_filter</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_filter_or_exclude_inplace</span><span class=\"p\">(</span><span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_deferred_filter</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_query</span>\n\n    <span class=\"nd\">@query</span><span class=\"o\">.</span><span class=\"n\">setter</span>\n    <span class=\"k\">def</span> <span class=\"nf\">query</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">value</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">value</span><span class=\"o\">.</span><span class=\"n\">values_select</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span> <span class=\"o\">=</span> <span class=\"n\">ValuesIterable</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_query</span> <span class=\"o\">=</span> <span class=\"n\">value</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">as_manager</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Address the circular dependency between `Queryset` and `Manager`.</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models.manager</span> <span class=\"kn\">import</span> <span class=\"n\">Manager</span>\n\n        <span class=\"n\">manager</span> <span class=\"o\">=</span> <span class=\"n\">Manager</span><span class=\"o\">.</span><span class=\"n\">from_queryset</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">)()</span>\n        <span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"n\">_built_with_as_manager</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">return</span> <span class=\"n\">manager</span>\n\n    <span class=\"n\">as_manager</span><span class=\"o\">.</span><span class=\"n\">queryset_only</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">as_manager</span> <span class=\"o\">=</span> <span class=\"nb\">classmethod</span><span class=\"p\">(</span><span class=\"n\">as_manager</span><span class=\"p\">)</span>\n\n    <span class=\"c1\">########################</span>\n    <span class=\"c1\"># PYTHON MAGIC METHODS #</span>\n    <span class=\"c1\">########################</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__deepcopy__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">memo</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Don&#39;t populate the QuerySet&#39;s cache.&quot;&quot;&quot;</span>\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">()</span>\n        <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">k</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;_result_cache&quot;</span><span class=\"p\">:</span>\n                <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">deepcopy</span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"p\">,</span> <span class=\"n\">memo</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__getstate__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Force the cache to be fully populated.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"o\">**</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"p\">,</span> <span class=\"n\">DJANGO_VERSION_PICKLE_KEY</span><span class=\"p\">:</span> <span class=\"n\">django</span><span class=\"o\">.</span><span class=\"n\">__version__</span><span class=\"p\">}</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__setstate__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">state</span><span class=\"p\">):</span>\n        <span class=\"n\">pickled_version</span> <span class=\"o\">=</span> <span class=\"n\">state</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">DJANGO_VERSION_PICKLE_KEY</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">pickled_version</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">pickled_version</span> <span class=\"o\">!=</span> <span class=\"n\">django</span><span class=\"o\">.</span><span class=\"n\">__version__</span><span class=\"p\">:</span>\n                <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Pickled queryset instance&#39;s Django version </span><span class=\"si\">%s</span><span class=\"s2\"> does not &quot;</span>\n                    <span class=\"s2\">&quot;match the current version </span><span class=\"si\">%s</span><span class=\"s2\">.&quot;</span>\n                    <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">pickled_version</span><span class=\"p\">,</span> <span class=\"n\">django</span><span class=\"o\">.</span><span class=\"n\">__version__</span><span class=\"p\">),</span>\n                    <span class=\"ne\">RuntimeWarning</span><span class=\"p\">,</span>\n                    <span class=\"n\">stacklevel</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">warnings</span><span class=\"o\">.</span><span class=\"n\">warn</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Pickled queryset instance&#39;s Django version is not specified.&quot;</span><span class=\"p\">,</span>\n                <span class=\"ne\">RuntimeWarning</span><span class=\"p\">,</span>\n                <span class=\"n\">stacklevel</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"p\">,</span>\n            <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__repr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">data</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">[:</span> <span class=\"n\">REPR_OUTPUT_SIZE</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">])</span>\n        <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"n\">REPR_OUTPUT_SIZE</span><span class=\"p\">:</span>\n            <span class=\"n\">data</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;...(remaining elements truncated)...&quot;</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;&lt;</span><span class=\"si\">%s</span><span class=\"s2\"> </span><span class=\"si\">%r</span><span class=\"s2\">&gt;&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__len__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__iter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        The queryset iterator protocol uses three nested iterators in the</span>\n<span class=\"sd\">        default case:</span>\n<span class=\"sd\">            1. sql.compiler.execute_sql()</span>\n<span class=\"sd\">               - Returns 100 rows at time (constants.GET_ITERATOR_CHUNK_SIZE)</span>\n<span class=\"sd\">                 using cursor.fetchmany(). This part is responsible for</span>\n<span class=\"sd\">                 doing some column masking, and returning the rows in chunks.</span>\n<span class=\"sd\">            2. sql.compiler.results_iter()</span>\n<span class=\"sd\">               - Returns one row at time. At this point the rows are still just</span>\n<span class=\"sd\">                 tuples. In some cases the return values are converted to</span>\n<span class=\"sd\">                 Python values at this location.</span>\n<span class=\"sd\">            3. self.iterator()</span>\n<span class=\"sd\">               - Responsible for turning the rows into model objects.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"nb\">iter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__aiter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Remember, __aiter__ itself is synchronous, it&#39;s the thing it returns</span>\n        <span class=\"c1\"># that is async!</span>\n        <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">generator</span><span class=\"p\">():</span>\n            <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">)()</span>\n            <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">:</span>\n                <span class=\"k\">yield</span> <span class=\"n\">item</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">generator</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__bool__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"nb\">bool</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__getitem__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Retrieve an item or slice from the set of results.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nb\">int</span><span class=\"p\">,</span> <span class=\"nb\">slice</span><span class=\"p\">)):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;QuerySet indices must be integers or slices, not </span><span class=\"si\">%s</span><span class=\"s2\">.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"nb\">type</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"nb\">int</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">k</span> <span class=\"o\">&lt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"ow\">or</span> <span class=\"p\">(</span>\n            <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"nb\">slice</span><span class=\"p\">)</span>\n            <span class=\"ow\">and</span> <span class=\"p\">(</span>\n                <span class=\"p\">(</span><span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">start</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">start</span> <span class=\"o\">&lt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n                <span class=\"ow\">or</span> <span class=\"p\">(</span><span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">stop</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">stop</span> <span class=\"o\">&lt;</span> <span class=\"mi\">0</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Negative indexing is not supported.&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]</span>\n\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"nb\">slice</span><span class=\"p\">):</span>\n            <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n            <span class=\"k\">if</span> <span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">start</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">start</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">start</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">start</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"k\">if</span> <span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">stop</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">stop</span> <span class=\"o\">=</span> <span class=\"nb\">int</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">stop</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">stop</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">set_limits</span><span class=\"p\">(</span><span class=\"n\">start</span><span class=\"p\">,</span> <span class=\"n\">stop</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">qs</span><span class=\"p\">)[::</span> <span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">step</span><span class=\"p\">]</span> <span class=\"k\">if</span> <span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">step</span> <span class=\"k\">else</span> <span class=\"n\">qs</span>\n\n        <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">set_limits</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">k</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n        <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__class_getitem__</span><span class=\"p\">(</span><span class=\"bp\">cls</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"bp\">cls</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__and__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_operator_queryset</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"s2\">&quot;&amp;&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_merge_sanity_check</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"n\">other</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span>\n        <span class=\"n\">combined</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">combined</span><span class=\"o\">.</span><span class=\"n\">_merge_known_related_objects</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n        <span class=\"n\">combined</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combine</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">AND</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">combined</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__or__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_operator_queryset</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"s2\">&quot;|&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_merge_sanity_check</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"n\">other</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">can_filter</span><span class=\"p\">()</span>\n            <span class=\"k\">else</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_base_manager</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pk__in</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">))</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">combined</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">combined</span><span class=\"o\">.</span><span class=\"n\">_merge_known_related_objects</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">can_filter</span><span class=\"p\">():</span>\n            <span class=\"n\">other</span> <span class=\"o\">=</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_base_manager</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pk__in</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">))</span>\n        <span class=\"n\">combined</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combine</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">OR</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">combined</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__xor__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_operator_queryset</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"s2\">&quot;^&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_merge_sanity_check</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"n\">other</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">can_filter</span><span class=\"p\">()</span>\n            <span class=\"k\">else</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_base_manager</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pk__in</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">))</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">combined</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">combined</span><span class=\"o\">.</span><span class=\"n\">_merge_known_related_objects</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">can_filter</span><span class=\"p\">():</span>\n            <span class=\"n\">other</span> <span class=\"o\">=</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_base_manager</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pk__in</span><span class=\"o\">=</span><span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">(</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">))</span>\n        <span class=\"n\">combined</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combine</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"p\">,</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">XOR</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">combined</span>\n\n    <span class=\"c1\">####################################</span>\n    <span class=\"c1\"># METHODS THAT DO DATABASE QUERIES #</span>\n    <span class=\"c1\">####################################</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_iterator</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">use_chunked_fetch</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"p\">):</span>\n        <span class=\"n\">iterable</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span>\n            <span class=\"n\">chunked_fetch</span><span class=\"o\">=</span><span class=\"n\">use_chunked_fetch</span><span class=\"p\">,</span>\n            <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"n\">chunk_size</span> <span class=\"ow\">or</span> <span class=\"mi\">2000</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"ow\">or</span> <span class=\"n\">chunk_size</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">yield from</span> <span class=\"n\">iterable</span>\n            <span class=\"k\">return</span>\n\n        <span class=\"n\">iterator</span> <span class=\"o\">=</span> <span class=\"nb\">iter</span><span class=\"p\">(</span><span class=\"n\">iterable</span><span class=\"p\">)</span>\n        <span class=\"k\">while</span> <span class=\"n\">results</span> <span class=\"o\">:=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">islice</span><span class=\"p\">(</span><span class=\"n\">iterator</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"p\">)):</span>\n            <span class=\"n\">prefetch_related_objects</span><span class=\"p\">(</span><span class=\"n\">results</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span><span class=\"p\">)</span>\n            <span class=\"k\">yield from</span> <span class=\"n\">results</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">iterator</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        An iterator over the results from applying this QuerySet to the</span>\n<span class=\"sd\">        database. chunk_size must be provided for QuerySets that prefetch</span>\n<span class=\"sd\">        related objects. Otherwise, a default chunk_size of 2000 is supplied.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">chunk_size</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;chunk_size must be provided when using QuerySet.iterator() after &quot;</span>\n                    <span class=\"s2\">&quot;prefetch_related().&quot;</span>\n                <span class=\"p\">)</span>\n        <span class=\"k\">elif</span> <span class=\"n\">chunk_size</span> <span class=\"o\">&lt;=</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Chunk size must be strictly positive.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">use_chunked_fetch</span> <span class=\"o\">=</span> <span class=\"ow\">not</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">settings_dict</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;DISABLE_SERVER_SIDE_CURSORS&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_iterator</span><span class=\"p\">(</span><span class=\"n\">use_chunked_fetch</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"p\">)</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">aiterator</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"mi\">2000</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        An asynchronous iterator over the results from applying this QuerySet</span>\n<span class=\"sd\">        to the database.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">NotSupportedError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Using QuerySet.aiterator() after prefetch_related() is not supported.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">chunk_size</span> <span class=\"o\">&lt;=</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Chunk size must be strictly positive.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">use_chunked_fetch</span> <span class=\"o\">=</span> <span class=\"ow\">not</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">settings_dict</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;DISABLE_SERVER_SIDE_CURSORS&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">async</span> <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">chunked_fetch</span><span class=\"o\">=</span><span class=\"n\">use_chunked_fetch</span><span class=\"p\">,</span> <span class=\"n\">chunk_size</span><span class=\"o\">=</span><span class=\"n\">chunk_size</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">yield</span> <span class=\"n\">item</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">aggregate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a dictionary containing the calculations (aggregation)</span>\n<span class=\"sd\">        over the current queryset.</span>\n\n<span class=\"sd\">        If args is present the expression is passed as a kwarg using</span>\n<span class=\"sd\">        the Aggregate object&#39;s default alias.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">distinct_fields</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">NotImplementedError</span><span class=\"p\">(</span><span class=\"s2\">&quot;aggregate() + distinct(fields) not implemented.&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_validate_values_are_expressions</span><span class=\"p\">(</span>\n            <span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">kwargs</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">()),</span> <span class=\"n\">method_name</span><span class=\"o\">=</span><span class=\"s2\">&quot;aggregate&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">arg</span> <span class=\"ow\">in</span> <span class=\"n\">args</span><span class=\"p\">:</span>\n            <span class=\"c1\"># The default_alias property raises TypeError if default_alias</span>\n            <span class=\"c1\"># can&#39;t be set automatically or AttributeError if it isn&#39;t an</span>\n            <span class=\"c1\"># attribute.</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">arg</span><span class=\"o\">.</span><span class=\"n\">default_alias</span>\n            <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">AttributeError</span><span class=\"p\">,</span> <span class=\"ne\">TypeError</span><span class=\"p\">):</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Complex aggregates require an alias&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">kwargs</span><span class=\"p\">[</span><span class=\"n\">arg</span><span class=\"o\">.</span><span class=\"n\">default_alias</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">arg</span>\n\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">chain</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_aggregation</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">aaggregate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">aggregate</span><span class=\"p\">)(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">count</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Perform a SELECT COUNT() and return the number of records as an</span>\n<span class=\"sd\">        integer.</span>\n\n<span class=\"sd\">        If the QuerySet is already fully cached, return the length of the</span>\n<span class=\"sd\">        cached results set to avoid multiple SELECT COUNT(*) calls.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">)</span>\n\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_count</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">acount</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">count</span><span class=\"p\">)()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Perform the query and return a single object matching the given</span>\n<span class=\"sd\">        keyword arguments.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combinator</span> <span class=\"ow\">and</span> <span class=\"p\">(</span><span class=\"n\">args</span> <span class=\"ow\">or</span> <span class=\"n\">kwargs</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"n\">NotSupportedError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Calling QuerySet.get(...) with filters after </span><span class=\"si\">%s</span><span class=\"s2\">() is not &quot;</span>\n                <span class=\"s2\">&quot;supported.&quot;</span> <span class=\"o\">%</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combinator</span>\n            <span class=\"p\">)</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combinator</span> <span class=\"k\">else</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">can_filter</span><span class=\"p\">()</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">distinct_fields</span><span class=\"p\">:</span>\n            <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">()</span>\n        <span class=\"n\">limit</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"ow\">not</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_for_update</span>\n            <span class=\"ow\">or</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_select_for_update_with_limit</span>\n        <span class=\"p\">):</span>\n            <span class=\"n\">limit</span> <span class=\"o\">=</span> <span class=\"n\">MAX_GET_RESULTS</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">set_limits</span><span class=\"p\">(</span><span class=\"n\">high</span><span class=\"o\">=</span><span class=\"n\">limit</span><span class=\"p\">)</span>\n        <span class=\"n\">num</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">clone</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">num</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">num</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;</span><span class=\"si\">%s</span><span class=\"s2\"> matching query does not exist.&quot;</span> <span class=\"o\">%</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">raise</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">MultipleObjectsReturned</span><span class=\"p\">(</span>\n            <span class=\"s2\">&quot;get() returned more than one </span><span class=\"si\">%s</span><span class=\"s2\"> -- it returned </span><span class=\"si\">%s</span><span class=\"s2\">!&quot;</span>\n            <span class=\"o\">%</span> <span class=\"p\">(</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span><span class=\"p\">,</span>\n                <span class=\"n\">num</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">limit</span> <span class=\"ow\">or</span> <span class=\"n\">num</span> <span class=\"o\">&lt;</span> <span class=\"n\">limit</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;more than </span><span class=\"si\">%s</span><span class=\"s2\">&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">limit</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">aget</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">)(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">create</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Create a new object with the given kwargs, saving it to the database</span>\n<span class=\"sd\">        and returning the created object.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">force_insert</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">acreate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">)(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_prepare_for_bulk_create</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">objs</span><span class=\"p\">):</span>\n        <span class=\"kn\">from</span> <span class=\"nn\">django.db.models.expressions</span> <span class=\"kn\">import</span> <span class=\"n\">DatabaseDefault</span>\n\n        <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span>\n        <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">objs</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">pk</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Populate new PK values.</span>\n                <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">pk</span> <span class=\"o\">=</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">get_pk_value_on_save</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">supports_default_keyword_in_bulk_insert</span><span class=\"p\">:</span>\n                <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n                    <span class=\"n\">value</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">)</span>\n                    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">value</span><span class=\"p\">,</span> <span class=\"n\">DatabaseDefault</span><span class=\"p\">):</span>\n                        <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">db_default</span><span class=\"p\">)</span>\n\n            <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_prepare_related_fields_for_save</span><span class=\"p\">(</span><span class=\"n\">operation_name</span><span class=\"o\">=</span><span class=\"s2\">&quot;bulk_create&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_check_bulk_create_options</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">ignore_conflicts</span><span class=\"p\">,</span> <span class=\"n\">update_conflicts</span><span class=\"p\">,</span> <span class=\"n\">update_fields</span><span class=\"p\">,</span> <span class=\"n\">unique_fields</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">ignore_conflicts</span> <span class=\"ow\">and</span> <span class=\"n\">update_conflicts</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;ignore_conflicts and update_conflicts are mutually exclusive.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"n\">db_features</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">features</span>\n        <span class=\"k\">if</span> <span class=\"n\">ignore_conflicts</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">db_features</span><span class=\"o\">.</span><span class=\"n\">supports_ignore_conflicts</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">NotSupportedError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;This database backend does not support ignoring conflicts.&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">OnConflict</span><span class=\"o\">.</span><span class=\"n\">IGNORE</span>\n        <span class=\"k\">elif</span> <span class=\"n\">update_conflicts</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">db_features</span><span class=\"o\">.</span><span class=\"n\">supports_update_conflicts</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">NotSupportedError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;This database backend does not support updating conflicts.&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">update_fields</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Fields that will be updated when a row insertion fails &quot;</span>\n                    <span class=\"s2\">&quot;on conflicts must be provided.&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">unique_fields</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">db_features</span><span class=\"o\">.</span><span class=\"n\">supports_update_conflicts_with_target</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"n\">NotSupportedError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;This database backend does not support updating &quot;</span>\n                    <span class=\"s2\">&quot;conflicts with specifying unique fields that can trigger &quot;</span>\n                    <span class=\"s2\">&quot;the upsert.&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">unique_fields</span> <span class=\"ow\">and</span> <span class=\"n\">db_features</span><span class=\"o\">.</span><span class=\"n\">supports_update_conflicts_with_target</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Unique fields that can trigger the upsert must be provided.&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"c1\"># Updating primary keys and non-concrete fields is forbidden.</span>\n            <span class=\"k\">if</span> <span class=\"nb\">any</span><span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">concrete</span> <span class=\"ow\">or</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">update_fields</span><span class=\"p\">):</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;bulk_create() can only be used with concrete fields in &quot;</span>\n                    <span class=\"s2\">&quot;update_fields.&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"nb\">any</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">primary_key</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">update_fields</span><span class=\"p\">):</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;bulk_create() cannot be used with primary keys in &quot;</span>\n                    <span class=\"s2\">&quot;update_fields.&quot;</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">unique_fields</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"nb\">any</span><span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">concrete</span> <span class=\"ow\">or</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">unique_fields</span><span class=\"p\">):</span>\n                    <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;bulk_create() can only be used with concrete fields &quot;</span>\n                        <span class=\"s2\">&quot;in unique_fields.&quot;</span>\n                    <span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">OnConflict</span><span class=\"o\">.</span><span class=\"n\">UPDATE</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">bulk_create</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">objs</span><span class=\"p\">,</span>\n        <span class=\"n\">batch_size</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">ignore_conflicts</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">update_conflicts</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">unique_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Insert each of the instances into the database. Do *not* call</span>\n<span class=\"sd\">        save() on each of the instances, do not send any pre/post_save</span>\n<span class=\"sd\">        signals, and do not set the primary key attribute if it is an</span>\n<span class=\"sd\">        autoincrement field (except if features.can_return_rows_from_bulk_insert=True).</span>\n<span class=\"sd\">        Multi-table models are not supported.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># When you bulk insert you don&#39;t get the primary keys back (if it&#39;s an</span>\n        <span class=\"c1\"># autoincrement, except if can_return_rows_from_bulk_insert=True), so</span>\n        <span class=\"c1\"># you can&#39;t insert into the child tables which references this. There</span>\n        <span class=\"c1\"># are two workarounds:</span>\n        <span class=\"c1\"># 1) This could be implemented if you didn&#39;t have an autoincrement pk</span>\n        <span class=\"c1\"># 2) You could do it by doing O(n) normal inserts into the parent</span>\n        <span class=\"c1\">#    tables to get the primary keys back and then doing a single bulk</span>\n        <span class=\"c1\">#    insert into the childmost table.</span>\n        <span class=\"c1\"># We currently set the primary keys on the objects when using</span>\n        <span class=\"c1\"># PostgreSQL via the RETURNING ID clause. It should be possible for</span>\n        <span class=\"c1\"># Oracle as well, but the semantics for extracting the primary keys is</span>\n        <span class=\"c1\"># trickier so it&#39;s not done yet.</span>\n        <span class=\"k\">if</span> <span class=\"n\">batch_size</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">batch_size</span> <span class=\"o\">&lt;=</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Batch size must be a positive integer.&quot;</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Check that the parents share the same concrete model with the our</span>\n        <span class=\"c1\"># model to detect the inheritance pattern ConcreteGrandParent -&gt;</span>\n        <span class=\"c1\"># MultiTableParent -&gt; ProxyChild. Simply checking self.model._meta.proxy</span>\n        <span class=\"c1\"># would not identify that case as involving multiple tables.</span>\n        <span class=\"k\">for</span> <span class=\"n\">parent</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_parent_list</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">parent</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">concrete_model</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">concrete_model</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Can&#39;t bulk create a multi-table inherited model&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">objs</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">objs</span>\n        <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n        <span class=\"k\">if</span> <span class=\"n\">unique_fields</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Primary key is allowed in unique_fields.</span>\n            <span class=\"n\">unique_fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"k\">if</span> <span class=\"n\">name</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;pk&quot;</span> <span class=\"k\">else</span> <span class=\"n\">name</span><span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">unique_fields</span>\n            <span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">update_fields</span><span class=\"p\">:</span>\n            <span class=\"n\">update_fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">update_fields</span><span class=\"p\">]</span>\n        <span class=\"n\">on_conflict</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_bulk_create_options</span><span class=\"p\">(</span>\n            <span class=\"n\">ignore_conflicts</span><span class=\"p\">,</span>\n            <span class=\"n\">update_conflicts</span><span class=\"p\">,</span>\n            <span class=\"n\">update_fields</span><span class=\"p\">,</span>\n            <span class=\"n\">unique_fields</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">concrete_fields</span>\n        <span class=\"n\">objs</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">objs</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prepare_for_bulk_create</span><span class=\"p\">(</span><span class=\"n\">objs</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"n\">savepoint</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n            <span class=\"n\">objs_with_pk</span><span class=\"p\">,</span> <span class=\"n\">objs_without_pk</span> <span class=\"o\">=</span> <span class=\"n\">partition</span><span class=\"p\">(</span><span class=\"k\">lambda</span> <span class=\"n\">o</span><span class=\"p\">:</span> <span class=\"n\">o</span><span class=\"o\">.</span><span class=\"n\">pk</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">objs</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">objs_with_pk</span><span class=\"p\">:</span>\n                <span class=\"n\">returned_columns</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_batched_insert</span><span class=\"p\">(</span>\n                    <span class=\"n\">objs_with_pk</span><span class=\"p\">,</span>\n                    <span class=\"n\">fields</span><span class=\"p\">,</span>\n                    <span class=\"n\">batch_size</span><span class=\"p\">,</span>\n                    <span class=\"n\">on_conflict</span><span class=\"o\">=</span><span class=\"n\">on_conflict</span><span class=\"p\">,</span>\n                    <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"n\">update_fields</span><span class=\"p\">,</span>\n                    <span class=\"n\">unique_fields</span><span class=\"o\">=</span><span class=\"n\">unique_fields</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">obj_with_pk</span><span class=\"p\">,</span> <span class=\"n\">results</span> <span class=\"ow\">in</span> <span class=\"nb\">zip</span><span class=\"p\">(</span><span class=\"n\">objs_with_pk</span><span class=\"p\">,</span> <span class=\"n\">returned_columns</span><span class=\"p\">):</span>\n                    <span class=\"k\">for</span> <span class=\"n\">result</span><span class=\"p\">,</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"nb\">zip</span><span class=\"p\">(</span><span class=\"n\">results</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">db_returning_fields</span><span class=\"p\">):</span>\n                        <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"o\">!=</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"p\">:</span>\n                            <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">obj_with_pk</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">,</span> <span class=\"n\">result</span><span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">obj_with_pk</span> <span class=\"ow\">in</span> <span class=\"n\">objs_with_pk</span><span class=\"p\">:</span>\n                    <span class=\"n\">obj_with_pk</span><span class=\"o\">.</span><span class=\"n\">_state</span><span class=\"o\">.</span><span class=\"n\">adding</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n                    <span class=\"n\">obj_with_pk</span><span class=\"o\">.</span><span class=\"n\">_state</span><span class=\"o\">.</span><span class=\"n\">db</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span>\n            <span class=\"k\">if</span> <span class=\"n\">objs_without_pk</span><span class=\"p\">:</span>\n                <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">f</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"n\">AutoField</span><span class=\"p\">)]</span>\n                <span class=\"n\">returned_columns</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_batched_insert</span><span class=\"p\">(</span>\n                    <span class=\"n\">objs_without_pk</span><span class=\"p\">,</span>\n                    <span class=\"n\">fields</span><span class=\"p\">,</span>\n                    <span class=\"n\">batch_size</span><span class=\"p\">,</span>\n                    <span class=\"n\">on_conflict</span><span class=\"o\">=</span><span class=\"n\">on_conflict</span><span class=\"p\">,</span>\n                    <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"n\">update_fields</span><span class=\"p\">,</span>\n                    <span class=\"n\">unique_fields</span><span class=\"o\">=</span><span class=\"n\">unique_fields</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n                <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span>\n                <span class=\"k\">if</span> <span class=\"p\">(</span>\n                    <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">can_return_rows_from_bulk_insert</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">on_conflict</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span>\n                <span class=\"p\">):</span>\n                    <span class=\"k\">assert</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">returned_columns</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">objs_without_pk</span><span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">obj_without_pk</span><span class=\"p\">,</span> <span class=\"n\">results</span> <span class=\"ow\">in</span> <span class=\"nb\">zip</span><span class=\"p\">(</span><span class=\"n\">objs_without_pk</span><span class=\"p\">,</span> <span class=\"n\">returned_columns</span><span class=\"p\">):</span>\n                    <span class=\"k\">for</span> <span class=\"n\">result</span><span class=\"p\">,</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"nb\">zip</span><span class=\"p\">(</span><span class=\"n\">results</span><span class=\"p\">,</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">db_returning_fields</span><span class=\"p\">):</span>\n                        <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">obj_without_pk</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">,</span> <span class=\"n\">result</span><span class=\"p\">)</span>\n                    <span class=\"n\">obj_without_pk</span><span class=\"o\">.</span><span class=\"n\">_state</span><span class=\"o\">.</span><span class=\"n\">adding</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n                    <span class=\"n\">obj_without_pk</span><span class=\"o\">.</span><span class=\"n\">_state</span><span class=\"o\">.</span><span class=\"n\">db</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">objs</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">abulk_create</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">objs</span><span class=\"p\">,</span>\n        <span class=\"n\">batch_size</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">ignore_conflicts</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">update_conflicts</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">unique_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">bulk_create</span><span class=\"p\">)(</span>\n            <span class=\"n\">objs</span><span class=\"o\">=</span><span class=\"n\">objs</span><span class=\"p\">,</span>\n            <span class=\"n\">batch_size</span><span class=\"o\">=</span><span class=\"n\">batch_size</span><span class=\"p\">,</span>\n            <span class=\"n\">ignore_conflicts</span><span class=\"o\">=</span><span class=\"n\">ignore_conflicts</span><span class=\"p\">,</span>\n            <span class=\"n\">update_conflicts</span><span class=\"o\">=</span><span class=\"n\">update_conflicts</span><span class=\"p\">,</span>\n            <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"n\">update_fields</span><span class=\"p\">,</span>\n            <span class=\"n\">unique_fields</span><span class=\"o\">=</span><span class=\"n\">unique_fields</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">bulk_update</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">objs</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">batch_size</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Update the given fields in each of the given objects in the database.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">batch_size</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"n\">batch_size</span> <span class=\"o\">&lt;=</span> <span class=\"mi\">0</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Batch size must be a positive integer.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Field names must be given to bulk_update().&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">objs</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">objs</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">any</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">pk</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span> <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">objs</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;All bulk_update() objects must have a primary key set.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">name</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">name</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"nb\">any</span><span class=\"p\">(</span><span class=\"ow\">not</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">concrete</span> <span class=\"ow\">or</span> <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">many_to_many</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;bulk_update() can only be used with concrete fields.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"nb\">any</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">primary_key</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;bulk_update() cannot be used with primary key fields.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">objs</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"mi\">0</span>\n        <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">objs</span><span class=\"p\">:</span>\n            <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_prepare_related_fields_for_save</span><span class=\"p\">(</span>\n                <span class=\"n\">operation_name</span><span class=\"o\">=</span><span class=\"s2\">&quot;bulk_update&quot;</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"n\">fields</span>\n            <span class=\"p\">)</span>\n        <span class=\"c1\"># PK is used twice in the resulting update query, once in the filter</span>\n        <span class=\"c1\"># and once in the WHEN. Each field will also have one CAST.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span>\n        <span class=\"n\">max_batch_size</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">bulk_batch_size</span><span class=\"p\">([</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">objs</span><span class=\"p\">)</span>\n        <span class=\"n\">batch_size</span> <span class=\"o\">=</span> <span class=\"nb\">min</span><span class=\"p\">(</span><span class=\"n\">batch_size</span><span class=\"p\">,</span> <span class=\"n\">max_batch_size</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">batch_size</span> <span class=\"k\">else</span> <span class=\"n\">max_batch_size</span>\n        <span class=\"n\">requires_casting</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">requires_casted_case_in_updates</span>\n        <span class=\"n\">batches</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">objs</span><span class=\"p\">[</span><span class=\"n\">i</span> <span class=\"p\">:</span> <span class=\"n\">i</span> <span class=\"o\">+</span> <span class=\"n\">batch_size</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">objs</span><span class=\"p\">),</span> <span class=\"n\">batch_size</span><span class=\"p\">))</span>\n        <span class=\"n\">updates</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">batch_objs</span> <span class=\"ow\">in</span> <span class=\"n\">batches</span><span class=\"p\">:</span>\n            <span class=\"n\">update_kwargs</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n            <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n                <span class=\"n\">when_statements</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n                <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">batch_objs</span><span class=\"p\">:</span>\n                    <span class=\"n\">attr</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">)</span>\n                    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">attr</span><span class=\"p\">,</span> <span class=\"s2\">&quot;resolve_expression&quot;</span><span class=\"p\">):</span>\n                        <span class=\"n\">attr</span> <span class=\"o\">=</span> <span class=\"n\">Value</span><span class=\"p\">(</span><span class=\"n\">attr</span><span class=\"p\">,</span> <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"n\">field</span><span class=\"p\">)</span>\n                    <span class=\"n\">when_statements</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">When</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"p\">,</span> <span class=\"n\">then</span><span class=\"o\">=</span><span class=\"n\">attr</span><span class=\"p\">))</span>\n                <span class=\"n\">case_statement</span> <span class=\"o\">=</span> <span class=\"n\">Case</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">when_statements</span><span class=\"p\">,</span> <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"n\">field</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">requires_casting</span><span class=\"p\">:</span>\n                    <span class=\"n\">case_statement</span> <span class=\"o\">=</span> <span class=\"n\">Cast</span><span class=\"p\">(</span><span class=\"n\">case_statement</span><span class=\"p\">,</span> <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"n\">field</span><span class=\"p\">)</span>\n                <span class=\"n\">update_kwargs</span><span class=\"p\">[</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">case_statement</span>\n            <span class=\"n\">updates</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(([</span><span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">pk</span> <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">batch_objs</span><span class=\"p\">],</span> <span class=\"n\">update_kwargs</span><span class=\"p\">))</span>\n        <span class=\"n\">rows_updated</span> <span class=\"o\">=</span> <span class=\"mi\">0</span>\n        <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">using</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"k\">with</span> <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"n\">savepoint</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n            <span class=\"k\">for</span> <span class=\"n\">pks</span><span class=\"p\">,</span> <span class=\"n\">update_kwargs</span> <span class=\"ow\">in</span> <span class=\"n\">updates</span><span class=\"p\">:</span>\n                <span class=\"n\">rows_updated</span> <span class=\"o\">+=</span> <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pk__in</span><span class=\"o\">=</span><span class=\"n\">pks</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">update_kwargs</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">rows_updated</span>\n\n    <span class=\"n\">bulk_update</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">abulk_update</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">objs</span><span class=\"p\">,</span> <span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">batch_size</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">bulk_update</span><span class=\"p\">)(</span>\n            <span class=\"n\">objs</span><span class=\"o\">=</span><span class=\"n\">objs</span><span class=\"p\">,</span>\n            <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"n\">fields</span><span class=\"p\">,</span>\n            <span class=\"n\">batch_size</span><span class=\"o\">=</span><span class=\"n\">batch_size</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"n\">abulk_update</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_or_create</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">defaults</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Look up an object with the given kwargs, creating one if necessary.</span>\n<span class=\"sd\">        Return a tuple of (object, created), where created is a boolean</span>\n<span class=\"sd\">        specifying whether an object was created.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"c1\"># The get() needs to be targeted at the write database in order</span>\n        <span class=\"c1\"># to avoid potential transaction consistency problems.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">),</span> <span class=\"kc\">False</span>\n        <span class=\"k\">except</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n            <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_extract_model_params</span><span class=\"p\">(</span><span class=\"n\">defaults</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n            <span class=\"c1\"># Try to create an object using passed params.</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"k\">with</span> <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">):</span>\n                    <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"nb\">dict</span><span class=\"p\">(</span><span class=\"n\">resolve_callables</span><span class=\"p\">(</span><span class=\"n\">params</span><span class=\"p\">))</span>\n                    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">params</span><span class=\"p\">),</span> <span class=\"kc\">True</span>\n            <span class=\"k\">except</span> <span class=\"n\">IntegrityError</span><span class=\"p\">:</span>\n                <span class=\"k\">try</span><span class=\"p\">:</span>\n                    <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">),</span> <span class=\"kc\">False</span>\n                <span class=\"k\">except</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">DoesNotExist</span><span class=\"p\">:</span>\n                    <span class=\"k\">pass</span>\n                <span class=\"k\">raise</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">aget_or_create</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">defaults</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_or_create</span><span class=\"p\">)(</span>\n            <span class=\"n\">defaults</span><span class=\"o\">=</span><span class=\"n\">defaults</span><span class=\"p\">,</span>\n            <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">update_or_create</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">defaults</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">create_defaults</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Look up an object with the given kwargs, updating one with defaults</span>\n<span class=\"sd\">        if it exists, otherwise create a new one. Optionally, an object can</span>\n<span class=\"sd\">        be created with different values than defaults by using</span>\n<span class=\"sd\">        create_defaults.</span>\n<span class=\"sd\">        Return a tuple (object, created), where created is a boolean</span>\n<span class=\"sd\">        specifying whether an object was created.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">create_defaults</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">update_defaults</span> <span class=\"o\">=</span> <span class=\"n\">create_defaults</span> <span class=\"o\">=</span> <span class=\"n\">defaults</span> <span class=\"ow\">or</span> <span class=\"p\">{}</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">update_defaults</span> <span class=\"o\">=</span> <span class=\"n\">defaults</span> <span class=\"ow\">or</span> <span class=\"p\">{}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">with</span> <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"n\">atomic</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">):</span>\n            <span class=\"c1\"># Lock the row so that a concurrent update is blocked until</span>\n            <span class=\"c1\"># update_or_create() has performed its save.</span>\n            <span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">created</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">select_for_update</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">get_or_create</span><span class=\"p\">(</span>\n                <span class=\"n\">create_defaults</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span>\n            <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">created</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">created</span>\n            <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">resolve_callables</span><span class=\"p\">(</span><span class=\"n\">update_defaults</span><span class=\"p\">):</span>\n                <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span><span class=\"p\">)</span>\n\n            <span class=\"n\">update_fields</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">update_defaults</span><span class=\"p\">)</span>\n            <span class=\"n\">concrete_field_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">_non_pk_concrete_field_names</span>\n            <span class=\"c1\"># update_fields does not support non-concrete fields.</span>\n            <span class=\"k\">if</span> <span class=\"n\">concrete_field_names</span><span class=\"o\">.</span><span class=\"n\">issuperset</span><span class=\"p\">(</span><span class=\"n\">update_fields</span><span class=\"p\">):</span>\n                <span class=\"c1\"># Add fields which are set on pre_save(), e.g. auto_now fields.</span>\n                <span class=\"c1\"># This is to maintain backward compatibility as these fields</span>\n                <span class=\"c1\"># are not updated unless explicitly specified in the</span>\n                <span class=\"c1\"># update_fields list.</span>\n                <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">local_concrete_fields</span><span class=\"p\">:</span>\n                    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span>\n                        <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">primary_key</span> <span class=\"ow\">or</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"n\">pre_save</span> <span class=\"ow\">is</span> <span class=\"n\">Field</span><span class=\"o\">.</span><span class=\"n\">pre_save</span>\n                    <span class=\"p\">):</span>\n                        <span class=\"n\">update_fields</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">)</span>\n                        <span class=\"k\">if</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span> <span class=\"o\">!=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">:</span>\n                            <span class=\"n\">update_fields</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">)</span>\n                <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"n\">update_fields</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">save</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"kc\">False</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">aupdate_or_create</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">defaults</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">create_defaults</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">update_or_create</span><span class=\"p\">)(</span>\n            <span class=\"n\">defaults</span><span class=\"o\">=</span><span class=\"n\">defaults</span><span class=\"p\">,</span>\n            <span class=\"n\">create_defaults</span><span class=\"o\">=</span><span class=\"n\">create_defaults</span><span class=\"p\">,</span>\n            <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_extract_model_params</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">defaults</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Prepare `params` for creating a model instance based on the given</span>\n<span class=\"sd\">        kwargs; for use by get_or_create().</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">defaults</span> <span class=\"o\">=</span> <span class=\"n\">defaults</span> <span class=\"ow\">or</span> <span class=\"p\">{}</span>\n        <span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"n\">v</span> <span class=\"k\">for</span> <span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">v</span> <span class=\"ow\">in</span> <span class=\"n\">kwargs</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">()</span> <span class=\"k\">if</span> <span class=\"n\">LOOKUP_SEP</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">k</span><span class=\"p\">}</span>\n        <span class=\"n\">params</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">defaults</span><span class=\"p\">)</span>\n        <span class=\"n\">property_names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">_property_names</span>\n        <span class=\"n\">invalid_params</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">param</span> <span class=\"ow\">in</span> <span class=\"n\">params</span><span class=\"p\">:</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">param</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"n\">exceptions</span><span class=\"o\">.</span><span class=\"n\">FieldDoesNotExist</span><span class=\"p\">:</span>\n                <span class=\"c1\"># It&#39;s okay to use a model&#39;s property if it has a setter.</span>\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span><span class=\"n\">param</span> <span class=\"ow\">in</span> <span class=\"n\">property_names</span> <span class=\"ow\">and</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"n\">param</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">fset</span><span class=\"p\">):</span>\n                    <span class=\"n\">invalid_params</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">param</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">invalid_params</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">exceptions</span><span class=\"o\">.</span><span class=\"n\">FieldError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Invalid field name(s) for model </span><span class=\"si\">%s</span><span class=\"s2\">: &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39;.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">object_name</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;&#39;, &#39;&quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"n\">invalid_params</span><span class=\"p\">)),</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">params</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_earliest</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return the earliest object according to fields (if given) or by the</span>\n<span class=\"sd\">        model&#39;s Meta.get_latest_by.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"n\">order_by</span> <span class=\"o\">=</span> <span class=\"n\">fields</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">order_by</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"p\">,</span> <span class=\"s2\">&quot;get_latest_by&quot;</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">order_by</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">order_by</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nb\">tuple</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">)):</span>\n                <span class=\"n\">order_by</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">order_by</span><span class=\"p\">,)</span>\n        <span class=\"k\">if</span> <span class=\"n\">order_by</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;earliest() and latest() require either fields as positional &quot;</span>\n                <span class=\"s2\">&quot;arguments or &#39;get_latest_by&#39; in the model&#39;s Meta.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">set_limits</span><span class=\"p\">(</span><span class=\"n\">high</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">clear_ordering</span><span class=\"p\">(</span><span class=\"n\">force</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_ordering</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">order_by</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">earliest</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot change a query once a slice has been taken.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_earliest</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">aearliest</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">earliest</span><span class=\"p\">)(</span><span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">latest</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return the latest object according to fields (if given) or by the</span>\n<span class=\"sd\">        model&#39;s Meta.get_latest_by.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot change a query once a slice has been taken.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reverse</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">_earliest</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">alatest</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">latest</span><span class=\"p\">)(</span><span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">first</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return the first object of a query or None if no match is found.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">ordered</span><span class=\"p\">:</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_ordering_first_last_queryset_aggregation</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"o\">=</span><span class=\"s2\">&quot;first&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">queryset</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">]:</span>\n            <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">afirst</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">)()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">last</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return the last object of a query or None if no match is found.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">ordered</span><span class=\"p\">:</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reverse</span><span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_check_ordering_first_last_queryset_aggregation</span><span class=\"p\">(</span><span class=\"n\">method</span><span class=\"o\">=</span><span class=\"s2\">&quot;last&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">(</span><span class=\"s2\">&quot;-pk&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">queryset</span><span class=\"p\">[:</span><span class=\"mi\">1</span><span class=\"p\">]:</span>\n            <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">alast</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">last</span><span class=\"p\">)()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">in_bulk</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">id_list</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"n\">field_name</span><span class=\"o\">=</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a dictionary mapping each of the given IDs to the object with</span>\n<span class=\"sd\">        that ID. If `id_list` isn&#39;t provided, evaluate the entire QuerySet.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot use &#39;limit&#39; or &#39;offset&#39; with in_bulk().&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">opts</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span>\n        <span class=\"n\">unique_fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"n\">constraint</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n            <span class=\"k\">for</span> <span class=\"n\">constraint</span> <span class=\"ow\">in</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">total_unique_constraints</span>\n            <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">constraint</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">1</span>\n        <span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span>\n            <span class=\"n\">field_name</span> <span class=\"o\">!=</span> <span class=\"s2\">&quot;pk&quot;</span>\n            <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">opts</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">field_name</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">unique</span>\n            <span class=\"ow\">and</span> <span class=\"n\">field_name</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">unique_fields</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">distinct_fields</span> <span class=\"o\">!=</span> <span class=\"p\">(</span><span class=\"n\">field_name</span><span class=\"p\">,)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;in_bulk()&#39;s field_name must be a unique field but </span><span class=\"si\">%r</span><span class=\"s2\"> isn&#39;t.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"n\">field_name</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">id_list</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">id_list</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"p\">{}</span>\n            <span class=\"n\">filter_key</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;</span><span class=\"si\">{}</span><span class=\"s2\">__in&quot;</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">field_name</span><span class=\"p\">)</span>\n            <span class=\"n\">batch_size</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">max_query_params</span>\n            <span class=\"n\">id_list</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">id_list</span><span class=\"p\">)</span>\n            <span class=\"c1\"># If the database has a limit on the number of query parameters</span>\n            <span class=\"c1\"># (e.g. SQLite), retrieve objects in batches if necessary.</span>\n            <span class=\"k\">if</span> <span class=\"n\">batch_size</span> <span class=\"ow\">and</span> <span class=\"n\">batch_size</span> <span class=\"o\">&lt;</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">id_list</span><span class=\"p\">):</span>\n                <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"p\">()</span>\n                <span class=\"k\">for</span> <span class=\"n\">offset</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">id_list</span><span class=\"p\">),</span> <span class=\"n\">batch_size</span><span class=\"p\">):</span>\n                    <span class=\"n\">batch</span> <span class=\"o\">=</span> <span class=\"n\">id_list</span><span class=\"p\">[</span><span class=\"n\">offset</span> <span class=\"p\">:</span> <span class=\"n\">offset</span> <span class=\"o\">+</span> <span class=\"n\">batch_size</span><span class=\"p\">]</span>\n                    <span class=\"n\">qs</span> <span class=\"o\">+=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"p\">{</span><span class=\"n\">filter_key</span><span class=\"p\">:</span> <span class=\"n\">batch</span><span class=\"p\">}))</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"p\">{</span><span class=\"n\">filter_key</span><span class=\"p\">:</span> <span class=\"n\">id_list</span><span class=\"p\">})</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"p\">{</span><span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">field_name</span><span class=\"p\">):</span> <span class=\"n\">obj</span> <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">qs</span><span class=\"p\">}</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">ain_bulk</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">id_list</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"n\">field_name</span><span class=\"o\">=</span><span class=\"s2\">&quot;pk&quot;</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">in_bulk</span><span class=\"p\">)(</span>\n            <span class=\"n\">id_list</span><span class=\"o\">=</span><span class=\"n\">id_list</span><span class=\"p\">,</span>\n            <span class=\"n\">field_name</span><span class=\"o\">=</span><span class=\"n\">field_name</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">delete</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Delete the records in the current QuerySet.&quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;delete&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot use &#39;limit&#39; or &#39;offset&#39; with delete().&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">distinct</span> <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">distinct_fields</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot call delete() after .distinct().&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot call delete() after .values() or .values_list()&quot;</span><span class=\"p\">)</span>\n\n        <span class=\"n\">del_query</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># The delete is actually 2 queries - one to find related objects,</span>\n        <span class=\"c1\"># and one to delete. Make sure that the discovery of related</span>\n        <span class=\"c1\"># objects is performed on the same database as the deletion.</span>\n        <span class=\"n\">del_query</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n        <span class=\"c1\"># Disable non-supported fields.</span>\n        <span class=\"n\">del_query</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_for_update</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"n\">del_query</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_related</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"n\">del_query</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">clear_ordering</span><span class=\"p\">(</span><span class=\"n\">force</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n        <span class=\"n\">collector</span> <span class=\"o\">=</span> <span class=\"n\">Collector</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">del_query</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"n\">origin</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n        <span class=\"n\">collector</span><span class=\"o\">.</span><span class=\"n\">collect</span><span class=\"p\">(</span><span class=\"n\">del_query</span><span class=\"p\">)</span>\n        <span class=\"n\">deleted</span><span class=\"p\">,</span> <span class=\"n\">_rows_count</span> <span class=\"o\">=</span> <span class=\"n\">collector</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">()</span>\n\n        <span class=\"c1\"># Clear the result cache, in case this QuerySet gets reused.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"n\">deleted</span><span class=\"p\">,</span> <span class=\"n\">_rows_count</span>\n\n    <span class=\"n\">delete</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">delete</span><span class=\"o\">.</span><span class=\"n\">queryset_only</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">adelete</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">delete</span><span class=\"p\">)()</span>\n\n    <span class=\"n\">adelete</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">adelete</span><span class=\"o\">.</span><span class=\"n\">queryset_only</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_raw_delete</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">using</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Delete objects found from the given queryset in single direct SQL</span>\n<span class=\"sd\">        query. No signals are sent and there is no protection for cascades.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">clone</span><span class=\"p\">()</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"vm\">__class__</span> <span class=\"o\">=</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">DeleteQuery</span>\n        <span class=\"n\">cursor</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">execute_sql</span><span class=\"p\">(</span><span class=\"n\">CURSOR</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n            <span class=\"k\">with</span> <span class=\"n\">cursor</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"n\">cursor</span><span class=\"o\">.</span><span class=\"n\">rowcount</span>\n        <span class=\"k\">return</span> <span class=\"mi\">0</span>\n\n    <span class=\"n\">_raw_delete</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">update</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Update all elements in the current QuerySet, setting all the given</span>\n<span class=\"sd\">        fields to the appropriate values.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;update&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot update a query once a slice has been taken.&quot;</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">chain</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">UpdateQuery</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_update_values</span><span class=\"p\">(</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Inline annotations in order_by(), if possible.</span>\n        <span class=\"n\">new_order_by</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"k\">for</span> <span class=\"n\">col</span> <span class=\"ow\">in</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">:</span>\n            <span class=\"n\">alias</span> <span class=\"o\">=</span> <span class=\"n\">col</span>\n            <span class=\"n\">descending</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">alias</span><span class=\"p\">,</span> <span class=\"nb\">str</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">alias</span><span class=\"o\">.</span><span class=\"n\">startswith</span><span class=\"p\">(</span><span class=\"s2\">&quot;-&quot;</span><span class=\"p\">):</span>\n                <span class=\"n\">alias</span> <span class=\"o\">=</span> <span class=\"n\">alias</span><span class=\"o\">.</span><span class=\"n\">removeprefix</span><span class=\"p\">(</span><span class=\"s2\">&quot;-&quot;</span><span class=\"p\">)</span>\n                <span class=\"n\">descending</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"k\">if</span> <span class=\"n\">annotation</span> <span class=\"o\">:=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotations</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">alias</span><span class=\"p\">):</span>\n                <span class=\"k\">if</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">annotation</span><span class=\"p\">,</span> <span class=\"s2\">&quot;contains_aggregate&quot;</span><span class=\"p\">,</span> <span class=\"kc\">False</span><span class=\"p\">):</span>\n                    <span class=\"k\">raise</span> <span class=\"n\">exceptions</span><span class=\"o\">.</span><span class=\"n\">FieldError</span><span class=\"p\">(</span>\n                        <span class=\"sa\">f</span><span class=\"s2\">&quot;Cannot update when ordering by an aggregate: </span><span class=\"si\">{</span><span class=\"n\">annotation</span><span class=\"si\">}</span><span class=\"s2\">&quot;</span>\n                    <span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">descending</span><span class=\"p\">:</span>\n                    <span class=\"n\">annotation</span> <span class=\"o\">=</span> <span class=\"n\">annotation</span><span class=\"o\">.</span><span class=\"n\">desc</span><span class=\"p\">()</span>\n                <span class=\"n\">new_order_by</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">annotation</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">new_order_by</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">col</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">order_by</span> <span class=\"o\">=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">new_order_by</span><span class=\"p\">)</span>\n\n        <span class=\"c1\"># Clear any annotations so that they won&#39;t be present in subqueries.</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotations</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">with</span> <span class=\"n\">transaction</span><span class=\"o\">.</span><span class=\"n\">mark_for_rollback_on_error</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">):</span>\n            <span class=\"n\">rows</span> <span class=\"o\">=</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">execute_sql</span><span class=\"p\">(</span><span class=\"n\">CURSOR</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"n\">rows</span>\n\n    <span class=\"n\">update</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">aupdate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">)(</span><span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"n\">aupdate</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_update</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">values</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        A version of update() that accepts field objects instead of field names.</span>\n<span class=\"sd\">        Used primarily for model saving and not intended for use by general</span>\n<span class=\"sd\">        code (it requires too much poking around at model internals to be</span>\n<span class=\"sd\">        useful at that level).</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot update a query once a slice has been taken.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">chain</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">UpdateQuery</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_update_fields</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">)</span>\n        <span class=\"c1\"># Clear any annotations so that they won&#39;t be present in subqueries.</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotations</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">execute_sql</span><span class=\"p\">(</span><span class=\"n\">CURSOR</span><span class=\"p\">)</span>\n\n    <span class=\"n\">_update</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">_update</span><span class=\"o\">.</span><span class=\"n\">queryset_only</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">exists</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return True if the QuerySet would have any results, False otherwise.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">has_results</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"nb\">bool</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">)</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">aexists</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">)()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">contains</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return True if the QuerySet contains the provided obj,</span>\n<span class=\"sd\">        False otherwise.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;contains&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Cannot call QuerySet.contains() after .values() or .values_list().&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">concrete_model</span> <span class=\"o\">!=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">concrete_model</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"kc\">False</span>\n        <span class=\"k\">except</span> <span class=\"ne\">AttributeError</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;&#39;obj&#39; must be a model instance.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">pk</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;QuerySet.contains() cannot be used on unsaved objects.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">pk</span><span class=\"o\">=</span><span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">exists</span><span class=\"p\">()</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">acontains</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">contains</span><span class=\"p\">)(</span><span class=\"n\">obj</span><span class=\"o\">=</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_prefetch_related_objects</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># This method can only be called once the result cache has been filled.</span>\n        <span class=\"n\">prefetch_related_objects</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_done</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">explain</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"nb\">format</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">options</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Runs an EXPLAIN on the SQL query this QuerySet would perform, and</span>\n<span class=\"sd\">        returns the results.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">explain</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"nb\">format</span><span class=\"o\">=</span><span class=\"nb\">format</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">options</span><span class=\"p\">)</span>\n\n    <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">aexplain</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"p\">,</span> <span class=\"nb\">format</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">options</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">explain</span><span class=\"p\">)(</span><span class=\"nb\">format</span><span class=\"o\">=</span><span class=\"nb\">format</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">options</span><span class=\"p\">)</span>\n\n    <span class=\"c1\">##################################################</span>\n    <span class=\"c1\"># PUBLIC METHODS THAT RETURN A QUERYSET SUBCLASS #</span>\n    <span class=\"c1\">##################################################</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">raw</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">raw_query</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"p\">(),</span> <span class=\"n\">translations</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">using</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">using</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span>\n        <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"n\">RawQuerySet</span><span class=\"p\">(</span>\n            <span class=\"n\">raw_query</span><span class=\"p\">,</span>\n            <span class=\"n\">model</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span>\n            <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"n\">params</span><span class=\"p\">,</span>\n            <span class=\"n\">translations</span><span class=\"o\">=</span><span class=\"n\">translations</span><span class=\"p\">,</span>\n            <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">using</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span><span class=\"p\">[:]</span>\n        <span class=\"k\">return</span> <span class=\"n\">qs</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_values</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">expressions</span><span class=\"p\">):</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">expressions</span><span class=\"p\">:</span>\n            <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">annotate</span><span class=\"p\">(</span><span class=\"o\">**</span><span class=\"n\">expressions</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"o\">=</span> <span class=\"n\">fields</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">set_values</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">values</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">expressions</span><span class=\"p\">):</span>\n        <span class=\"n\">fields</span> <span class=\"o\">+=</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">expressions</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_values</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">expressions</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span> <span class=\"o\">=</span> <span class=\"n\">ValuesIterable</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">values_list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">flat</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">named</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">flat</span> <span class=\"ow\">and</span> <span class=\"n\">named</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;&#39;flat&#39; and &#39;named&#39; can&#39;t be used together.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">flat</span> <span class=\"ow\">and</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;&#39;flat&#39; is not valid when values_list is called with more than one &quot;</span>\n                <span class=\"s2\">&quot;field.&quot;</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"n\">field_names</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">f</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"p\">,</span> <span class=\"s2\">&quot;resolve_expression&quot;</span><span class=\"p\">)}</span>\n        <span class=\"n\">_fields</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"n\">expressions</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"n\">counter</span> <span class=\"o\">=</span> <span class=\"mi\">1</span>\n        <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"s2\">&quot;resolve_expression&quot;</span><span class=\"p\">):</span>\n                <span class=\"n\">field_id_prefix</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span>\n                    <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"s2\">&quot;default_alias&quot;</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"o\">.</span><span class=\"n\">lower</span><span class=\"p\">()</span>\n                <span class=\"p\">)</span>\n                <span class=\"k\">while</span> <span class=\"kc\">True</span><span class=\"p\">:</span>\n                    <span class=\"n\">field_id</span> <span class=\"o\">=</span> <span class=\"n\">field_id_prefix</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">counter</span><span class=\"p\">)</span>\n                    <span class=\"n\">counter</span> <span class=\"o\">+=</span> <span class=\"mi\">1</span>\n                    <span class=\"k\">if</span> <span class=\"n\">field_id</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"n\">field_names</span><span class=\"p\">:</span>\n                        <span class=\"k\">break</span>\n                <span class=\"n\">expressions</span><span class=\"p\">[</span><span class=\"n\">field_id</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">field</span>\n                <span class=\"n\">_fields</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">field_id</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">_fields</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">)</span>\n\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_values</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">_fields</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">expressions</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n            <span class=\"n\">NamedValuesListIterable</span>\n            <span class=\"k\">if</span> <span class=\"n\">named</span>\n            <span class=\"k\">else</span> <span class=\"n\">FlatValuesListIterable</span>\n            <span class=\"k\">if</span> <span class=\"n\">flat</span>\n            <span class=\"k\">else</span> <span class=\"n\">ValuesListIterable</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">dates</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field_name</span><span class=\"p\">,</span> <span class=\"n\">kind</span><span class=\"p\">,</span> <span class=\"n\">order</span><span class=\"o\">=</span><span class=\"s2\">&quot;ASC&quot;</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a list of date objects representing all available dates for</span>\n<span class=\"sd\">        the given field_name, scoped to &#39;kind&#39;.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">kind</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s2\">&quot;year&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;month&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;week&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;day&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;&#39;kind&#39; must be one of &#39;year&#39;, &#39;month&#39;, &#39;week&#39;, or &#39;day&#39;.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">order</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s2\">&quot;ASC&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;DESC&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;&#39;order&#39; must be either &#39;ASC&#39; or &#39;DESC&#39;.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">annotate</span><span class=\"p\">(</span>\n                <span class=\"n\">datefield</span><span class=\"o\">=</span><span class=\"n\">Trunc</span><span class=\"p\">(</span><span class=\"n\">field_name</span><span class=\"p\">,</span> <span class=\"n\">kind</span><span class=\"p\">,</span> <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"n\">DateField</span><span class=\"p\">()),</span>\n                <span class=\"n\">plain_field</span><span class=\"o\">=</span><span class=\"n\">F</span><span class=\"p\">(</span><span class=\"n\">field_name</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">values_list</span><span class=\"p\">(</span><span class=\"s2\">&quot;datefield&quot;</span><span class=\"p\">,</span> <span class=\"n\">flat</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">distinct</span><span class=\"p\">()</span>\n            <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">plain_field__isnull</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">((</span><span class=\"s2\">&quot;-&quot;</span> <span class=\"k\">if</span> <span class=\"n\">order</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;DESC&quot;</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;datefield&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">datetimes</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">field_name</span><span class=\"p\">,</span> <span class=\"n\">kind</span><span class=\"p\">,</span> <span class=\"n\">order</span><span class=\"o\">=</span><span class=\"s2\">&quot;ASC&quot;</span><span class=\"p\">,</span> <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a list of datetime objects representing all available</span>\n<span class=\"sd\">        datetimes for the given field_name, scoped to &#39;kind&#39;.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">kind</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s2\">&quot;year&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;month&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;week&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;day&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;hour&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;minute&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;second&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;&#39;kind&#39; must be one of &#39;year&#39;, &#39;month&#39;, &#39;week&#39;, &#39;day&#39;, &quot;</span>\n                <span class=\"s2\">&quot;&#39;hour&#39;, &#39;minute&#39;, or &#39;second&#39;.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">order</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"p\">(</span><span class=\"s2\">&quot;ASC&quot;</span><span class=\"p\">,</span> <span class=\"s2\">&quot;DESC&quot;</span><span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;&#39;order&#39; must be either &#39;ASC&#39; or &#39;DESC&#39;.&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">settings</span><span class=\"o\">.</span><span class=\"n\">USE_TZ</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">tzinfo</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">tzinfo</span> <span class=\"o\">=</span> <span class=\"n\">timezone</span><span class=\"o\">.</span><span class=\"n\">get_current_timezone</span><span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">tzinfo</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">return</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">annotate</span><span class=\"p\">(</span>\n                <span class=\"n\">datetimefield</span><span class=\"o\">=</span><span class=\"n\">Trunc</span><span class=\"p\">(</span>\n                    <span class=\"n\">field_name</span><span class=\"p\">,</span>\n                    <span class=\"n\">kind</span><span class=\"p\">,</span>\n                    <span class=\"n\">output_field</span><span class=\"o\">=</span><span class=\"n\">DateTimeField</span><span class=\"p\">(),</span>\n                    <span class=\"n\">tzinfo</span><span class=\"o\">=</span><span class=\"n\">tzinfo</span><span class=\"p\">,</span>\n                <span class=\"p\">),</span>\n                <span class=\"n\">plain_field</span><span class=\"o\">=</span><span class=\"n\">F</span><span class=\"p\">(</span><span class=\"n\">field_name</span><span class=\"p\">),</span>\n            <span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">values_list</span><span class=\"p\">(</span><span class=\"s2\">&quot;datetimefield&quot;</span><span class=\"p\">,</span> <span class=\"n\">flat</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">distinct</span><span class=\"p\">()</span>\n            <span class=\"o\">.</span><span class=\"n\">filter</span><span class=\"p\">(</span><span class=\"n\">plain_field__isnull</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n            <span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">((</span><span class=\"s2\">&quot;-&quot;</span> <span class=\"k\">if</span> <span class=\"n\">order</span> <span class=\"o\">==</span> <span class=\"s2\">&quot;DESC&quot;</span> <span class=\"k\">else</span> <span class=\"s2\">&quot;&quot;</span><span class=\"p\">)</span> <span class=\"o\">+</span> <span class=\"s2\">&quot;datetimefield&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">none</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return an empty QuerySet.&quot;&quot;&quot;</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">set_empty</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"c1\">##################################################################</span>\n    <span class=\"c1\"># PUBLIC METHODS THAT ALTER ATTRIBUTES AND RETURN A NEW QUERYSET #</span>\n    <span class=\"c1\">##################################################################</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">all</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a new QuerySet that is a copy of the current one. This allows a</span>\n<span class=\"sd\">        QuerySet to proxy for a model manager in some cases.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">filter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a new QuerySet instance with the args ANDed to the existing</span>\n<span class=\"sd\">        set.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;filter&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_filter_or_exclude</span><span class=\"p\">(</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">exclude</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a new QuerySet instance with NOT (args) ANDed to the existing</span>\n<span class=\"sd\">        set.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;exclude&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_filter_or_exclude</span><span class=\"p\">(</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_filter_or_exclude</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"n\">args</span> <span class=\"ow\">or</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot filter a query once a slice has been taken.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_defer_next_filter</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_defer_next_filter</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_deferred_filter</span> <span class=\"o\">=</span> <span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_filter_or_exclude_inplace</span><span class=\"p\">(</span><span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_filter_or_exclude_inplace</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">negate</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"n\">negate</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_query</span><span class=\"o\">.</span><span class=\"n\">add_q</span><span class=\"p\">(</span><span class=\"o\">~</span><span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">))</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_query</span><span class=\"o\">.</span><span class=\"n\">add_q</span><span class=\"p\">(</span><span class=\"n\">Q</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">))</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">complex_filter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">filter_obj</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a new QuerySet instance with filter_obj added to the filters.</span>\n\n<span class=\"sd\">        filter_obj can be a Q object or a dictionary of keyword lookup</span>\n<span class=\"sd\">        arguments.</span>\n\n<span class=\"sd\">        This exists to support framework features such as &#39;limit_choices_to&#39;,</span>\n<span class=\"sd\">        and usually it will be more natural to use other methods.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">filter_obj</span><span class=\"p\">,</span> <span class=\"n\">Q</span><span class=\"p\">):</span>\n            <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_q</span><span class=\"p\">(</span><span class=\"n\">filter_obj</span><span class=\"p\">)</span>\n            <span class=\"k\">return</span> <span class=\"n\">clone</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_filter_or_exclude</span><span class=\"p\">(</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"o\">=</span><span class=\"p\">(),</span> <span class=\"n\">kwargs</span><span class=\"o\">=</span><span class=\"n\">filter_obj</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_combinator_query</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">combinator</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">other_qs</span><span class=\"p\">,</span> <span class=\"nb\">all</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Clone the query to inherit the select list and everything</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"c1\"># Clear limits and ordering so they can be reapplied</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">clear_ordering</span><span class=\"p\">(</span><span class=\"n\">force</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">clear_limits</span><span class=\"p\">()</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combined_queries</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"p\">,)</span> <span class=\"o\">+</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span>\n            <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">query</span> <span class=\"k\">for</span> <span class=\"n\">qs</span> <span class=\"ow\">in</span> <span class=\"n\">other_qs</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combinator</span> <span class=\"o\">=</span> <span class=\"n\">combinator</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combinator_all</span> <span class=\"o\">=</span> <span class=\"nb\">all</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">union</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">other_qs</span><span class=\"p\">,</span> <span class=\"nb\">all</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"c1\"># If the query is an EmptyQuerySet, combine all nonempty querysets.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">q</span> <span class=\"k\">for</span> <span class=\"n\">q</span> <span class=\"ow\">in</span> <span class=\"n\">other_qs</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">q</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">)]</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">qs</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"bp\">self</span>\n            <span class=\"k\">if</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">qs</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n                <span class=\"k\">return</span> <span class=\"n\">qs</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n            <span class=\"k\">return</span> <span class=\"n\">qs</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">_combinator_query</span><span class=\"p\">(</span><span class=\"s2\">&quot;union&quot;</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">qs</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">:],</span> <span class=\"nb\">all</span><span class=\"o\">=</span><span class=\"nb\">all</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_combinator_query</span><span class=\"p\">(</span><span class=\"s2\">&quot;union&quot;</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">other_qs</span><span class=\"p\">,</span> <span class=\"nb\">all</span><span class=\"o\">=</span><span class=\"nb\">all</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">intersection</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">other_qs</span><span class=\"p\">):</span>\n        <span class=\"c1\"># If any query is an EmptyQuerySet, return it.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span>\n        <span class=\"k\">for</span> <span class=\"n\">other</span> <span class=\"ow\">in</span> <span class=\"n\">other_qs</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n                <span class=\"k\">return</span> <span class=\"n\">other</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_combinator_query</span><span class=\"p\">(</span><span class=\"s2\">&quot;intersection&quot;</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">other_qs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">difference</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">other_qs</span><span class=\"p\">):</span>\n        <span class=\"c1\"># If the query is an EmptyQuerySet, return it.</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_combinator_query</span><span class=\"p\">(</span><span class=\"s2\">&quot;difference&quot;</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">other_qs</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">select_for_update</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">nowait</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">skip_locked</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">of</span><span class=\"o\">=</span><span class=\"p\">(),</span> <span class=\"n\">no_key</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a new QuerySet instance that will select objects with a</span>\n<span class=\"sd\">        FOR UPDATE lock.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"n\">nowait</span> <span class=\"ow\">and</span> <span class=\"n\">skip_locked</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;The nowait option cannot be used with skip_locked.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_for_update</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_for_update_nowait</span> <span class=\"o\">=</span> <span class=\"n\">nowait</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_for_update_skip_locked</span> <span class=\"o\">=</span> <span class=\"n\">skip_locked</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_for_update_of</span> <span class=\"o\">=</span> <span class=\"n\">of</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_for_no_key_update</span> <span class=\"o\">=</span> <span class=\"n\">no_key</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">select_related</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a new QuerySet instance that will select related objects.</span>\n\n<span class=\"sd\">        If fields are specified, they must be ForeignKey fields and only those</span>\n<span class=\"sd\">        related objects are included in the selection.</span>\n\n<span class=\"sd\">        If select_related(None) is called, clear the list.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;select_related&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Cannot call select_related() after .values() or .values_list()&quot;</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">fields</span> <span class=\"o\">==</span> <span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,):</span>\n            <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_related</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"k\">elif</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_select_related</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">select_related</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">prefetch_related</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">lookups</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a new QuerySet instance that will prefetch the specified</span>\n<span class=\"sd\">        Many-To-One and Many-To-Many related objects when the QuerySet is</span>\n<span class=\"sd\">        evaluated.</span>\n\n<span class=\"sd\">        When prefetch_related() is called more than once, append to the list of</span>\n<span class=\"sd\">        prefetch lookups. If prefetch_related(None) is called, clear the list.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;prefetch_related&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">lookups</span> <span class=\"o\">==</span> <span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,):</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">for</span> <span class=\"n\">lookup</span> <span class=\"ow\">in</span> <span class=\"n\">lookups</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">lookup</span><span class=\"p\">,</span> <span class=\"n\">Prefetch</span><span class=\"p\">):</span>\n                    <span class=\"n\">lookup</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span>\n                <span class=\"n\">lookup</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"n\">LOOKUP_SEP</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n                <span class=\"k\">if</span> <span class=\"n\">lookup</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">_filtered_relations</span><span class=\"p\">:</span>\n                    <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;prefetch_related() is not supported with FilteredRelation.&quot;</span>\n                    <span class=\"p\">)</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">+</span> <span class=\"n\">lookups</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">annotate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a query set in which the returned objects have been annotated</span>\n<span class=\"sd\">        with extra data or aggregations.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;annotate&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_annotate</span><span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">,</span> <span class=\"n\">select</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">alias</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a query set with added aliases for extra data or aggregations.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;alias&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_annotate</span><span class=\"p\">(</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">,</span> <span class=\"n\">select</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_annotate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"n\">kwargs</span><span class=\"p\">,</span> <span class=\"n\">select</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_validate_values_are_expressions</span><span class=\"p\">(</span>\n            <span class=\"n\">args</span> <span class=\"o\">+</span> <span class=\"nb\">tuple</span><span class=\"p\">(</span><span class=\"n\">kwargs</span><span class=\"o\">.</span><span class=\"n\">values</span><span class=\"p\">()),</span> <span class=\"n\">method_name</span><span class=\"o\">=</span><span class=\"s2\">&quot;annotate&quot;</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">annotations</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">for</span> <span class=\"n\">arg</span> <span class=\"ow\">in</span> <span class=\"n\">args</span><span class=\"p\">:</span>\n            <span class=\"c1\"># The default_alias property may raise a TypeError.</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"n\">arg</span><span class=\"o\">.</span><span class=\"n\">default_alias</span> <span class=\"ow\">in</span> <span class=\"n\">kwargs</span><span class=\"p\">:</span>\n                    <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                        <span class=\"s2\">&quot;The named annotation &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; conflicts with the &quot;</span>\n                        <span class=\"s2\">&quot;default name for another annotation.&quot;</span> <span class=\"o\">%</span> <span class=\"n\">arg</span><span class=\"o\">.</span><span class=\"n\">default_alias</span>\n                    <span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"ne\">TypeError</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Complex annotations require an alias&quot;</span><span class=\"p\">)</span>\n            <span class=\"n\">annotations</span><span class=\"p\">[</span><span class=\"n\">arg</span><span class=\"o\">.</span><span class=\"n\">default_alias</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">arg</span>\n        <span class=\"n\">annotations</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">names</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span>\n        <span class=\"k\">if</span> <span class=\"n\">names</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">names</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span>\n                <span class=\"n\">chain</span><span class=\"o\">.</span><span class=\"n\">from_iterable</span><span class=\"p\">(</span>\n                    <span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">)</span>\n                    <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"s2\">&quot;attname&quot;</span><span class=\"p\">)</span>\n                    <span class=\"k\">else</span> <span class=\"p\">(</span><span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"p\">,)</span>\n                    <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_fields</span><span class=\"p\">()</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"k\">for</span> <span class=\"n\">alias</span><span class=\"p\">,</span> <span class=\"n\">annotation</span> <span class=\"ow\">in</span> <span class=\"n\">annotations</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"n\">names</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;The annotation &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; conflicts with a field on &quot;</span>\n                    <span class=\"s2\">&quot;the model.&quot;</span> <span class=\"o\">%</span> <span class=\"n\">alias</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">annotation</span><span class=\"p\">,</span> <span class=\"n\">FilteredRelation</span><span class=\"p\">):</span>\n                <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_filtered_relation</span><span class=\"p\">(</span><span class=\"n\">annotation</span><span class=\"p\">,</span> <span class=\"n\">alias</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_annotation</span><span class=\"p\">(</span>\n                    <span class=\"n\">annotation</span><span class=\"p\">,</span>\n                    <span class=\"n\">alias</span><span class=\"p\">,</span>\n                    <span class=\"n\">select</span><span class=\"o\">=</span><span class=\"n\">select</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">alias</span><span class=\"p\">,</span> <span class=\"n\">annotation</span> <span class=\"ow\">in</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotations</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"k\">if</span> <span class=\"n\">alias</span> <span class=\"ow\">in</span> <span class=\"n\">annotations</span> <span class=\"ow\">and</span> <span class=\"n\">annotation</span><span class=\"o\">.</span><span class=\"n\">contains_aggregate</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                    <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">group_by</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">set_group_by</span><span class=\"p\">()</span>\n                <span class=\"k\">break</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">order_by</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">field_names</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return a new QuerySet instance with the ordering changed.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot reorder a query once a slice has been taken.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">clear_ordering</span><span class=\"p\">(</span><span class=\"n\">force</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">clear_default</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_ordering</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">field_names</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">distinct</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">field_names</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a new QuerySet instance that will select only distinct results.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;distinct&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Cannot create distinct fields once a slice has been taken.&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_distinct_fields</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">field_names</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">extra</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">select</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">where</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">tables</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">order_by</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">select_params</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Add extra SQL fragments to the query.&quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;extra&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot change a query once a slice has been taken.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_extra</span><span class=\"p\">(</span><span class=\"n\">select</span><span class=\"p\">,</span> <span class=\"n\">select_params</span><span class=\"p\">,</span> <span class=\"n\">where</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"p\">,</span> <span class=\"n\">tables</span><span class=\"p\">,</span> <span class=\"n\">order_by</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">reverse</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Reverse the ordering of the QuerySet.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_sliced</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot reverse a query once a slice has been taken.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">standard_ordering</span> <span class=\"o\">=</span> <span class=\"ow\">not</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">standard_ordering</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">defer</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Defer the loading of data for certain fields until they are accessed.</span>\n<span class=\"sd\">        Add the set of deferred fields to any existing set of deferred fields.</span>\n<span class=\"sd\">        The only exception to this is if None is passed in as the only</span>\n<span class=\"sd\">        parameter, in which case removal all deferrals.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;defer&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot call defer() after .values() or .values_list()&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">fields</span> <span class=\"o\">==</span> <span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,):</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">clear_deferred_loading</span><span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_deferred_loading</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">only</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">fields</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Essentially, the opposite of defer(). Only the fields passed into this</span>\n<span class=\"sd\">        method and that are not already specified as deferred are loaded</span>\n<span class=\"sd\">        immediately when the queryset is evaluated.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"s2\">&quot;only&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot call only() after .values() or .values_list()&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">fields</span> <span class=\"o\">==</span> <span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,):</span>\n            <span class=\"c1\"># Can only pass None to defer(), not only(), as the rest option.</span>\n            <span class=\"c1\"># That won&#39;t stop people trying to do this, so let&#39;s be explicit.</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot pass None as an argument to only().&quot;</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"n\">field</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"n\">LOOKUP_SEP</span><span class=\"p\">,</span> <span class=\"mi\">1</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n            <span class=\"k\">if</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">_filtered_relations</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"s2\">&quot;only() is not supported with FilteredRelation.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">add_immediate_loading</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">using</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">alias</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Select which database this QuerySet should execute against.&quot;&quot;&quot;</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n        <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_db</span> <span class=\"o\">=</span> <span class=\"n\">alias</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"c1\">###################################</span>\n    <span class=\"c1\"># PUBLIC INTROSPECTION ATTRIBUTES #</span>\n    <span class=\"c1\">###################################</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">ordered</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return True if the QuerySet is ordered -- i.e. has an order_by()</span>\n<span class=\"sd\">        clause or a default ordering on the model (or is empty).</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">EmptyQuerySet</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">True</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">extra_order_by</span> <span class=\"ow\">or</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">order_by</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">True</span>\n        <span class=\"k\">elif</span> <span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">default_ordering</span>\n            <span class=\"ow\">and</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_meta</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">ordering</span>\n            <span class=\"ow\">and</span>\n            <span class=\"c1\"># A default ordering doesn&#39;t affect GROUP BY queries.</span>\n            <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">group_by</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"kc\">True</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"kc\">False</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">db</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return the database used if this query is executed now.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db</span> <span class=\"ow\">or</span> <span class=\"n\">router</span><span class=\"o\">.</span><span class=\"n\">db_for_write</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_hints</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db</span> <span class=\"ow\">or</span> <span class=\"n\">router</span><span class=\"o\">.</span><span class=\"n\">db_for_read</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_hints</span><span class=\"p\">)</span>\n\n    <span class=\"c1\">###################</span>\n    <span class=\"c1\"># PRIVATE METHODS #</span>\n    <span class=\"c1\">###################</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_insert</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">objs</span><span class=\"p\">,</span>\n        <span class=\"n\">fields</span><span class=\"p\">,</span>\n        <span class=\"n\">returning_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">raw</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span>\n        <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">on_conflict</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">unique_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Insert a new record for the given model. This provides an interface to</span>\n<span class=\"sd\">        the InsertQuery class and is how Model.save() is implemented.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">if</span> <span class=\"n\">using</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">using</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">InsertQuery</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span>\n            <span class=\"n\">on_conflict</span><span class=\"o\">=</span><span class=\"n\">on_conflict</span><span class=\"p\">,</span>\n            <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"n\">update_fields</span><span class=\"p\">,</span>\n            <span class=\"n\">unique_fields</span><span class=\"o\">=</span><span class=\"n\">unique_fields</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">insert_values</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">objs</span><span class=\"p\">,</span> <span class=\"n\">raw</span><span class=\"o\">=</span><span class=\"n\">raw</span><span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_compiler</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">using</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">execute_sql</span><span class=\"p\">(</span><span class=\"n\">returning_fields</span><span class=\"p\">)</span>\n\n    <span class=\"n\">_insert</span><span class=\"o\">.</span><span class=\"n\">alters_data</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n    <span class=\"n\">_insert</span><span class=\"o\">.</span><span class=\"n\">queryset_only</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_batched_insert</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">objs</span><span class=\"p\">,</span>\n        <span class=\"n\">fields</span><span class=\"p\">,</span>\n        <span class=\"n\">batch_size</span><span class=\"p\">,</span>\n        <span class=\"n\">on_conflict</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">unique_fields</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Helper method for bulk_create() to insert objs one batch at a time.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">connection</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span>\n        <span class=\"n\">ops</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">ops</span>\n        <span class=\"n\">max_batch_size</span> <span class=\"o\">=</span> <span class=\"nb\">max</span><span class=\"p\">(</span><span class=\"n\">ops</span><span class=\"o\">.</span><span class=\"n\">bulk_batch_size</span><span class=\"p\">(</span><span class=\"n\">fields</span><span class=\"p\">,</span> <span class=\"n\">objs</span><span class=\"p\">),</span> <span class=\"mi\">1</span><span class=\"p\">)</span>\n        <span class=\"n\">batch_size</span> <span class=\"o\">=</span> <span class=\"nb\">min</span><span class=\"p\">(</span><span class=\"n\">batch_size</span><span class=\"p\">,</span> <span class=\"n\">max_batch_size</span><span class=\"p\">)</span> <span class=\"k\">if</span> <span class=\"n\">batch_size</span> <span class=\"k\">else</span> <span class=\"n\">max_batch_size</span>\n        <span class=\"n\">inserted_rows</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n        <span class=\"n\">bulk_return</span> <span class=\"o\">=</span> <span class=\"n\">connection</span><span class=\"o\">.</span><span class=\"n\">features</span><span class=\"o\">.</span><span class=\"n\">can_return_rows_from_bulk_insert</span>\n        <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"p\">[</span><span class=\"n\">objs</span><span class=\"p\">[</span><span class=\"n\">i</span> <span class=\"p\">:</span> <span class=\"n\">i</span> <span class=\"o\">+</span> <span class=\"n\">batch_size</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">i</span> <span class=\"ow\">in</span> <span class=\"nb\">range</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">objs</span><span class=\"p\">),</span> <span class=\"n\">batch_size</span><span class=\"p\">)]:</span>\n            <span class=\"k\">if</span> <span class=\"n\">bulk_return</span> <span class=\"ow\">and</span> <span class=\"n\">on_conflict</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">inserted_rows</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span>\n                    <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_insert</span><span class=\"p\">(</span>\n                        <span class=\"n\">item</span><span class=\"p\">,</span>\n                        <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"n\">fields</span><span class=\"p\">,</span>\n                        <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span>\n                        <span class=\"n\">returning_fields</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">db_returning_fields</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_insert</span><span class=\"p\">(</span>\n                    <span class=\"n\">item</span><span class=\"p\">,</span>\n                    <span class=\"n\">fields</span><span class=\"o\">=</span><span class=\"n\">fields</span><span class=\"p\">,</span>\n                    <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span>\n                    <span class=\"n\">on_conflict</span><span class=\"o\">=</span><span class=\"n\">on_conflict</span><span class=\"p\">,</span>\n                    <span class=\"n\">update_fields</span><span class=\"o\">=</span><span class=\"n\">update_fields</span><span class=\"p\">,</span>\n                    <span class=\"n\">unique_fields</span><span class=\"o\">=</span><span class=\"n\">unique_fields</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n        <span class=\"k\">return</span> <span class=\"n\">inserted_rows</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_chain</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a copy of the current QuerySet that&#39;s ready for another</span>\n<span class=\"sd\">        operation.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_clone</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_sticky_filter</span><span class=\"p\">:</span>\n            <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">filter_is_sticky</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_sticky_filter</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_clone</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Return a copy of the current QuerySet. A lightweight alternative</span>\n<span class=\"sd\">        to deepcopy().</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">c</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">(</span>\n            <span class=\"n\">model</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span>\n            <span class=\"n\">query</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">chain</span><span class=\"p\">(),</span>\n            <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db</span><span class=\"p\">,</span>\n            <span class=\"n\">hints</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_hints</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">_sticky_filter</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_sticky_filter</span>\n        <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">_for_write</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_for_write</span>\n        <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span><span class=\"p\">[:]</span>\n        <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">_known_related_objects</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_known_related_objects</span>\n        <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span>\n        <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span>\n        <span class=\"k\">return</span> <span class=\"n\">c</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_fetch_all</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">))</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_done</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_objects</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_next_is_sticky</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Indicate that the next filter call and the one following that should</span>\n<span class=\"sd\">        be treated as a single filter. This is only important when it comes to</span>\n<span class=\"sd\">        determining when to reuse tables for many-to-many filters. Required so</span>\n<span class=\"sd\">        that we can filter naturally on the results of related managers.</span>\n\n<span class=\"sd\">        This doesn&#39;t return a clone of the current QuerySet (it returns</span>\n<span class=\"sd\">        &quot;self&quot;). The method is only used internally and should be immediately</span>\n<span class=\"sd\">        followed by a filter() that does create a clone.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_sticky_filter</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_merge_sanity_check</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Check that two QuerySet classes may be merged.&quot;&quot;&quot;</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"p\">(</span>\n            <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">values_select</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">values_select</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">extra_select</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">extra_select</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotation_select</span><span class=\"p\">)</span> <span class=\"o\">!=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">annotation_select</span><span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Merging &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; classes must involve the same values in each case.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_merge_known_related_objects</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Keep track of all known related objects from either QuerySet instance.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">for</span> <span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"n\">objects</span> <span class=\"ow\">in</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">_known_related_objects</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_known_related_objects</span><span class=\"o\">.</span><span class=\"n\">setdefault</span><span class=\"p\">(</span><span class=\"n\">field</span><span class=\"p\">,</span> <span class=\"p\">{})</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">objects</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">resolve_expression</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span> <span class=\"ow\">and</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fields</span><span class=\"p\">)</span> <span class=\"o\">&gt;</span> <span class=\"mi\">1</span><span class=\"p\">:</span>\n            <span class=\"c1\"># values() queryset can only be used as nested queries</span>\n            <span class=\"c1\"># if they are set up to select only a single field.</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;Cannot use multi-field values as a filter value.&quot;</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">resolve_expression</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">)</span>\n        <span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">_db</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db</span>\n        <span class=\"k\">return</span> <span class=\"n\">query</span>\n\n    <span class=\"n\">resolve_expression</span><span class=\"o\">.</span><span class=\"n\">queryset_only</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_add_hints</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">hints</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Update hinting information for use by routers. Add new key/values or</span>\n<span class=\"sd\">        overwrite existing key/values.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_hints</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">hints</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_has_filters</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        Check if this QuerySet has any filtering going on. This isn&#39;t</span>\n<span class=\"sd\">        equivalent with checking if all objects are present in results, for</span>\n<span class=\"sd\">        example, qs[1:]._has_filters() -&gt; False.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">has_filters</span><span class=\"p\">()</span>\n\n    <span class=\"nd\">@staticmethod</span>\n    <span class=\"k\">def</span> <span class=\"nf\">_validate_values_are_expressions</span><span class=\"p\">(</span><span class=\"n\">values</span><span class=\"p\">,</span> <span class=\"n\">method_name</span><span class=\"p\">):</span>\n        <span class=\"n\">invalid_args</span> <span class=\"o\">=</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span>\n            <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">arg</span><span class=\"p\">)</span> <span class=\"k\">for</span> <span class=\"n\">arg</span> <span class=\"ow\">in</span> <span class=\"n\">values</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">arg</span><span class=\"p\">,</span> <span class=\"s2\">&quot;resolve_expression&quot;</span><span class=\"p\">)</span>\n        <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">invalid_args</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;QuerySet.</span><span class=\"si\">%s</span><span class=\"s2\">() received non-expression(s): </span><span class=\"si\">%s</span><span class=\"s2\">.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span>\n                    <span class=\"n\">method_name</span><span class=\"p\">,</span>\n                    <span class=\"s2\">&quot;, &quot;</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"n\">invalid_args</span><span class=\"p\">),</span>\n                <span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_not_support_combined_queries</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">operation_name</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combinator</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"n\">NotSupportedError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Calling QuerySet.</span><span class=\"si\">%s</span><span class=\"s2\">() after </span><span class=\"si\">%s</span><span class=\"s2\">() is not supported.&quot;</span>\n                <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"n\">operation_name</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combinator</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_check_operator_queryset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">operator_</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combinator</span> <span class=\"ow\">or</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">combinator</span><span class=\"p\">:</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">&quot;Cannot use </span><span class=\"si\">{</span><span class=\"n\">operator_</span><span class=\"si\">}</span><span class=\"s2\"> operator with combined queryset.&quot;</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_check_ordering_first_last_queryset_aggregation</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">method</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">group_by</span><span class=\"p\">,</span> <span class=\"nb\">tuple</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">any</span><span class=\"p\">(</span>\n            <span class=\"n\">col</span><span class=\"o\">.</span><span class=\"n\">output_field</span> <span class=\"ow\">is</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span> <span class=\"k\">for</span> <span class=\"n\">col</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">group_by</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;Cannot use QuerySet.</span><span class=\"si\">{</span><span class=\"n\">method</span><span class=\"si\">}</span><span class=\"s2\">() on an unordered queryset performing &quot;</span>\n                <span class=\"sa\">f</span><span class=\"s2\">&quot;aggregation. Add an ordering with order_by().&quot;</span>\n            <span class=\"p\">)</span></div>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">InstanceCheckMeta</span><span class=\"p\">(</span><span class=\"nb\">type</span><span class=\"p\">):</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__instancecheck__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">instance</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">QuerySet</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">is_empty</span><span class=\"p\">()</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">EmptyQuerySet</span><span class=\"p\">(</span><span class=\"n\">metaclass</span><span class=\"o\">=</span><span class=\"n\">InstanceCheckMeta</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Marker class to checking if a queryset is empty by .none():</span>\n<span class=\"sd\">        isinstance(qs.none(), EmptyQuerySet) -&gt; True</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">args</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"n\">kwargs</span><span class=\"p\">):</span>\n        <span class=\"k\">raise</span> <span class=\"ne\">TypeError</span><span class=\"p\">(</span><span class=\"s2\">&quot;EmptyQuerySet can&#39;t be instantiated&quot;</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">RawQuerySet</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Provide an iterator which converts the results of raw SQL queries into</span>\n<span class=\"sd\">    annotated model instances.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span>\n        <span class=\"bp\">self</span><span class=\"p\">,</span>\n        <span class=\"n\">raw_query</span><span class=\"p\">,</span>\n        <span class=\"n\">model</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">query</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"p\">(),</span>\n        <span class=\"n\">translations</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n        <span class=\"n\">hints</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span>\n    <span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">raw_query</span> <span class=\"o\">=</span> <span class=\"n\">raw_query</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span> <span class=\"o\">=</span> <span class=\"n\">model</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db</span> <span class=\"o\">=</span> <span class=\"n\">using</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_hints</span> <span class=\"o\">=</span> <span class=\"n\">hints</span> <span class=\"ow\">or</span> <span class=\"p\">{}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span> <span class=\"o\">=</span> <span class=\"n\">query</span> <span class=\"ow\">or</span> <span class=\"n\">sql</span><span class=\"o\">.</span><span class=\"n\">RawQuery</span><span class=\"p\">(</span><span class=\"n\">sql</span><span class=\"o\">=</span><span class=\"n\">raw_query</span><span class=\"p\">,</span> <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"n\">params</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">params</span> <span class=\"o\">=</span> <span class=\"n\">params</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">translations</span> <span class=\"o\">=</span> <span class=\"n\">translations</span> <span class=\"ow\">or</span> <span class=\"p\">{}</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"p\">()</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_done</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">resolve_model_init_order</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Resolve the init field names and value positions.&quot;&quot;&quot;</span>\n        <span class=\"n\">converter</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">introspection</span><span class=\"o\">.</span><span class=\"n\">identifier_converter</span>\n        <span class=\"n\">model_init_fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"n\">f</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span> <span class=\"k\">if</span> <span class=\"n\">converter</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">)</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">columns</span>\n        <span class=\"p\">]</span>\n        <span class=\"n\">annotation_fields</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"p\">(</span><span class=\"n\">column</span><span class=\"p\">,</span> <span class=\"n\">pos</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">pos</span><span class=\"p\">,</span> <span class=\"n\">column</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">columns</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">column</span> <span class=\"ow\">not</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model_fields</span>\n        <span class=\"p\">]</span>\n        <span class=\"n\">model_init_order</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">columns</span><span class=\"o\">.</span><span class=\"n\">index</span><span class=\"p\">(</span><span class=\"n\">converter</span><span class=\"p\">(</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">column</span><span class=\"p\">))</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">model_init_fields</span>\n        <span class=\"p\">]</span>\n        <span class=\"n\">model_init_names</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">attname</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">model_init_fields</span><span class=\"p\">]</span>\n        <span class=\"k\">return</span> <span class=\"n\">model_init_names</span><span class=\"p\">,</span> <span class=\"n\">model_init_order</span><span class=\"p\">,</span> <span class=\"n\">annotation_fields</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">prefetch_related</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">lookups</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Same as QuerySet.prefetch_related()&quot;&quot;&quot;</span>\n        <span class=\"n\">clone</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_clone</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">lookups</span> <span class=\"o\">==</span> <span class=\"p\">(</span><span class=\"kc\">None</span><span class=\"p\">,):</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"p\">()</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"n\">clone</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">+</span> <span class=\"n\">lookups</span>\n        <span class=\"k\">return</span> <span class=\"n\">clone</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_prefetch_related_objects</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">prefetch_related_objects</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_done</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_clone</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Same as QuerySet._clone()&quot;&quot;&quot;</span>\n        <span class=\"n\">c</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">raw_query</span><span class=\"p\">,</span>\n            <span class=\"n\">model</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span>\n            <span class=\"n\">query</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"p\">,</span>\n            <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">params</span><span class=\"p\">,</span>\n            <span class=\"n\">translations</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">translations</span><span class=\"p\">,</span>\n            <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db</span><span class=\"p\">,</span>\n            <span class=\"n\">hints</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_hints</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n        <span class=\"n\">c</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span><span class=\"p\">[:]</span>\n        <span class=\"k\">return</span> <span class=\"n\">c</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">_fetch_all</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">iterator</span><span class=\"p\">())</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_done</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_objects</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__len__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__bool__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"nb\">bool</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__iter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">()</span>\n        <span class=\"k\">return</span> <span class=\"nb\">iter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__aiter__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"c1\"># Remember, __aiter__ itself is synchronous, it&#39;s the thing it returns</span>\n        <span class=\"c1\"># that is async!</span>\n        <span class=\"k\">async</span> <span class=\"k\">def</span> <span class=\"nf\">generator</span><span class=\"p\">():</span>\n            <span class=\"k\">await</span> <span class=\"n\">sync_to_async</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_fetch_all</span><span class=\"p\">)()</span>\n            <span class=\"k\">for</span> <span class=\"n\">item</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span><span class=\"p\">:</span>\n                <span class=\"k\">yield</span> <span class=\"n\">item</span>\n\n        <span class=\"k\">return</span> <span class=\"n\">generator</span><span class=\"p\">()</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">iterator</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">yield from</span> <span class=\"n\">RawModelIterable</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__repr__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"s2\">&quot;&lt;</span><span class=\"si\">%s</span><span class=\"s2\">: </span><span class=\"si\">%s</span><span class=\"s2\">&gt;&quot;</span> <span class=\"o\">%</span> <span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__getitem__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">k</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)[</span><span class=\"n\">k</span><span class=\"p\">]</span>\n\n    <span class=\"nd\">@property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">db</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Return the database used if this query is executed now.&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_db</span> <span class=\"ow\">or</span> <span class=\"n\">router</span><span class=\"o\">.</span><span class=\"n\">db_for_read</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span> <span class=\"o\">**</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_hints</span><span class=\"p\">)</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">using</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">alias</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;Select the database this RawQuerySet should execute against.&quot;&quot;&quot;</span>\n        <span class=\"k\">return</span> <span class=\"n\">RawQuerySet</span><span class=\"p\">(</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">raw_query</span><span class=\"p\">,</span>\n            <span class=\"n\">model</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"p\">,</span>\n            <span class=\"n\">query</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">chain</span><span class=\"p\">(</span><span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">alias</span><span class=\"p\">),</span>\n            <span class=\"n\">params</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">params</span><span class=\"p\">,</span>\n            <span class=\"n\">translations</span><span class=\"o\">=</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">translations</span><span class=\"p\">,</span>\n            <span class=\"n\">using</span><span class=\"o\">=</span><span class=\"n\">alias</span><span class=\"p\">,</span>\n        <span class=\"p\">)</span>\n\n    <span class=\"nd\">@cached_property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">columns</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">        A list of model field names in the order they&#39;ll appear in the</span>\n<span class=\"sd\">        query results.</span>\n<span class=\"sd\">        &quot;&quot;&quot;</span>\n        <span class=\"n\">columns</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">query</span><span class=\"o\">.</span><span class=\"n\">get_columns</span><span class=\"p\">()</span>\n        <span class=\"c1\"># Adjust any column names which don&#39;t match field names</span>\n        <span class=\"k\">for</span> <span class=\"n\">query_name</span><span class=\"p\">,</span> <span class=\"n\">model_name</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">translations</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n            <span class=\"c1\"># Ignore translations for nonexistent column names</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">index</span> <span class=\"o\">=</span> <span class=\"n\">columns</span><span class=\"o\">.</span><span class=\"n\">index</span><span class=\"p\">(</span><span class=\"n\">query_name</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"ne\">ValueError</span><span class=\"p\">:</span>\n                <span class=\"k\">pass</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">columns</span><span class=\"p\">[</span><span class=\"n\">index</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">model_name</span>\n        <span class=\"k\">return</span> <span class=\"n\">columns</span>\n\n    <span class=\"nd\">@cached_property</span>\n    <span class=\"k\">def</span> <span class=\"nf\">model_fields</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"sd\">&quot;&quot;&quot;A dict mapping column names to model field names.&quot;&quot;&quot;</span>\n        <span class=\"n\">converter</span> <span class=\"o\">=</span> <span class=\"n\">connections</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">introspection</span><span class=\"o\">.</span><span class=\"n\">identifier_converter</span>\n        <span class=\"n\">model_fields</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n        <span class=\"k\">for</span> <span class=\"n\">field</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">fields</span><span class=\"p\">:</span>\n            <span class=\"n\">name</span><span class=\"p\">,</span> <span class=\"n\">column</span> <span class=\"o\">=</span> <span class=\"n\">field</span><span class=\"o\">.</span><span class=\"n\">get_attname_column</span><span class=\"p\">()</span>\n            <span class=\"n\">model_fields</span><span class=\"p\">[</span><span class=\"n\">converter</span><span class=\"p\">(</span><span class=\"n\">column</span><span class=\"p\">)]</span> <span class=\"o\">=</span> <span class=\"n\">field</span>\n        <span class=\"k\">return</span> <span class=\"n\">model_fields</span>\n\n\n<div class=\"viewcode-block\" id=\"Prefetch\"><a class=\"viewcode-back\" href=\"../../../../../ref/models/querysets/#django.db.models.query.Prefetch\">[docs]</a><span class=\"k\">class</span> <span class=\"nc\">Prefetch</span><span class=\"p\">:</span>\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">lookup</span><span class=\"p\">,</span> <span class=\"n\">queryset</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">,</span> <span class=\"n\">to_attr</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n        <span class=\"c1\"># `prefetch_through` is the path we traverse to perform the prefetch.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_through</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span>\n        <span class=\"c1\"># `prefetch_to` is the path to the attribute that stores the result.</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span>\n        <span class=\"k\">if</span> <span class=\"n\">queryset</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span> <span class=\"ow\">and</span> <span class=\"p\">(</span>\n            <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">queryset</span><span class=\"p\">,</span> <span class=\"n\">RawQuerySet</span><span class=\"p\">)</span>\n            <span class=\"ow\">or</span> <span class=\"p\">(</span>\n                <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">queryset</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_iterable_class&quot;</span><span class=\"p\">)</span>\n                <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"nb\">issubclass</span><span class=\"p\">(</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_iterable_class</span><span class=\"p\">,</span> <span class=\"n\">ModelIterable</span><span class=\"p\">)</span>\n            <span class=\"p\">)</span>\n        <span class=\"p\">):</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                <span class=\"s2\">&quot;Prefetch querysets cannot use raw(), values(), and values_list().&quot;</span>\n            <span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">to_attr</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span> <span class=\"o\">=</span> <span class=\"n\">LOOKUP_SEP</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span>\n                <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"n\">LOOKUP_SEP</span><span class=\"p\">)[:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"p\">[</span><span class=\"n\">to_attr</span><span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_attr</span> <span class=\"o\">=</span> <span class=\"n\">to_attr</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">__getstate__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"n\">obj_dict</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span><span class=\"o\">.</span><span class=\"n\">copy</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">queryset</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_chain</span><span class=\"p\">()</span>\n            <span class=\"c1\"># Prevent the QuerySet from being evaluated</span>\n            <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n            <span class=\"n\">queryset</span><span class=\"o\">.</span><span class=\"n\">_prefetch_done</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"n\">obj_dict</span><span class=\"p\">[</span><span class=\"s2\">&quot;queryset&quot;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">queryset</span>\n        <span class=\"k\">return</span> <span class=\"n\">obj_dict</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">add_prefix</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_through</span> <span class=\"o\">=</span> <span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"n\">LOOKUP_SEP</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_through</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span> <span class=\"o\">=</span> <span class=\"n\">prefix</span> <span class=\"o\">+</span> <span class=\"n\">LOOKUP_SEP</span> <span class=\"o\">+</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_current_prefetch_to</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">level</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">LOOKUP_SEP</span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"n\">LOOKUP_SEP</span><span class=\"p\">)[:</span> <span class=\"n\">level</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">])</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_current_to_attr</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">level</span><span class=\"p\">):</span>\n        <span class=\"n\">parts</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"n\">LOOKUP_SEP</span><span class=\"p\">)</span>\n        <span class=\"n\">to_attr</span> <span class=\"o\">=</span> <span class=\"n\">parts</span><span class=\"p\">[</span><span class=\"n\">level</span><span class=\"p\">]</span>\n        <span class=\"n\">as_attr</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">to_attr</span> <span class=\"ow\">and</span> <span class=\"n\">level</span> <span class=\"o\">==</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">parts</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"mi\">1</span>\n        <span class=\"k\">return</span> <span class=\"n\">to_attr</span><span class=\"p\">,</span> <span class=\"n\">as_attr</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">get_current_queryset</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">level</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_current_prefetch_to</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span><span class=\"p\">:</span>\n            <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">queryset</span>\n        <span class=\"k\">return</span> <span class=\"kc\">None</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__eq__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">other</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">other</span><span class=\"p\">,</span> <span class=\"n\">Prefetch</span><span class=\"p\">):</span>\n            <span class=\"k\">return</span> <span class=\"bp\">NotImplemented</span>\n        <span class=\"k\">return</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span> <span class=\"o\">==</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__hash__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">hash</span><span class=\"p\">((</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span><span class=\"p\">))</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">normalize_prefetch_lookups</span><span class=\"p\">(</span><span class=\"n\">lookups</span><span class=\"p\">,</span> <span class=\"n\">prefix</span><span class=\"o\">=</span><span class=\"kc\">None</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;Normalize lookups into Prefetch objects.&quot;&quot;&quot;</span>\n    <span class=\"n\">ret</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"k\">for</span> <span class=\"n\">lookup</span> <span class=\"ow\">in</span> <span class=\"n\">lookups</span><span class=\"p\">:</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">lookup</span><span class=\"p\">,</span> <span class=\"n\">Prefetch</span><span class=\"p\">):</span>\n            <span class=\"n\">lookup</span> <span class=\"o\">=</span> <span class=\"n\">Prefetch</span><span class=\"p\">(</span><span class=\"n\">lookup</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">prefix</span><span class=\"p\">:</span>\n            <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">add_prefix</span><span class=\"p\">(</span><span class=\"n\">prefix</span><span class=\"p\">)</span>\n        <span class=\"n\">ret</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">lookup</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">ret</span>\n\n\n<div class=\"viewcode-block\" id=\"prefetch_related_objects\"><a class=\"viewcode-back\" href=\"../../../../../ref/models/querysets/#django.db.models.query.prefetch_related_objects\">[docs]</a><span class=\"k\">def</span> <span class=\"nf\">prefetch_related_objects</span><span class=\"p\">(</span><span class=\"n\">model_instances</span><span class=\"p\">,</span> <span class=\"o\">*</span><span class=\"n\">related_lookups</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Populate prefetched object caches for a list of model instances based on</span>\n<span class=\"sd\">    the lookups/Prefetch instances given.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">model_instances</span><span class=\"p\">:</span>\n        <span class=\"k\">return</span>  <span class=\"c1\"># nothing to do</span>\n\n    <span class=\"c1\"># We need to be able to dynamically add to the list of prefetch_related</span>\n    <span class=\"c1\"># lookups that we look up (see below).  So we need some book keeping to</span>\n    <span class=\"c1\"># ensure we don&#39;t do duplicate work.</span>\n    <span class=\"n\">done_queries</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>  <span class=\"c1\"># dictionary of things like &#39;foo__bar&#39;: [results]</span>\n\n    <span class=\"n\">auto_lookups</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>  <span class=\"c1\"># we add to this as we go through.</span>\n    <span class=\"n\">followed_descriptors</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">()</span>  <span class=\"c1\"># recursion protection</span>\n\n    <span class=\"n\">all_lookups</span> <span class=\"o\">=</span> <span class=\"n\">normalize_prefetch_lookups</span><span class=\"p\">(</span><span class=\"nb\">reversed</span><span class=\"p\">(</span><span class=\"n\">related_lookups</span><span class=\"p\">))</span>\n    <span class=\"k\">while</span> <span class=\"n\">all_lookups</span><span class=\"p\">:</span>\n        <span class=\"n\">lookup</span> <span class=\"o\">=</span> <span class=\"n\">all_lookups</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">()</span>\n        <span class=\"k\">if</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span> <span class=\"ow\">in</span> <span class=\"n\">done_queries</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;&#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; lookup was already seen with a different queryset. &quot;</span>\n                    <span class=\"s2\">&quot;You may need to adjust the ordering of your lookups.&quot;</span>\n                    <span class=\"o\">%</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">prefetch_to</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"k\">continue</span>\n\n        <span class=\"c1\"># Top level, the list of objects to decorate is the result cache</span>\n        <span class=\"c1\"># from the primary QuerySet. It won&#39;t be for deeper levels.</span>\n        <span class=\"n\">obj_list</span> <span class=\"o\">=</span> <span class=\"n\">model_instances</span>\n\n        <span class=\"n\">through_attrs</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">prefetch_through</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"n\">LOOKUP_SEP</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">level</span><span class=\"p\">,</span> <span class=\"n\">through_attr</span> <span class=\"ow\">in</span> <span class=\"nb\">enumerate</span><span class=\"p\">(</span><span class=\"n\">through_attrs</span><span class=\"p\">):</span>\n            <span class=\"c1\"># Prepare main instances</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">obj_list</span><span class=\"p\">:</span>\n                <span class=\"k\">break</span>\n\n            <span class=\"n\">prefetch_to</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">get_current_prefetch_to</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">)</span>\n            <span class=\"k\">if</span> <span class=\"n\">prefetch_to</span> <span class=\"ow\">in</span> <span class=\"n\">done_queries</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Skip any prefetching, and any object preparation</span>\n                <span class=\"n\">obj_list</span> <span class=\"o\">=</span> <span class=\"n\">done_queries</span><span class=\"p\">[</span><span class=\"n\">prefetch_to</span><span class=\"p\">]</span>\n                <span class=\"k\">continue</span>\n\n            <span class=\"c1\"># Prepare objects:</span>\n            <span class=\"n\">good_objects</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n            <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">obj_list</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Since prefetching can re-use instances, it is possible to have</span>\n                <span class=\"c1\"># the same instance multiple times in obj_list, so obj might</span>\n                <span class=\"c1\"># already be prepared.</span>\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_prefetched_objects_cache&quot;</span><span class=\"p\">):</span>\n                    <span class=\"k\">try</span><span class=\"p\">:</span>\n                        <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_prefetched_objects_cache</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n                    <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">AttributeError</span><span class=\"p\">,</span> <span class=\"ne\">TypeError</span><span class=\"p\">):</span>\n                        <span class=\"c1\"># Must be an immutable object from</span>\n                        <span class=\"c1\"># values_list(flat=True), for example (TypeError) or</span>\n                        <span class=\"c1\"># a QuerySet subclass that isn&#39;t returning Model</span>\n                        <span class=\"c1\"># instances (AttributeError), either in Django or a 3rd</span>\n                        <span class=\"c1\"># party. prefetch_related() doesn&#39;t make sense, so quit.</span>\n                        <span class=\"n\">good_objects</span> <span class=\"o\">=</span> <span class=\"kc\">False</span>\n                        <span class=\"k\">break</span>\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">good_objects</span><span class=\"p\">:</span>\n                <span class=\"k\">break</span>\n\n            <span class=\"c1\"># Descend down tree</span>\n\n            <span class=\"c1\"># We assume that objects retrieved are homogeneous (which is the premise</span>\n            <span class=\"c1\"># of prefetch_related), so what applies to first object applies to all.</span>\n            <span class=\"n\">first_obj</span> <span class=\"o\">=</span> <span class=\"n\">obj_list</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n            <span class=\"n\">to_attr</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">get_current_to_attr</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">)[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n            <span class=\"n\">prefetcher</span><span class=\"p\">,</span> <span class=\"n\">descriptor</span><span class=\"p\">,</span> <span class=\"n\">attr_found</span><span class=\"p\">,</span> <span class=\"n\">is_fetched</span> <span class=\"o\">=</span> <span class=\"n\">get_prefetcher</span><span class=\"p\">(</span>\n                <span class=\"n\">first_obj</span><span class=\"p\">,</span> <span class=\"n\">through_attr</span><span class=\"p\">,</span> <span class=\"n\">to_attr</span>\n            <span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">attr_found</span><span class=\"p\">:</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">AttributeError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;Cannot find &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; on </span><span class=\"si\">%s</span><span class=\"s2\"> object, &#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; is an invalid &quot;</span>\n                    <span class=\"s2\">&quot;parameter to prefetch_related()&quot;</span>\n                    <span class=\"o\">%</span> <span class=\"p\">(</span>\n                        <span class=\"n\">through_attr</span><span class=\"p\">,</span>\n                        <span class=\"n\">first_obj</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">,</span>\n                        <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">prefetch_through</span><span class=\"p\">,</span>\n                    <span class=\"p\">)</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">level</span> <span class=\"o\">==</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">through_attrs</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"mi\">1</span> <span class=\"ow\">and</span> <span class=\"n\">prefetcher</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Last one, this *must* resolve to something that supports</span>\n                <span class=\"c1\"># prefetching, otherwise there is no point adding it and the</span>\n                <span class=\"c1\"># developer asking for it has made a mistake.</span>\n                <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span>\n                    <span class=\"s2\">&quot;&#39;</span><span class=\"si\">%s</span><span class=\"s2\">&#39; does not resolve to an item that supports &quot;</span>\n                    <span class=\"s2\">&quot;prefetching - this is an invalid parameter to &quot;</span>\n                    <span class=\"s2\">&quot;prefetch_related().&quot;</span> <span class=\"o\">%</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">prefetch_through</span>\n                <span class=\"p\">)</span>\n\n            <span class=\"n\">obj_to_fetch</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n            <span class=\"k\">if</span> <span class=\"n\">prefetcher</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                <span class=\"n\">obj_to_fetch</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"n\">obj</span> <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">obj_list</span> <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">is_fetched</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)]</span>\n\n            <span class=\"k\">if</span> <span class=\"n\">obj_to_fetch</span><span class=\"p\">:</span>\n                <span class=\"n\">obj_list</span><span class=\"p\">,</span> <span class=\"n\">additional_lookups</span> <span class=\"o\">=</span> <span class=\"n\">prefetch_one_level</span><span class=\"p\">(</span>\n                    <span class=\"n\">obj_to_fetch</span><span class=\"p\">,</span>\n                    <span class=\"n\">prefetcher</span><span class=\"p\">,</span>\n                    <span class=\"n\">lookup</span><span class=\"p\">,</span>\n                    <span class=\"n\">level</span><span class=\"p\">,</span>\n                <span class=\"p\">)</span>\n                <span class=\"c1\"># We need to ensure we don&#39;t keep adding lookups from the</span>\n                <span class=\"c1\"># same relationships to stop infinite recursion. So, if we</span>\n                <span class=\"c1\"># are already on an automatically added lookup, don&#39;t add</span>\n                <span class=\"c1\"># the new lookups from relationships we&#39;ve seen already.</span>\n                <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"p\">(</span>\n                    <span class=\"n\">prefetch_to</span> <span class=\"ow\">in</span> <span class=\"n\">done_queries</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">lookup</span> <span class=\"ow\">in</span> <span class=\"n\">auto_lookups</span>\n                    <span class=\"ow\">and</span> <span class=\"n\">descriptor</span> <span class=\"ow\">in</span> <span class=\"n\">followed_descriptors</span>\n                <span class=\"p\">):</span>\n                    <span class=\"n\">done_queries</span><span class=\"p\">[</span><span class=\"n\">prefetch_to</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">obj_list</span>\n                    <span class=\"n\">new_lookups</span> <span class=\"o\">=</span> <span class=\"n\">normalize_prefetch_lookups</span><span class=\"p\">(</span>\n                        <span class=\"nb\">reversed</span><span class=\"p\">(</span><span class=\"n\">additional_lookups</span><span class=\"p\">),</span> <span class=\"n\">prefetch_to</span>\n                    <span class=\"p\">)</span>\n                    <span class=\"n\">auto_lookups</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">new_lookups</span><span class=\"p\">)</span>\n                    <span class=\"n\">all_lookups</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">new_lookups</span><span class=\"p\">)</span>\n                <span class=\"n\">followed_descriptors</span><span class=\"o\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">descriptor</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"c1\"># Either a singly related object that has already been fetched</span>\n                <span class=\"c1\"># (e.g. via select_related), or hopefully some other property</span>\n                <span class=\"c1\"># that doesn&#39;t support prefetching but needs to be traversed.</span>\n\n                <span class=\"c1\"># We replace the current list of parent objects with the list</span>\n                <span class=\"c1\"># of related objects, filtering out empty or missing values so</span>\n                <span class=\"c1\"># that we can continue with nullable or reverse relations.</span>\n                <span class=\"n\">new_obj_list</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n                <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">obj_list</span><span class=\"p\">:</span>\n                    <span class=\"k\">if</span> <span class=\"n\">through_attr</span> <span class=\"ow\">in</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_prefetched_objects_cache&quot;</span><span class=\"p\">,</span> <span class=\"p\">()):</span>\n                        <span class=\"c1\"># If related objects have been prefetched, use the</span>\n                        <span class=\"c1\"># cache rather than the object&#39;s through_attr.</span>\n                        <span class=\"n\">new_obj</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_prefetched_objects_cache</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">through_attr</span><span class=\"p\">))</span>\n                    <span class=\"k\">else</span><span class=\"p\">:</span>\n                        <span class=\"k\">try</span><span class=\"p\">:</span>\n                            <span class=\"n\">new_obj</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">through_attr</span><span class=\"p\">)</span>\n                        <span class=\"k\">except</span> <span class=\"n\">exceptions</span><span class=\"o\">.</span><span class=\"n\">ObjectDoesNotExist</span><span class=\"p\">:</span>\n                            <span class=\"k\">continue</span>\n                    <span class=\"k\">if</span> <span class=\"n\">new_obj</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                        <span class=\"k\">continue</span>\n                    <span class=\"c1\"># We special-case `list` rather than something more generic</span>\n                    <span class=\"c1\"># like `Iterable` because we don&#39;t want to accidentally match</span>\n                    <span class=\"c1\"># user models that define __iter__.</span>\n                    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">new_obj</span><span class=\"p\">,</span> <span class=\"nb\">list</span><span class=\"p\">):</span>\n                        <span class=\"n\">new_obj_list</span><span class=\"o\">.</span><span class=\"n\">extend</span><span class=\"p\">(</span><span class=\"n\">new_obj</span><span class=\"p\">)</span>\n                    <span class=\"k\">else</span><span class=\"p\">:</span>\n                        <span class=\"n\">new_obj_list</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">new_obj</span><span class=\"p\">)</span>\n                <span class=\"n\">obj_list</span> <span class=\"o\">=</span> <span class=\"n\">new_obj_list</span></div>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">get_prefetcher</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">through_attr</span><span class=\"p\">,</span> <span class=\"n\">to_attr</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    For the attribute &#39;through_attr&#39; on the given instance, find</span>\n<span class=\"sd\">    an object that has a get_prefetch_queryset().</span>\n<span class=\"sd\">    Return a 4 tuple containing:</span>\n<span class=\"sd\">    (the object with get_prefetch_queryset (or None),</span>\n<span class=\"sd\">     the descriptor object representing this relationship (or None),</span>\n<span class=\"sd\">     a boolean that is False if the attribute was not found at all,</span>\n<span class=\"sd\">     a function that takes an instance and returns a boolean that is True if</span>\n<span class=\"sd\">     the attribute has already been fetched for that instance)</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">has_to_attr_attribute</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">to_attr</span><span class=\"p\">)</span>\n\n    <span class=\"n\">prefetcher</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n    <span class=\"n\">is_fetched</span> <span class=\"o\">=</span> <span class=\"n\">has_to_attr_attribute</span>\n\n    <span class=\"c1\"># For singly related objects, we have to avoid getting the attribute</span>\n    <span class=\"c1\"># from the object, as this will trigger the query. So we first try</span>\n    <span class=\"c1\"># on the class, in order to get the descriptor object.</span>\n    <span class=\"n\">rel_obj_descriptor</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span> <span class=\"n\">through_attr</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">rel_obj_descriptor</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n        <span class=\"n\">attr_found</span> <span class=\"o\">=</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">through_attr</span><span class=\"p\">)</span>\n    <span class=\"k\">else</span><span class=\"p\">:</span>\n        <span class=\"n\">attr_found</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n        <span class=\"k\">if</span> <span class=\"n\">rel_obj_descriptor</span><span class=\"p\">:</span>\n            <span class=\"c1\"># singly related object, descriptor object has the</span>\n            <span class=\"c1\"># get_prefetch_queryset() method.</span>\n            <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">rel_obj_descriptor</span><span class=\"p\">,</span> <span class=\"s2\">&quot;get_prefetch_queryset&quot;</span><span class=\"p\">):</span>\n                <span class=\"n\">prefetcher</span> <span class=\"o\">=</span> <span class=\"n\">rel_obj_descriptor</span>\n                <span class=\"n\">is_fetched</span> <span class=\"o\">=</span> <span class=\"n\">rel_obj_descriptor</span><span class=\"o\">.</span><span class=\"n\">is_cached</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"c1\"># descriptor doesn&#39;t support prefetching, so we go ahead and get</span>\n                <span class=\"c1\"># the attribute on the instance rather than the class to</span>\n                <span class=\"c1\"># support many related managers</span>\n                <span class=\"n\">rel_obj</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">,</span> <span class=\"n\">through_attr</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"nb\">hasattr</span><span class=\"p\">(</span><span class=\"n\">rel_obj</span><span class=\"p\">,</span> <span class=\"s2\">&quot;get_prefetch_queryset&quot;</span><span class=\"p\">):</span>\n                    <span class=\"n\">prefetcher</span> <span class=\"o\">=</span> <span class=\"n\">rel_obj</span>\n                <span class=\"k\">if</span> <span class=\"n\">through_attr</span> <span class=\"o\">!=</span> <span class=\"n\">to_attr</span><span class=\"p\">:</span>\n                    <span class=\"c1\"># Special case cached_property instances because hasattr</span>\n                    <span class=\"c1\"># triggers attribute computation and assignment.</span>\n                    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span>\n                        <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"vm\">__class__</span><span class=\"p\">,</span> <span class=\"n\">to_attr</span><span class=\"p\">,</span> <span class=\"kc\">None</span><span class=\"p\">),</span> <span class=\"n\">cached_property</span>\n                    <span class=\"p\">):</span>\n\n                        <span class=\"k\">def</span> <span class=\"nf\">has_cached_property</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">):</span>\n                            <span class=\"k\">return</span> <span class=\"n\">to_attr</span> <span class=\"ow\">in</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"vm\">__dict__</span>\n\n                        <span class=\"n\">is_fetched</span> <span class=\"o\">=</span> <span class=\"n\">has_cached_property</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n\n                    <span class=\"k\">def</span> <span class=\"nf\">in_prefetched_cache</span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"p\">):</span>\n                        <span class=\"k\">return</span> <span class=\"n\">through_attr</span> <span class=\"ow\">in</span> <span class=\"n\">instance</span><span class=\"o\">.</span><span class=\"n\">_prefetched_objects_cache</span>\n\n                    <span class=\"n\">is_fetched</span> <span class=\"o\">=</span> <span class=\"n\">in_prefetched_cache</span>\n    <span class=\"k\">return</span> <span class=\"n\">prefetcher</span><span class=\"p\">,</span> <span class=\"n\">rel_obj_descriptor</span><span class=\"p\">,</span> <span class=\"n\">attr_found</span><span class=\"p\">,</span> <span class=\"n\">is_fetched</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">prefetch_one_level</span><span class=\"p\">(</span><span class=\"n\">instances</span><span class=\"p\">,</span> <span class=\"n\">prefetcher</span><span class=\"p\">,</span> <span class=\"n\">lookup</span><span class=\"p\">,</span> <span class=\"n\">level</span><span class=\"p\">):</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    Helper function for prefetch_related_objects().</span>\n\n<span class=\"sd\">    Run prefetches on all instances using the prefetcher object,</span>\n<span class=\"sd\">    assigning results to relevant caches in instance.</span>\n\n<span class=\"sd\">    Return the prefetched objects along with any additional prefetches that</span>\n<span class=\"sd\">    must be done due to prefetch_related lookups found from default managers.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n    <span class=\"c1\"># prefetcher must have a method get_prefetch_queryset() which takes a list</span>\n    <span class=\"c1\"># of instances, and returns a tuple:</span>\n\n    <span class=\"c1\"># (queryset of instances of self.model that are related to passed in instances,</span>\n    <span class=\"c1\">#  callable that gets value to be matched for returned instances,</span>\n    <span class=\"c1\">#  callable that gets value to be matched for passed in instances,</span>\n    <span class=\"c1\">#  boolean that is True for singly related objects,</span>\n    <span class=\"c1\">#  cache or field name to assign to,</span>\n    <span class=\"c1\">#  boolean that is True when the previous argument is a cache name vs a field name).</span>\n\n    <span class=\"c1\"># The &#39;values to be matched&#39; must be hashable as they will be used</span>\n    <span class=\"c1\"># in a dictionary.</span>\n\n    <span class=\"p\">(</span>\n        <span class=\"n\">rel_qs</span><span class=\"p\">,</span>\n        <span class=\"n\">rel_obj_attr</span><span class=\"p\">,</span>\n        <span class=\"n\">instance_attr</span><span class=\"p\">,</span>\n        <span class=\"n\">single</span><span class=\"p\">,</span>\n        <span class=\"n\">cache_name</span><span class=\"p\">,</span>\n        <span class=\"n\">is_descriptor</span><span class=\"p\">,</span>\n    <span class=\"p\">)</span> <span class=\"o\">=</span> <span class=\"n\">prefetcher</span><span class=\"o\">.</span><span class=\"n\">get_prefetch_queryset</span><span class=\"p\">(</span><span class=\"n\">instances</span><span class=\"p\">,</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">get_current_queryset</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">))</span>\n    <span class=\"c1\"># We have to handle the possibility that the QuerySet we just got back</span>\n    <span class=\"c1\"># contains some prefetch_related lookups. We don&#39;t want to trigger the</span>\n    <span class=\"c1\"># prefetch_related functionality by evaluating the query. Rather, we need</span>\n    <span class=\"c1\"># to merge in the prefetch_related lookups.</span>\n    <span class=\"c1\"># Copy the lookups in case it is a Prefetch object which could be reused</span>\n    <span class=\"c1\"># later (happens in nested prefetch_related).</span>\n    <span class=\"n\">additional_lookups</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n        <span class=\"n\">copy</span><span class=\"o\">.</span><span class=\"n\">copy</span><span class=\"p\">(</span><span class=\"n\">additional_lookup</span><span class=\"p\">)</span>\n        <span class=\"k\">for</span> <span class=\"n\">additional_lookup</span> <span class=\"ow\">in</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">rel_qs</span><span class=\"p\">,</span> <span class=\"s2\">&quot;_prefetch_related_lookups&quot;</span><span class=\"p\">,</span> <span class=\"p\">())</span>\n    <span class=\"p\">]</span>\n    <span class=\"k\">if</span> <span class=\"n\">additional_lookups</span><span class=\"p\">:</span>\n        <span class=\"c1\"># Don&#39;t need to clone because the manager should have given us a fresh</span>\n        <span class=\"c1\"># instance, so we access an internal instead of using public interface</span>\n        <span class=\"c1\"># for performance reasons.</span>\n        <span class=\"n\">rel_qs</span><span class=\"o\">.</span><span class=\"n\">_prefetch_related_lookups</span> <span class=\"o\">=</span> <span class=\"p\">()</span>\n\n    <span class=\"n\">all_related_objects</span> <span class=\"o\">=</span> <span class=\"nb\">list</span><span class=\"p\">(</span><span class=\"n\">rel_qs</span><span class=\"p\">)</span>\n\n    <span class=\"n\">rel_obj_cache</span> <span class=\"o\">=</span> <span class=\"p\">{}</span>\n    <span class=\"k\">for</span> <span class=\"n\">rel_obj</span> <span class=\"ow\">in</span> <span class=\"n\">all_related_objects</span><span class=\"p\">:</span>\n        <span class=\"n\">rel_attr_val</span> <span class=\"o\">=</span> <span class=\"n\">rel_obj_attr</span><span class=\"p\">(</span><span class=\"n\">rel_obj</span><span class=\"p\">)</span>\n        <span class=\"n\">rel_obj_cache</span><span class=\"o\">.</span><span class=\"n\">setdefault</span><span class=\"p\">(</span><span class=\"n\">rel_attr_val</span><span class=\"p\">,</span> <span class=\"p\">[])</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">rel_obj</span><span class=\"p\">)</span>\n\n    <span class=\"n\">to_attr</span><span class=\"p\">,</span> <span class=\"n\">as_attr</span> <span class=\"o\">=</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">get_current_to_attr</span><span class=\"p\">(</span><span class=\"n\">level</span><span class=\"p\">)</span>\n    <span class=\"c1\"># Make sure `to_attr` does not conflict with a field.</span>\n    <span class=\"k\">if</span> <span class=\"n\">as_attr</span> <span class=\"ow\">and</span> <span class=\"n\">instances</span><span class=\"p\">:</span>\n        <span class=\"c1\"># We assume that objects retrieved are homogeneous (which is the premise</span>\n        <span class=\"c1\"># of prefetch_related), so what applies to first object applies to all.</span>\n        <span class=\"n\">model</span> <span class=\"o\">=</span> <span class=\"n\">instances</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"vm\">__class__</span>\n        <span class=\"k\">try</span><span class=\"p\">:</span>\n            <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">get_field</span><span class=\"p\">(</span><span class=\"n\">to_attr</span><span class=\"p\">)</span>\n        <span class=\"k\">except</span> <span class=\"n\">exceptions</span><span class=\"o\">.</span><span class=\"n\">FieldDoesNotExist</span><span class=\"p\">:</span>\n            <span class=\"k\">pass</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">msg</span> <span class=\"o\">=</span> <span class=\"s2\">&quot;to_attr=</span><span class=\"si\">{}</span><span class=\"s2\"> conflicts with a field on the </span><span class=\"si\">{}</span><span class=\"s2\"> model.&quot;</span>\n            <span class=\"k\">raise</span> <span class=\"ne\">ValueError</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">to_attr</span><span class=\"p\">,</span> <span class=\"n\">model</span><span class=\"o\">.</span><span class=\"vm\">__name__</span><span class=\"p\">))</span>\n\n    <span class=\"c1\"># Whether or not we&#39;re prefetching the last part of the lookup.</span>\n    <span class=\"n\">leaf</span> <span class=\"o\">=</span> <span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">prefetch_through</span><span class=\"o\">.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"n\">LOOKUP_SEP</span><span class=\"p\">))</span> <span class=\"o\">-</span> <span class=\"mi\">1</span> <span class=\"o\">==</span> <span class=\"n\">level</span>\n\n    <span class=\"k\">for</span> <span class=\"n\">obj</span> <span class=\"ow\">in</span> <span class=\"n\">instances</span><span class=\"p\">:</span>\n        <span class=\"n\">instance_attr_val</span> <span class=\"o\">=</span> <span class=\"n\">instance_attr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">)</span>\n        <span class=\"n\">vals</span> <span class=\"o\">=</span> <span class=\"n\">rel_obj_cache</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">instance_attr_val</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n\n        <span class=\"k\">if</span> <span class=\"n\">single</span><span class=\"p\">:</span>\n            <span class=\"n\">val</span> <span class=\"o\">=</span> <span class=\"n\">vals</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span> <span class=\"k\">if</span> <span class=\"n\">vals</span> <span class=\"k\">else</span> <span class=\"kc\">None</span>\n            <span class=\"k\">if</span> <span class=\"n\">as_attr</span><span class=\"p\">:</span>\n                <span class=\"c1\"># A to_attr has been given for the prefetch.</span>\n                <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">to_attr</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">)</span>\n            <span class=\"k\">elif</span> <span class=\"n\">is_descriptor</span><span class=\"p\">:</span>\n                <span class=\"c1\"># cache_name points to a field name in obj.</span>\n                <span class=\"c1\"># This field is a descriptor for a related object.</span>\n                <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">cache_name</span><span class=\"p\">,</span> <span class=\"n\">val</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"c1\"># No to_attr has been given for this prefetch operation and the</span>\n                <span class=\"c1\"># cache_name does not point to a descriptor. Store the value of</span>\n                <span class=\"c1\"># the field in the object&#39;s field cache.</span>\n                <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_state</span><span class=\"o\">.</span><span class=\"n\">fields_cache</span><span class=\"p\">[</span><span class=\"n\">cache_name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">val</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"k\">if</span> <span class=\"n\">as_attr</span><span class=\"p\">:</span>\n                <span class=\"nb\">setattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">to_attr</span><span class=\"p\">,</span> <span class=\"n\">vals</span><span class=\"p\">)</span>\n            <span class=\"k\">else</span><span class=\"p\">:</span>\n                <span class=\"n\">manager</span> <span class=\"o\">=</span> <span class=\"nb\">getattr</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">to_attr</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">leaf</span> <span class=\"ow\">and</span> <span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">queryset</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n                    <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"n\">_apply_rel_filters</span><span class=\"p\">(</span><span class=\"n\">lookup</span><span class=\"o\">.</span><span class=\"n\">queryset</span><span class=\"p\">)</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">qs</span> <span class=\"o\">=</span> <span class=\"n\">manager</span><span class=\"o\">.</span><span class=\"n\">get_queryset</span><span class=\"p\">()</span>\n                <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">_result_cache</span> <span class=\"o\">=</span> <span class=\"n\">vals</span>\n                <span class=\"c1\"># We don&#39;t want the individual qs doing prefetch_related now,</span>\n                <span class=\"c1\"># since we have merged this into the current work.</span>\n                <span class=\"n\">qs</span><span class=\"o\">.</span><span class=\"n\">_prefetch_done</span> <span class=\"o\">=</span> <span class=\"kc\">True</span>\n                <span class=\"n\">obj</span><span class=\"o\">.</span><span class=\"n\">_prefetched_objects_cache</span><span class=\"p\">[</span><span class=\"n\">cache_name</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"n\">qs</span>\n    <span class=\"k\">return</span> <span class=\"n\">all_related_objects</span><span class=\"p\">,</span> <span class=\"n\">additional_lookups</span>\n\n\n<span class=\"k\">class</span> <span class=\"nc\">RelatedPopulator</span><span class=\"p\">:</span>\n    <span class=\"sd\">&quot;&quot;&quot;</span>\n<span class=\"sd\">    RelatedPopulator is used for select_related() object instantiation.</span>\n\n<span class=\"sd\">    The idea is that each select_related() model will be populated by a</span>\n<span class=\"sd\">    different RelatedPopulator instance. The RelatedPopulator instances get</span>\n<span class=\"sd\">    klass_info and select (computed in SQLCompiler) plus the used db as</span>\n<span class=\"sd\">    input for initialization. That data is used to compute which columns</span>\n<span class=\"sd\">    to use, how to instantiate the model, and how to populate the links</span>\n<span class=\"sd\">    between the objects.</span>\n\n<span class=\"sd\">    The actual creation of the objects is done in populate() method. This</span>\n<span class=\"sd\">    method gets row and from_obj as input and populates the select_related()</span>\n<span class=\"sd\">    model instance.</span>\n<span class=\"sd\">    &quot;&quot;&quot;</span>\n\n    <span class=\"k\">def</span> <span class=\"fm\">__init__</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">klass_info</span><span class=\"p\">,</span> <span class=\"n\">select</span><span class=\"p\">,</span> <span class=\"n\">db</span><span class=\"p\">):</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span> <span class=\"o\">=</span> <span class=\"n\">db</span>\n        <span class=\"c1\"># Pre-compute needed attributes. The attributes are:</span>\n        <span class=\"c1\">#  - model_cls: the possibly deferred model class to instantiate</span>\n        <span class=\"c1\">#  - either:</span>\n        <span class=\"c1\">#    - cols_start, cols_end: usually the columns in the row are</span>\n        <span class=\"c1\">#      in the same order model_cls.__init__ expects them, so we</span>\n        <span class=\"c1\">#      can instantiate by model_cls(*row[cols_start:cols_end])</span>\n        <span class=\"c1\">#    - reorder_for_init: When select_related descends to a child</span>\n        <span class=\"c1\">#      class, then we want to reuse the already selected parent</span>\n        <span class=\"c1\">#      data. However, in this case the parent data isn&#39;t necessarily</span>\n        <span class=\"c1\">#      in the same order that Model.__init__ expects it to be, so</span>\n        <span class=\"c1\">#      we have to reorder the parent data. The reorder_for_init</span>\n        <span class=\"c1\">#      attribute contains a function used to reorder the field data</span>\n        <span class=\"c1\">#      in the order __init__ expects it.</span>\n        <span class=\"c1\">#  - pk_idx: the index of the primary key field in the reordered</span>\n        <span class=\"c1\">#    model data. Used to check if a related object exists at all.</span>\n        <span class=\"c1\">#  - init_list: the field attnames fetched from the database. For</span>\n        <span class=\"c1\">#    deferred models this isn&#39;t the same as all attnames of the</span>\n        <span class=\"c1\">#    model&#39;s fields.</span>\n        <span class=\"c1\">#  - related_populators: a list of RelatedPopulator instances if</span>\n        <span class=\"c1\">#    select_related() descends to related models from this model.</span>\n        <span class=\"c1\">#  - local_setter, remote_setter: Methods to set cached values on</span>\n        <span class=\"c1\">#    the object being populated and on the remote object. Usually</span>\n        <span class=\"c1\">#    these are Field.set_cached_value() methods.</span>\n        <span class=\"n\">select_fields</span> <span class=\"o\">=</span> <span class=\"n\">klass_info</span><span class=\"p\">[</span><span class=\"s2\">&quot;select_fields&quot;</span><span class=\"p\">]</span>\n        <span class=\"n\">from_parent</span> <span class=\"o\">=</span> <span class=\"n\">klass_info</span><span class=\"p\">[</span><span class=\"s2\">&quot;from_parent&quot;</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">from_parent</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cols_start</span> <span class=\"o\">=</span> <span class=\"n\">select_fields</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cols_end</span> <span class=\"o\">=</span> <span class=\"n\">select_fields</span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">]</span> <span class=\"o\">+</span> <span class=\"mi\">1</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">init_list</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"n\">f</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">target</span><span class=\"o\">.</span><span class=\"n\">attname</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">select</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cols_start</span> <span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cols_end</span><span class=\"p\">]</span>\n            <span class=\"p\">]</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reorder_for_init</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">attname_indexes</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n                <span class=\"n\">select</span><span class=\"p\">[</span><span class=\"n\">idx</span><span class=\"p\">][</span><span class=\"mi\">0</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">target</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">:</span> <span class=\"n\">idx</span> <span class=\"k\">for</span> <span class=\"n\">idx</span> <span class=\"ow\">in</span> <span class=\"n\">select_fields</span>\n            <span class=\"p\">}</span>\n            <span class=\"n\">model_init_attnames</span> <span class=\"o\">=</span> <span class=\"p\">(</span>\n                <span class=\"n\">f</span><span class=\"o\">.</span><span class=\"n\">attname</span> <span class=\"k\">for</span> <span class=\"n\">f</span> <span class=\"ow\">in</span> <span class=\"n\">klass_info</span><span class=\"p\">[</span><span class=\"s2\">&quot;model&quot;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">concrete_fields</span>\n            <span class=\"p\">)</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">init_list</span> <span class=\"o\">=</span> <span class=\"p\">[</span>\n                <span class=\"n\">attname</span> <span class=\"k\">for</span> <span class=\"n\">attname</span> <span class=\"ow\">in</span> <span class=\"n\">model_init_attnames</span> <span class=\"k\">if</span> <span class=\"n\">attname</span> <span class=\"ow\">in</span> <span class=\"n\">attname_indexes</span>\n            <span class=\"p\">]</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reorder_for_init</span> <span class=\"o\">=</span> <span class=\"n\">operator</span><span class=\"o\">.</span><span class=\"n\">itemgetter</span><span class=\"p\">(</span>\n                <span class=\"o\">*</span><span class=\"p\">[</span><span class=\"n\">attname_indexes</span><span class=\"p\">[</span><span class=\"n\">attname</span><span class=\"p\">]</span> <span class=\"k\">for</span> <span class=\"n\">attname</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">init_list</span><span class=\"p\">]</span>\n            <span class=\"p\">)</span>\n\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model_cls</span> <span class=\"o\">=</span> <span class=\"n\">klass_info</span><span class=\"p\">[</span><span class=\"s2\">&quot;model&quot;</span><span class=\"p\">]</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">pk_idx</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">init_list</span><span class=\"o\">.</span><span class=\"n\">index</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model_cls</span><span class=\"o\">.</span><span class=\"n\">_meta</span><span class=\"o\">.</span><span class=\"n\">pk</span><span class=\"o\">.</span><span class=\"n\">attname</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">related_populators</span> <span class=\"o\">=</span> <span class=\"n\">get_related_populators</span><span class=\"p\">(</span><span class=\"n\">klass_info</span><span class=\"p\">,</span> <span class=\"n\">select</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">local_setter</span> <span class=\"o\">=</span> <span class=\"n\">klass_info</span><span class=\"p\">[</span><span class=\"s2\">&quot;local_setter&quot;</span><span class=\"p\">]</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_setter</span> <span class=\"o\">=</span> <span class=\"n\">klass_info</span><span class=\"p\">[</span><span class=\"s2\">&quot;remote_setter&quot;</span><span class=\"p\">]</span>\n\n    <span class=\"k\">def</span> <span class=\"nf\">populate</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">,</span> <span class=\"n\">row</span><span class=\"p\">,</span> <span class=\"n\">from_obj</span><span class=\"p\">):</span>\n        <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reorder_for_init</span><span class=\"p\">:</span>\n            <span class=\"n\">obj_data</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">reorder_for_init</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">)</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">obj_data</span> <span class=\"o\">=</span> <span class=\"n\">row</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cols_start</span> <span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">cols_end</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"n\">obj_data</span><span class=\"p\">[</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">pk_idx</span><span class=\"p\">]</span> <span class=\"ow\">is</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"kc\">None</span>\n        <span class=\"k\">else</span><span class=\"p\">:</span>\n            <span class=\"n\">obj</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">model_cls</span><span class=\"o\">.</span><span class=\"n\">from_db</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">db</span><span class=\"p\">,</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">init_list</span><span class=\"p\">,</span> <span class=\"n\">obj_data</span><span class=\"p\">)</span>\n            <span class=\"k\">for</span> <span class=\"n\">rel_iter</span> <span class=\"ow\">in</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">related_populators</span><span class=\"p\">:</span>\n                <span class=\"n\">rel_iter</span><span class=\"o\">.</span><span class=\"n\">populate</span><span class=\"p\">(</span><span class=\"n\">row</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">)</span>\n        <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">local_setter</span><span class=\"p\">(</span><span class=\"n\">from_obj</span><span class=\"p\">,</span> <span class=\"n\">obj</span><span class=\"p\">)</span>\n        <span class=\"k\">if</span> <span class=\"n\">obj</span> <span class=\"ow\">is</span> <span class=\"ow\">not</span> <span class=\"kc\">None</span><span class=\"p\">:</span>\n            <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">remote_setter</span><span class=\"p\">(</span><span class=\"n\">obj</span><span class=\"p\">,</span> <span class=\"n\">from_obj</span><span class=\"p\">)</span>\n\n\n<span class=\"k\">def</span> <span class=\"nf\">get_related_populators</span><span class=\"p\">(</span><span class=\"n\">klass_info</span><span class=\"p\">,</span> <span class=\"n\">select</span><span class=\"p\">,</span> <span class=\"n\">db</span><span class=\"p\">):</span>\n    <span class=\"n\">iterators</span> <span class=\"o\">=</span> <span class=\"p\">[]</span>\n    <span class=\"n\">related_klass_infos</span> <span class=\"o\">=</span> <span class=\"n\">klass_info</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s2\">&quot;related_klass_infos&quot;</span><span class=\"p\">,</span> <span class=\"p\">[])</span>\n    <span class=\"k\">for</span> <span class=\"n\">rel_klass_info</span> <span class=\"ow\">in</span> <span class=\"n\">related_klass_infos</span><span class=\"p\">:</span>\n        <span class=\"n\">rel_cls</span> <span class=\"o\">=</span> <span class=\"n\">RelatedPopulator</span><span class=\"p\">(</span><span class=\"n\">rel_klass_info</span><span class=\"p\">,</span> <span class=\"n\">select</span><span class=\"p\">,</span> <span class=\"n\">db</span><span class=\"p\">)</span>\n        <span class=\"n\">iterators</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">rel_cls</span><span class=\"p\">)</span>\n    <span class=\"k\">return</span> <span class=\"n\">iterators</span>\n</pre></div>", "current_page_name": "_modules/django/db/models/query", "sidebars": ["localtoc.html", "relations.html", "sourcelink.html", "searchbox.html"], "customsidebar": null, "favicon_url": null, "logo_url": null, "alabaster_version": "0.7.13", "include_console_assets": false}