# Generated by Django 5.1.5 on 2025-03-11 10:29
from functools import partial

from django.db import migrations, models
from django.db.models import Case, F, Value, When
from django.db.models.functions import Cast, Concat

import releases.models


def default_artifact(suffix):
    cast_to_char = partial(Cast, output_field=models.CharField())
    return Concat(
        Value("releases/"),
        cast_to_char("major"),
        Value("."),
        cast_to_char("minor"),
        Value("/Django-"),
        F("version"),
        Value(suffix),
    )


def populate_artifacts(apps, schema_editor):
    """Populate tarball, wheel and checksum fields based on historical data.

    The flag "is_active" should always be True for existing releases (defaults to False
    for future releases).

    """
    Release = apps.get_model("releases", "Release")

    Release.objects.filter(date__isnull=False).update(
        is_active=True,
        # releases/{major}.{minor}/Django-{version}.tar.gz
        tarball=Case(
            *(When(version=k, then=Value(v)) for k, v in VERSION_TO_TARBALL.items()),
            default=default_artifact(".tar.gz")
        ),
        # releases/{major}.{minor}/Django-{version}-py3-none-any.whl
        wheel=Case(
            *(When(version=k, then=Value(v)) for k, v in VERSION_TO_WHEEL.items()),
            default=default_artifact("-py3-none-any.whl")
        ),
        # pgp/Django-{version}.checksum.txt
        checksum=Case(
            *(When(version=k, then=Value(v)) for k, v in VERSION_TO_CHECKSUM.items()),
            default=Concat(Value("pgp/Django-"), F("version"), Value(".checksum.txt"))
        ),
    )


class Migration(migrations.Migration):

    dependencies = [
        ("releases", "0001_squashed_0004_make_release_date_nullable"),
    ]

    operations = [
        migrations.AddField(
            model_name="release",
            name="checksum",
            field=models.FileField(
                blank=True,
                storage=releases.models.get_storage,
                upload_to=releases.models.upload_to_checksum,
                verbose_name="Signed checksum as a .asc file",
            ),
        ),
        migrations.AddField(
            model_name="release",
            name="is_active",
            field=models.BooleanField(
                default=False,
                help_text="Set this release as active. A release is considered active only if its date is today or in the past and this flag is enabled. Enable this flag when the release is available on PyPI.",
            ),
        ),
        migrations.AddField(
            model_name="release",
            name="tarball",
            field=models.FileField(
                blank=True,
                storage=releases.models.get_storage,
                upload_to=releases.models.upload_to_artifact,
                verbose_name="Tarball artifact as a .tar.gz file",
            ),
        ),
        migrations.AddField(
            model_name="release",
            name="wheel",
            field=models.FileField(
                blank=True,
                storage=releases.models.get_storage,
                upload_to=releases.models.upload_to_artifact,
                verbose_name="Wheel artifact as a .whl file",
            ),
        ),
        migrations.AlterField(
            model_name="release",
            name="is_lts",
            field=models.BooleanField(
                default=False,
                help_text='Is this a release for an <abbr title="Long Term Support">LTS</abbr> Django version (e.g. 5.2a1, 5.2, 5.2.4)?',
                verbose_name="Long Term Support",
            ),
        ),
        migrations.RunPython(populate_artifacts, migrations.RunPython.noop),
    ]


# These are put at the end to avoid excessive scrolling when trying to read
# the actual migration operations
VERSION_TO_TARBALL = {
    "1.0-alpha-2": "releases/1.0/Django-1.0-alpha_2.tar.gz",
    "1.0-beta-1": "releases/1.0/Django-1.0-beta_1.tar.gz",
    "1.0-beta-2": "releases/1.0/Django-1.0-beta_2.tar.gz",
    "1.0.1": "releases/1.0.1/Django-1.0.1-final.tar.gz",
    "1.0.1-beta-1": "releases/1.0.1/Django-1.0.1_beta_1.tar.gz",
    "1.0.2": "releases/1.0.2/Django-1.0.2-final.tar.gz",
    "1.0.3": "releases/1.0.3/Django-1.0.3.tar.gz",
    "1.1.1": "releases/1.1.1/Django-1.1.1.tar.gz",
    "1.4-beta-1": "releases/1.4/Django-1.4b1.tar.gz",
    "1.4-rc-1": "releases/1.4/Django-1.4c1.tar.gz",
    "1.4-rc-2": "releases/1.4/Django-1.4c2.tar.gz",
    "1.7.b4": "releases/1.7/Django-1.7b4.tar.gz",
    "5.2": "",
}
VERSION_TO_WHEEL = {
    "0.90": "",
    "0.91": "",
    "0.91.1": "",
    "0.91.2": "",
    "0.91.3": "",
    "0.95": "",
    "0.95.1": "",
    "0.95.2": "",
    "0.95.3": "",
    "0.95.4": "",
    "0.96": "",
    "0.96.1": "",
    "0.96.2": "",
    "0.96.3": "",
    "0.96.4": "",
    "0.96.5": "",
    "1.0": "",
    "1.0-alpha": "",
    "1.0-alpha-2": "",
    "1.0-beta-1": "",
    "1.0-beta-2": "",
    "1.0-rc_1": "",
    "1.0.1": "",
    "1.0.1-beta-1": "",
    "1.0.2": "",
    "1.0.3": "",
    "1.0.4": "",
    "1.1": "",
    "1.1-alpha-1": "",
    "1.1-beta-1": "",
    "1.1-rc-1": "",
    "1.1.1": "",
    "1.1.2": "",
    "1.1.3": "",
    "1.1.4": "",
    "1.10": "releases/1.10/Django-1.10-py2.py3-none-any.whl",
    "1.10.1": "releases/1.10/Django-1.10.1-py2.py3-none-any.whl",
    "1.10.2": "releases/1.10/Django-1.10.2-py2.py3-none-any.whl",
    "1.10.3": "releases/1.10/Django-1.10.3-py2.py3-none-any.whl",
    "1.10.4": "releases/1.10/Django-1.10.4-py2.py3-none-any.whl",
    "1.10.5": "releases/1.10/Django-1.10.5-py2.py3-none-any.whl",
    "1.10.6": "releases/1.10/Django-1.10.6-py2.py3-none-any.whl",
    "1.10.7": "releases/1.10/Django-1.10.7-py2.py3-none-any.whl",
    "1.10.8": "releases/1.10/Django-1.10.8-py2.py3-none-any.whl",
    "1.10a1": "releases/1.10/Django-1.10a1-py2.py3-none-any.whl",
    "1.10b1": "releases/1.10/Django-1.10b1-py2.py3-none-any.whl",
    "1.10rc1": "releases/1.10/Django-1.10rc1-py2.py3-none-any.whl",
    "1.11": "releases/1.11/Django-1.11-py2.py3-none-any.whl",
    "1.11.1": "releases/1.11/Django-1.11.1-py2.py3-none-any.whl",
    "1.11.10": "releases/1.11/Django-1.11.10-py2.py3-none-any.whl",
    "1.11.11": "releases/1.11/Django-1.11.11-py2.py3-none-any.whl",
    "1.11.12": "releases/1.11/Django-1.11.12-py2.py3-none-any.whl",
    "1.11.13": "releases/1.11/Django-1.11.13-py2.py3-none-any.whl",
    "1.11.14": "releases/1.11/Django-1.11.14-py2.py3-none-any.whl",
    "1.11.15": "releases/1.11/Django-1.11.15-py2.py3-none-any.whl",
    "1.11.16": "releases/1.11/Django-1.11.16-py2.py3-none-any.whl",
    "1.11.17": "releases/1.11/Django-1.11.17-py2.py3-none-any.whl",
    "1.11.18": "releases/1.11/Django-1.11.18-py2.py3-none-any.whl",
    "1.11.19": "releases/1.11/Django-1.11.19-py2.py3-none-any.whl",
    "1.11.2": "releases/1.11/Django-1.11.2-py2.py3-none-any.whl",
    "1.11.20": "releases/1.11/Django-1.11.20-py2.py3-none-any.whl",
    "1.11.21": "releases/1.11/Django-1.11.21-py2.py3-none-any.whl",
    "1.11.22": "releases/1.11/Django-1.11.22-py2.py3-none-any.whl",
    "1.11.23": "releases/1.11/Django-1.11.23-py2.py3-none-any.whl",
    "1.11.24": "releases/1.11/Django-1.11.24-py2.py3-none-any.whl",
    "1.11.25": "releases/1.11/Django-1.11.25-py2.py3-none-any.whl",
    "1.11.26": "releases/1.11/Django-1.11.26-py2.py3-none-any.whl",
    "1.11.27": "releases/1.11/Django-1.11.27-py2.py3-none-any.whl",
    "1.11.28": "releases/1.11/Django-1.11.28-py2.py3-none-any.whl",
    "1.11.29": "releases/1.11/Django-1.11.29-py2.py3-none-any.whl",
    "1.11.3": "releases/1.11/Django-1.11.3-py2.py3-none-any.whl",
    "1.11.4": "releases/1.11/Django-1.11.4-py2.py3-none-any.whl",
    "1.11.5": "releases/1.11/Django-1.11.5-py2.py3-none-any.whl",
    "1.11.6": "releases/1.11/Django-1.11.6-py2.py3-none-any.whl",
    "1.11.7": "releases/1.11/Django-1.11.7-py2.py3-none-any.whl",
    "1.11.8": "releases/1.11/Django-1.11.8-py2.py3-none-any.whl",
    "1.11.9": "releases/1.11/Django-1.11.9-py2.py3-none-any.whl",
    "1.11a1": "releases/1.11/Django-1.11a1-py2.py3-none-any.whl",
    "1.11b1": "releases/1.11/Django-1.11b1-py2.py3-none-any.whl",
    "1.11rc1": "releases/1.11/Django-1.11rc1-py2.py3-none-any.whl",
    "1.2": "",
    "1.2-alpha-1": "",
    "1.2-beta-1": "",
    "1.2-rc-1": "",
    "1.2.1": "",
    "1.2.2": "",
    "1.2.3": "",
    "1.2.4": "",
    "1.2.5": "",
    "1.2.6": "",
    "1.2.7": "",
    "1.3": "",
    "1.3-alpha-1": "",
    "1.3-beta-1": "",
    "1.3-rc-1": "",
    "1.3.1": "",
    "1.3.2": "",
    "1.3.3": "",
    "1.3.4": "",
    "1.3.5": "",
    "1.3.6": "",
    "1.3.7": "",
    "1.4": "",
    "1.4-alpha-1": "",
    "1.4-beta-1": "",
    "1.4-rc-1": "",
    "1.4-rc-2": "",
    "1.4.1": "",
    "1.4.10": "",
    "1.4.11": "",
    "1.4.12": "",
    "1.4.13": "releases/1.4/Django-1.4.13-py2-none-any.whl",
    "1.4.14": "",
    "1.4.15": "",
    "1.4.16": "",
    "1.4.17": "",
    "1.4.18": "",
    "1.4.19": "",
    "1.4.2": "",
    "1.4.20": "",
    "1.4.21": "",
    "1.4.22": "",
    "1.4.3": "",
    "1.4.4": "",
    "1.4.5": "",
    "1.4.6": "",
    "1.4.7": "",
    "1.4.8": "",
    "1.4.9": "",
    "1.5": "",
    "1.5.1": "",
    "1.5.10": "",
    "1.5.11": "",
    "1.5.12": "releases/1.5/Django-1.5.12-py2.py3-none-any.whl",
    "1.5.2": "releases/1.5/Django-1.5.2-py2.py3-none-any.whl",
    "1.5.3": "",
    "1.5.4": "",
    "1.5.5": "",
    "1.5.6": "",
    "1.5.7": "",
    "1.5.8": "releases/1.5/Django-1.5.8-py2.py3-none-any.whl",
    "1.5.9": "",
    "1.5a1": "",
    "1.5b1": "",
    "1.5b2": "",
    "1.5c1": "",
    "1.5c2": "",
    "1.6": "releases/1.6/Django-1.6-py2.py3-none-any.whl",
    "1.6.1": "releases/1.6/Django-1.6.1-py2.py3-none-any.whl",
    "1.6.10": "releases/1.6/Django-1.6.10-py2.py3-none-any.whl",
    "1.6.11": "releases/1.6/Django-1.6.11-py2.py3-none-any.whl",
    "1.6.2": "releases/1.6/Django-1.6.2-py2.py3-none-any.whl",
    "1.6.3": "releases/1.6/Django-1.6.3-py2.py3-none-any.whl",
    "1.6.4": "releases/1.6/Django-1.6.4-py2.py3-none-any.whl",
    "1.6.5": "releases/1.6/Django-1.6.5-py2.py3-none-any.whl",
    "1.6.6": "releases/1.6/Django-1.6.6-py2.py3-none-any.whl",
    "1.6.7": "releases/1.6/Django-1.6.7-py2.py3-none-any.whl",
    "1.6.8": "releases/1.6/Django-1.6.8-py2.py3-none-any.whl",
    "1.6.9": "releases/1.6/Django-1.6.9-py2.py3-none-any.whl",
    "1.6a1": "releases/1.6/Django-1.6a1-py27-none-any.whl",
    "1.6b1": "",
    "1.6b2": "releases/1.6/Django-1.6b2-py2.py3-none-any.whl",
    "1.6b3": "",
    "1.6b4": "",
    "1.6c1": "",
    "1.7": "releases/1.7/Django-1.7-py2.py3-none-any.whl",
    "1.7.1": "releases/1.7/Django-1.7.1-py2.py3-none-any.whl",
    "1.7.10": "releases/1.7/Django-1.7.10-py2.py3-none-any.whl",
    "1.7.11": "releases/1.7/Django-1.7.11-py2.py3-none-any.whl",
    "1.7.2": "releases/1.7/Django-1.7.2-py2.py3-none-any.whl",
    "1.7.3": "releases/1.7/Django-1.7.3-py2.py3-none-any.whl",
    "1.7.4": "releases/1.7/Django-1.7.4-py2.py3-none-any.whl",
    "1.7.5": "releases/1.7/Django-1.7.5-py2.py3-none-any.whl",
    "1.7.6": "releases/1.7/Django-1.7.6-py2.py3-none-any.whl",
    "1.7.7": "releases/1.7/Django-1.7.7-py2.py3-none-any.whl",
    "1.7.8": "releases/1.7/Django-1.7.8-py2.py3-none-any.whl",
    "1.7.9": "releases/1.7/Django-1.7.9-py2.py3-none-any.whl",
    "1.7.b4": "releases/1.7/Django-1.7b4-py2.py3-none-any.whl",
    "1.7a1": "releases/1.7/Django-1.7a1-py2.py3-none-any.whl",
    "1.7a2": "releases/1.7/Django-1.7a2-py2.py3-none-any.whl",
    "1.7b1": "releases/1.7/Django-1.7b1-py2.py3-none-any.whl",
    "1.7b2": "releases/1.7/Django-1.7b2-py2.py3-none-any.whl",
    "1.7b3": "releases/1.7/Django-1.7b3-py2.py3-none-any.whl",
    "1.7c1": "",
    "1.7c2": "",
    "1.7c3": "",
    "1.8": "releases/1.8/Django-1.8-py2.py3-none-any.whl",
    "1.8.1": "releases/1.8/Django-1.8.1-py2.py3-none-any.whl",
    "1.8.10": "releases/1.8/Django-1.8.10-py2.py3-none-any.whl",
    "1.8.11": "releases/1.8/Django-1.8.11-py2.py3-none-any.whl",
    "1.8.12": "releases/1.8/Django-1.8.12-py2.py3-none-any.whl",
    "1.8.13": "releases/1.8/Django-1.8.13-py2.py3-none-any.whl",
    "1.8.14": "releases/1.8/Django-1.8.14-py2.py3-none-any.whl",
    "1.8.15": "releases/1.8/Django-1.8.15-py2.py3-none-any.whl",
    "1.8.16": "releases/1.8/Django-1.8.16-py2.py3-none-any.whl",
    "1.8.17": "releases/1.8/Django-1.8.17-py2.py3-none-any.whl",
    "1.8.18": "releases/1.8/Django-1.8.18-py2.py3-none-any.whl",
    "1.8.19": "releases/1.8/Django-1.8.19-py2.py3-none-any.whl",
    "1.8.2": "releases/1.8/Django-1.8.2-py2.py3-none-any.whl",
    "1.8.3": "releases/1.8/Django-1.8.3-py2.py3-none-any.whl",
    "1.8.4": "releases/1.8/Django-1.8.4-py2.py3-none-any.whl",
    "1.8.5": "releases/1.8/Django-1.8.5-py2.py3-none-any.whl",
    "1.8.6": "releases/1.8/Django-1.8.6-py2.py3-none-any.whl",
    "1.8.7": "releases/1.8/Django-1.8.7-py2.py3-none-any.whl",
    "1.8.8": "releases/1.8/Django-1.8.8-py2.py3-none-any.whl",
    "1.8.9": "releases/1.8/Django-1.8.9-py2.py3-none-any.whl",
    "1.8a1": "releases/1.8/Django-1.8a1-py2.py3-none-any.whl",
    "1.8b1": "releases/1.8/Django-1.8b1-py2.py3-none-any.whl",
    "1.8b2": "releases/1.8/Django-1.8b2-py2.py3-none-any.whl",
    "1.8c1": "releases/1.8/Django-1.8c1-py2.py3-none-any.whl",
    "1.9": "releases/1.9/Django-1.9-py2.py3-none-any.whl",
    "1.9.1": "releases/1.9/Django-1.9.1-py2.py3-none-any.whl",
    "1.9.10": "releases/1.9/Django-1.9.10-py2.py3-none-any.whl",
    "1.9.11": "releases/1.9/Django-1.9.11-py2.py3-none-any.whl",
    "1.9.12": "releases/1.9/Django-1.9.12-py2.py3-none-any.whl",
    "1.9.13": "releases/1.9/Django-1.9.13-py2.py3-none-any.whl",
    "1.9.2": "releases/1.9/Django-1.9.2-py2.py3-none-any.whl",
    "1.9.3": "releases/1.9/Django-1.9.3-py2.py3-none-any.whl",
    "1.9.4": "releases/1.9/Django-1.9.4-py2.py3-none-any.whl",
    "1.9.5": "releases/1.9/Django-1.9.5-py2.py3-none-any.whl",
    "1.9.6": "releases/1.9/Django-1.9.6-py2.py3-none-any.whl",
    "1.9.7": "releases/1.9/Django-1.9.7-py2.py3-none-any.whl",
    "1.9.8": "releases/1.9/Django-1.9.8-py2.py3-none-any.whl",
    "1.9.9": "releases/1.9/Django-1.9.9-py2.py3-none-any.whl",
    "1.9a1": "releases/1.9/Django-1.9a1-py2.py3-none-any.whl",
    "1.9b1": "releases/1.9/Django-1.9b1-py2.py3-none-any.whl",
    "1.9rc1": "releases/1.9/Django-1.9rc1-py2.py3-none-any.whl",
    "1.9rc2": "releases/1.9/Django-1.9rc2-py2.py3-none-any.whl",
    "5.2": "",
}
VERSION_TO_CHECKSUM = {
    "0.90": "",
    "0.91": "",
    "0.91.1": "",
    "0.91.2": "",
    "0.91.3": "",
    "0.95": "",
    "0.95.1": "",
    "0.95.2": "",
    "0.95.3": "",
    "0.95.4": "",
    "0.96": "",
    "0.96.1": "",
    "0.96.2": "",
    "0.96.3": "",
    "1.0-alpha": "",
    "1.0-alpha-2": "",
    "1.0-beta-1": "",
    "1.0-beta-2": "",
    "1.0.1": "pgp/Django-1.0.1-final.checksum.txt",
    "1.0.2": "pgp/Django-1.0.2-final.checksum.txt",
    "1.4-beta-1": "pgp/Django-1.4b1.checksum.txt",
    "1.4-rc-1": "pgp/Django-1.4c1.checksum.txt",
    "1.4-rc-2": "pgp/Django-1.4c2.checksum.txt",
    "1.7.b4": "pgp/Django-1.7b4.checksum.txt",
    "5.2": "",
}
